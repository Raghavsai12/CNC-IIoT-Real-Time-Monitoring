define("MsPortalImpl/Services/SubsCreditCheck",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalFx/Globalization","FxHubs/Internal.Constants","MsPortalImpl/UI/Hubs/UI.NotificationManager"],(function(i,t,e,r,o,n){"use strict";t.DEV=void 0,t.checkRemainingCredit=async function(i,t){const s=[],l=u&&u.remainingCreditEndpoint;if(t.length&&l){const u=[];t.forEach((i=>{i.subscriptionPolicies&&i.subscriptionPolicies.quotaId&&(i.subscriptionPolicies.quotaId.toLowerCase()===o.freeTrialQuotaId||o.validCreditQuotas.includes(i.subscriptionPolicies.quotaId)&&~["active","enabled","pastdue"].indexOf(o.subscriptionStatusMap[(i.state||"").toLowerCase()]))&&u.push(i.subscriptionId)}));const l=u.sort(((i,t)=>i.localeCompare(t))).slice(0,8);if(l.length){const o=MsPortalFx.extendArrayIntoMap({},t,(i=>i.subscriptionId),(i=>i.displayName));await g(l).then((t=>{s.push(...t),t.length<=c&&t.forEach((t=>{const s=r.NumberFormat.create({style:"currency",currency:t.currency,currencyDisplay:"symbol"}).format(t.remaining);let c=e.subRemCredit.format(o[t.subscriptionId],s);const u=MsPortalFx.isFeatureEnabled("enablebillingupgradelink");!u&&t.showUpgradeNotification&&(c+=`<br/><br/><a href='#blade/Microsoft_Azure_Billing/SubscriptionUpgradeBlade/azureSubscriptionId/${t.subscriptionId}/appId/HubsExtensionRemCreditNotification'>${MsPortalFx.encodeHtml(e.subUpgrade)}</a>`);i.get(n.NotificationManager).addSingleNotification({title:e.subRemCreditTitle.format(s),description:{htmlTemplate:c},status:0,linkTo:`#resource/subscriptions/${t.subscriptionId}`,id:"creditsRemaining",...u&&t.showUpgradeNotification&&{actions:{label:e.subUpgrade,id:"creditsRemaining_link",action:`#blade/Microsoft_Azure_Billing/SubscriptionUpgradeBlade/azureSubscriptionId/${t.subscriptionId}/appId/HubsExtensionRemCreditNotification`}}}),a.trace({source:"SubscriptionCreditCheck",action:"CreditsRemainingNotificationShown"})})),f(t.filter((i=>i.showUpgradeNotification)))}),(i=>d(i))).catch((i=>d(i)))}else f([]);return s}},t.getRemainingCredits=g,t.subscriptionsRequiringUpgrade=void 0;var a=MsPortalFx.Base.Diagnostics.Telemetry,s=MsPortalFx.Base.Net2;const c=3,u=MsPortalFx.getEnvironmentValue("links");function l(i){return 0!==i&&"0"!==i&&!i}function d(i){0!==(i?.jqXHR||{}).status&&a.trace({source:"SubscriptionCreditCheck",action:"CheckRemainingCredit",actionModifier:"CriticalQueryFailure",data:{error:MsPortalFx.getLogFriendlyMessage(i)}})}function p(i){if(!i.error)return!0;a.trace({source:"SubscriptionCreditCheck",action:"CheckRemainingCredit",actionModifier:"GracefulErrors",data:{error:MsPortalFx.getLogFriendlyMessage(i.error)}})}function b(i){const{currency:t,error:e,remaining:r,showUpgradeNotification:o,subscriptionId:n,total:s}=i||{};return!(!i||l(t)||l(r)||!n)||(a.trace({source:"SubscriptionCreditCheck",action:"InvalidBillingCreditResponseFormat",data:{currency:!l(t),error:e,remaining:!l(r),showUpgradeNotification:o,subscriptionId:n,total:!l(s)}}),!1)}async function g(i){let t=[];const e=u&&u.remainingCreditEndpoint;if(i.length&&e){const r=e.format({subscriptionIds:i.toString()}),o=await s.ajax({uri:r,type:"GET",contentType:"application/json",setAuthorizationHeader:!0});t=(Array.isArray(o)?o:[]).filter(p).filter(b)}return t}const f=t.subscriptionsRequiringUpgrade=ko.observable([])}));
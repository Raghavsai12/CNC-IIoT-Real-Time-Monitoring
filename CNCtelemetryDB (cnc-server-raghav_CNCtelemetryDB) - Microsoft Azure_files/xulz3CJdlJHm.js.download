define("MsPortalImpl/Commands/FileDownloadUtil",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Hubs/UI.NotificationManager"],(function(t,e,n,o){"use strict";e.Impl=void 0,e.convertDataUriToBlob=f,e.dataUriHandler=function(t,e,n){const o=t.targetFileName()||i.defaultFileName,r=function(t,e,n){const o=f(n,h(t));if(o.errorMessage||!o.blob)return u(t,e,i.dataUriErrorStatusText,400,o.errorMessage),null;return o.blob}(t,e,n);c(e,t),null!==r&&(s(r,o),b(t,"success",200))},e.dismissDialog=c,e.getAjaxOptions=function(t,e,n){const o=h(t),r={uri:e,type:n,dataType:o,headers:m(t),checkVersion:!1,skipDomainValidation:!0};"binary"===o&&(r.processData=!1,r.responseType="arraybuffer");"POST"===n&&t.httpRequestContent&&t.httpRequestContent()&&(r.data=t.httpRequestContent(),r.contentType=t.httpRequestContentType&&t.httpRequestContentType()||"application/json");return r},e.getContentDispostionOrDefaultFileName=p,e.getFilename=d,e.getHttpMethod=function(t){const e=(t.httpMethod&&t.httpMethod()||"GET").toUpperCase();if("GET"!==e&&"POST"!==e)return null;return e},e.notifyError=l,e.onError=u,e.onSuccess=function(t,e,n,o,r){return y.onSuccess(t,e,n,o,r)},e.saveAsDlg=s;var r=MsPortalFx.ViewModels.FileDownload;const a=window,i=n.FileDownloadCommand;function s(t,e){y.saveAsDlg(t,e)}function l(t,e,n){y.notifyError(t,e,n)}function c(t,e){(e.showDownloadProgressDialog&&e.showDownloadProgressDialog()||e.showUriCallbackConfirmationDialog&&e.showUriCallbackConfirmationDialog())&&t.dismissOpenDialog()}function u(t,e,n,o,r){c(e,t),l(t,o,i.downloadErrorDetails.format(t.errorMessage&&t.errorMessage()||i.downloadError,n,o,r))}function d(t,e){return t.targetFileName&&t.targetFileName()?t.targetFileName():p(e)}function p(t){const e=t.getResponseHeader("Content-Disposition");let n=null,o=0;if(e){const t=MsPortalFx.find(e.split(";"),(t=>t.includes("filename")));t&&t.length>0&&(o=t.indexOf("="))>=0&&(n=t.substring(o+1),n&&(n=n.replaceAll('"',"").trim()))}return n||i.defaultFileName}function f(t,e){const n=t.split(",");let o,r,a="text/plain";if(n.length>1&&n[1])if(a=function(t){let e="text/plain";if(t.length>0&&t[0]){const n=t[0].split(":");if(n.length>1&&n[1]){const t=n[1].split(";");t.length>0&&t[0]&&(e=t[0])}}return e}(n),"binary"===e)try{o=atob(n[1]);const t=new Uint8Array(new ArrayBuffer(o.length));for(let e=0;e<o.length;e++)t[e]=o.charCodeAt(e);return{blob:new Blob([t],{type:a})}}catch(t){r=i.dataUriBinaryEncodingError}else try{return o=decodeURIComponent(n[1]),{blob:new Blob([o],{type:a})}}catch(t){r=i.dataUriTextEncodingError}else r=i.dataUriParseError;return{blob:null,errorMessage:r}}function g(t){return t.headers&&t.headers()?MsPortalFx.clone(t.headers()):null}function m(t){const e=t.authorizationToken&&t.authorizationToken();if(e){const n=g(t)||{};return n.Authorization=e,n}return g(t)}function h(t){return 2===(t.downloadType&&t.downloadType())?"binary":"text"}function b(t,e,n,o){const a=new r.Status(e,n,o);t.downloadStatus(a),t.onEnd&&t.onEnd(a)}var y;!function(t){function e(t,e){if(a.navigator.msSaveOrOpenBlob)a.navigator.msSaveOrOpenBlob(t,e);else{const n=(a.webkitURL||a.URL).createObjectURL(t),o=FxImpl.createElement("a");o.style.display="none",o.href=n,o.download=e,document.body.appendChild(o),o.click(),setTimeout((()=>{a.URL.revokeObjectURL(n),$(o).remove()}),2e4)}}t.onSuccess=async function(t,n,o,r,a){const i=new Blob([o],{type:"application/octet-stream"});c(n,t),e(i,d(t,a)),b(t,r,a.status)},t.notifyError=function(t,e,n){b(t,"error",e,n),o.getNotificationManager().addSingleNotification({title:i.downloadCommandError,description:n,status:2})},t.saveAsDlg=e}(y||(e.Impl=y={}))}));
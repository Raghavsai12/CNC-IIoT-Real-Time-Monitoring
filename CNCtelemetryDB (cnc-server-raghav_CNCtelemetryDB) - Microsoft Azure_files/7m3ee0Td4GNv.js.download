define("MsPortalImpl/Services/GlobalSearchProviders/SearchProviderUtils",["require","exports","Fx/Controls/Pill","Fx/ResourceManagement","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Resources/ImplScriptResources"],(function(e,s,t,r,o,a){"use strict";s.createPill=function(e,s,r){return t.create(s,{getKeyText:()=>e,getValueText:e=>e,getOperatorText:()=>" ",value:"",showRemoveButton:!1,createEditor:()=>({onClick:()=>{r(e.toLocaleLowerCase(),!1)}})})},s.getSearchDisplayResultCount=function(){return MsPortalFx.isFeatureEnabled("globalsearchonecolumn")?4:8},s.getToolTip=function(e,s,t,i,n,c){const u=t.get(o.AssetTypeService);if(0===(s=s||r.ArmId.parse(e,!0)).kind)return"";const l=[],p=!i&&c?.get(s.subscription);n&&l.push({name:n,type:a.Search.name});(i||p)&&l.push({name:(i||p).uniqueDisplayName||s.subscription,type:a.Search.subscriptionsType});s.resourceGroup&&l.push({name:s.resourceGroup,type:a.Search.resourceGroupType});const d=r.ArmId.getResourceNames(s),m=r.ArmId.getResourceTypes(s);if(d.length){let t=s.provider;const o=r.ArmId.parse(e);let a=o.provider;const i=r.ArmId.getResourceTypes(o);d.forEach(((e,s)=>{t+="/"+m[s],a+="/"+i[s];const r=u.getAssetTypeByResourceType(t)||u.getAssetTypeByResourceType(a);l.push({name:e,type:r?r.compositeDisplayName.singular:m[s]})}))}const h=l.pop();return"{0}\n{1}\n\n{2}".format(h.name,h.type,l.map((e=>e.type+": "+e.name)).reverse().join("\n"))},s.resetCategoryState=function(e){e.isLoading(!1),e.results([]),e.totalResultsCount(0),e.showSeeMore(!1),e.moreResultsLinkText("")}})),
define("MsPortalImpl/Services/GlobalSearchProviders/ResourceAndResourceGroupsProvider",["require","exports","Fx/DependencyInjection","Fx/ResourceManagement","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/Resources/ImplScriptResources","FxHubs/ArtHelpers/ArtApis","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.Subscriptions","FxHubs/ArtHelpers/KustoQueryGenerator","FxHubs/ResourceManagement","MsPortalImpl/Services/Services.Util","FxHubs/Helpers/AssetHelpers","MsPortalImpl/Services/Services.BrowserSettings","MsPortalImpl/Services/GlobalSearchProviders/SearchProviderUtils","Fx","MsPortalImpl/Services/Services.SearchState"],(function(e,s,t,r,o,a,i,n,c,u,l,p,d,m,h,S,y){"use strict";s.ResourceAndResourceGroupsProvider=s.DEV=void 0,s.getSubscriptionDeepLink=D,s.viewSubscriptionLinkClassName=s.showResourcesAndResourceGroups=s.searchSettings=void 0;var g=S,R=MsPortalFx.Base,T=R.Diagnostics.Telemetry,f=R.Images.Polychromatic,b=(MsPortalFx.Extension.BrowseType,MsPortalFx.Base.Constants),P=b.AssetNames;const I=R.Diagnostics.createLog(e),v=/\d+\.\d+\.\d+.\d+/,C='extend PropsString=tostring(properties)| where countof(PropsString, @"\\d+\\.\\d+\\.\\d+\\.\\d+", "regex") > 0 | where PropsString contains \'{0}\'',A='where name contains {0} or tags["hidden-title"] contains {0}',x="extend matchscore = name startswith {0} | extend normalizedName = tolower(tostring(name)) | sort by matchscore desc, normalizedName asc | take {1}",M=/^[a-f0-9]{8}-(?:[a-f0-9]{4}-){3}[a-f0-9]{12}$/i,w=s.viewSubscriptionLinkClassName="ext-search-cross-tenant-subscription-link",G=FxImpl.lowerCaseStringMap(),N=".",_=s.searchSettings=window.fx.environment.globalSearch,F=s.showResourcesAndResourceGroups=_&&!_.hideResourcesAndResourceGroups||!_;let k,L=s.ResourceAndResourceGroupsProvider=class{constructor(e){this._diContainer=e,this._resultCount=8,this._ltm=new FxImpl.TriggerableLifetimeManager,this.supportedPills=["Resources","ResourceGroups"],this._assetTypesPromise=this._diContainer.getAsync(n.AssetTypeService).then((e=>(0,n.assetTypesMemo)(e).then((e=>MsPortalFx.extendArrayIntoMap(Object.create(null),e,(e=>e.lowerCaseResourceType),(e=>e.resourceType&&e))))))}dispose(){this._ltm.dispose()}performSearch(e,s){s&&(this._filter=s),this._retryCounter=2,this._criteria=e;const t=V(this._assetTypesPromise,e,this._diContainer);return this.handleResourcesAndResourceGroupsResults(this._diContainer,e,t,this._resultSections,this._resultCount)}createProviderPills(e,s,t){return this._subscribeAndUpdateSeeMoreText=t.subscribeAndUpdateSeeMoreText,this._resourcesPill=(0,h.createPill)(a.Search.resourcesCategory,e,s),k=this._resourcesPill,this._resourceGroupsPill=(0,h.createPill)(a.Search.resourceGroupsCategory,e,s),t?.searchResultsCount&&(this._resultCount=t.searchResultsCount),[this._resourcesPill,this._resourceGroupsPill]}setResultSections(e){this._resultSections=e}handleResourcesAndResourceGroupsResults(e,s,t,r,o){return t.then((t=>E(e,s,t,this._resourcesPill,this._resourceGroupsPill,r,o,this._subscribeAndUpdateSeeMoreText,this._ltm)),(t=>{let a="";if(t&&429===t.httpStatusCode)if(this._retryCounter){const a=60*((0,i.getRetryAfterMinutes)(t)||.5)*1e3;g.delay(a).then((()=>{if(this._criteria===this._filter()){this._retryCounter--,T.trace({source:"Search",action:"RetrySearchResourcesAndResourceGroups"});const t=V(this._assetTypesPromise,this._criteria,this._diContainer);return this.handleResourcesAndResourceGroupsResults(e,s,t,r,o)}}))}else a=FxImpl.Azure.buildSimplifiedError(t.jqXHR||t).message,E(e,s,null,this._resourcesPill,this._resourceGroupsPill,r,o,this._subscribeAndUpdateSeeMoreText,this._ltm,a);else a=FxImpl.Azure.buildSimplifiedError(t.jqXHR||t).message,E(e,s,null,this._resourcesPill,this._resourceGroupsPill,r,o,this._subscribeAndUpdateSeeMoreText,this._ltm,a)}))}};function D(e,s){return`${MsPortalFx.portalUri}#@${e}/asset/Microsoft_Azure_Billing/Subscription/subscriptions/${s}`}function U(e,s){const t=e?e.resultsSet:[],o=e=>{if(0===e.kind)return;const s=" / ",t=G.get(e.subscription);let o=t&&t.displayName||e.subscription;if(e.resourceGroup){o+=s+e.resourceGroup;const t=r.ArmId.getResourceNames(e).slice();t.length>1&&(t.pop(),o+=s+t.join(s))}return o};return t.forEach(((e,s)=>{const a=o(e.armId||r.ArmId.parse(e.id,!0));for(let i=s+1;i<t.length;i++){const s=t[i];e.typeName===s.typeName&&e.displayName===s.displayName&&(e.secondaryName=e.secondaryName||a,s.secondaryName=s.secondaryName||o(s.armId||r.ArmId.parse(s.id,!0)))}})),{totalCount:e?e.totalCount:0,resultsSet:t,warningMessage:s}}function E(e,s,t,r,o,i,n,u,l,d){let m,y;const g=i[0],R=i[1];let f=!1;if(d)g.isLoading(!1),g.showSeeMore(!1),g.error(a.Search.error.format(g.displayName,d)),R.isLoading(!1),R.showSeeMore(!1),R.error(a.Search.error.format(g.displayName,d));else if(g.error(null),R.error(null),F){if(m=t&&t[0],y=t&&t[1],m){const e=m.totalCount>0?m.totalCount:m.resultsSet?.length;f=!e;const s=m.resultsSet.slice(0,n),t=m.resultsSet.slice(n);g.isLoading(!1),g.moreLinkType(1),g.results(s),g.additionalResults(t),g.totalResultsCount(e),g.showSeeMore(e>n),g.warningMessage(m.warningMessage),u(l,g.moreResultsLinkText),r.value(` (${g.totalResultsCount()>=100?"99+":g.totalResultsCount()})`)}else f=!0,(0,h.resetCategoryState)(g);if(f&&(0,S.isFeatureEnabled)("searchcrosstenantsubscription")&&async function(e,s,t,r){const o=T.startTrace({source:"Search",action:"SearchCrossTenantSubscription",name:(0,p.redactSensitiveData)(s)});try{const i=await e.get(c.SubscriptionsUserContext).getSubscriptionTenant(s)||{},n=(await MsPortalFx.Base.Security.getUserInfo()).directoryId;i.id&&i.id!==n&&(t.error(`${a.Search.Error.crossTenantFoundMessage.format(s,i.displayName)} <a class='msportalfx-ext-link ${w}' target="_blank" href="${D(i.id,s)}">${a.Search.viewSubscription}</a>`),t.showErrorMessage(!0),t.isVisible(!0),r.value(""),T.completeTrace(o,{subscriptionTenantId:i.id,signedInTenantId:n}))}catch(e){T.cancelTrace(o,{error:e})}}(e,s,g,r),y){const e=y.resultsSet.slice(0,n),s=y.resultsSet.slice(n),t=y.totalCount>0?y.totalCount:y.resultsSet?.length;R.isLoading(!1),R.moreLinkType(2),R.results(e),R.additionalResults(s),R.totalResultsCount(t),R.showSeeMore(t>n),R.warningMessage(m.warningMessage),u(l,R.moreResultsLinkText),o.value(` (${R.totalResultsCount()>=100?"99+":R.totalResultsCount()})`)}else(0,h.resetCategoryState)(R)}}function z(e,s,t){const o=T.start({source:"Search",action:"searchSubscriptions"});return t.get(c.SubscriptionsUserContext).getSubscriptionSearchResults(s).then((s=>{const a=(s.subscriptions||[]).map((e=>({displayName:e.displayName,subName:e.subscriptionId,type:"Subscription",data:e,armId:r.ArmId.parse("/subscriptions/"+e.subscriptionId,!0)})));return T.completeTrace(o,{subscriptions:a.length}),a.map((s=>Q(e,s,t)))}))}function $(e){const s=["id","name","type","kind","subscriptionId","resourceGroup"],t=new u.KustoQueryGenerator(null,s,null,e.defaultQueryPredicate),r={columnName:["type"],comparisonType:7,value:e.supportedResourceTypes};if(e.defaultQueryPredicate)e.defaultQueryPredicate.includes("hidden-title")&&s.push('tags["hidden-title"]'),t.setProjectedColumns(s),t.setQueryProviders([r]);else{const s=[{columnName:[e.searchColumn],comparisonType:6,value:e.criteria}];e.supportedResourceTypes&&s.push(r),t.setQueryProviders(s)}return!e.defaultQueryPredicate?.includes('where countof(PropsString, @"\\d+\\.\\d+\\.\\d+\\.\\d+", "regex")')&&t.setSuffixPredicates([x.format((0,u.encodeKustoValue)(e.criteria),e.pageSize)]),{subscriptions:e.selectedSubscriptions,query:t.updateQuery(),options:{$top:e.pageSize,includeTotalRecords:!1,dataset:e.dataSetForResourceGroups}}}function B(e){const s=e.data,t=e.totalRecords,o=MsPortalFx.convertArrayToMap(s.columns,(e=>e.name),((e,s)=>s)),a=o.id,i=o.name,n=o.type,c=o.kind,u=o.resourceGroup,l=o["tags_hidden-title"];return{resources:s.rows.map((e=>{const s=e[a],t=r.ArmId.parse(s,!0);return{id:s,name:e[i],kind:e[c],type:e[n],resourceGroup:e[u],hiddenTitleTag:e[l],armId:t}})),totalRecords:t}}function H(e,s){let t,r;if(0===e.detailsType){const a=e.details;r=a?.extensionName+N+a?.assetType,t=a&&(0,o.getAssetDeepLink)(s,a)}else if(1===e.detailsType){const o=s.get(n.AssetTypeService),a=e.details;r=a?.extension+N+a?.assetTypeManifest.name,a&&(t=a&&o.getAssetTypeDeepLink(a))}else t=e.details;return e.deepLink=t,e.origAssetType=r,e}function Q(e,s,t){if(e){if("Resource"===s.type){const r=s.data,o=e[(r.type||"").toLowerCase()];if(!o)return;const a=3===o.browseType,i=r.id,n={id:i,armId:s.armId,displayName:s.displayName,typeName:o.compositeDisplayName.singular,icon:o.icon,resultType:s.type,detailsType:a?3:0,toolTip:(0,h.getToolTip)(i,s.armId,t,null,s.hiddenTitleTag,G),isPreview:o.isPreview,details:a?o.browseLinkUri:{extensionName:o.extensionName,assetType:o.assetType,assetId:i},isVisible:ko.observable()},c={assetTypeInformation:o,extensionName:o.extensionName};return(0,d.checkItemKind)({setIcon:e=>{n.icon=e},setIsPreview:e=>{n.isPreview=e},setAssetTypeDisplayName:e=>{n.typeName=e}},s.armId,r.kind,c),H(n,t)}if("ResourceGroup"===s.type){const e=s.data;return H({id:e.toLowerCase(),armId:s.armId,displayName:s.displayName,resultType:s.type,detailsType:0,typeName:"",icon:f.ResourceGroup(),details:{extensionName:"HubsExtension",assetType:P.ResourceGroups,assetId:e},isVisible:ko.observable()},t)}if("Subscription"===s.type){const r=s.data,o="/subscriptions/"+r.subscriptionId,i=e[b.ResourceTypes.Subscriptions.toLowerCase()];return H({id:o,armId:s.armId,displayName:s.displayName,subName:r.subscriptionId,filteredSubName:!0,resultType:s.type,detailsType:0,typeName:a.Search.subscriptionsType,icon:f.Key(),details:{extensionName:i.extensionName,assetType:P.SubscriptionDetail,assetId:o}},t)}}}function j(e,s,t,r){const o=[],a=[];if(e.resources.forEach((e=>{if(t){const s=e.hiddenTitleTag;let t=e.name;s&&M.test(t)&&(t=s),o.push({displayName:(t||e.id||"").split("/").pop(),type:"Resource",data:e,armId:e.armId,hiddenTitleTag:s})}else{const s=e.id;a.push({displayName:(e.name||e.id||"").split("/").pop(),type:"ResourceGroup",data:s,armId:e.armId})}})),t){const t=o.map((e=>Q(s,e,r)));return{totalCount:e.totalRecords,resultsSet:t.splice(0,30)}}{const t=a.map((e=>Q(s,e,r)));return{totalCount:e.totalRecords,resultsSet:t.splice(0,30)}}}async function V(s,t,r){const o=r.get(y.GlobalSearchStateManager);o.resetSearchState();const n=T.start({source:"Search",action:"StartSearchResourcesAndResourceGroups"}),[d,h]=await Promise.all([s,r.get(c.SubscriptionsUserContext).getInSessionSelectedSubscriptions().then((e=>e()))]);if(!d)return I.error("Failed to perform search with criteria {0} as no assets were returned.".format((0,p.redactSensitiveData)(t))),Promise.resolve(void 0);h.forEach((e=>{G.get(e.subscriptionId)||G.set(e.subscriptionId,e)}));const S=Object.keys(d).reduce(((e,s)=>{const t=d[s];return(0,l.supportsOption)(t.options,2)||e.push(t.resourceType),e}),[]),g=h.map((e=>e.subscriptionId));let f,b;if(g.length){v.test(t)?f=$({selectedSubscriptions:g,supportedResourceTypes:S,criteria:t,searchColumn:null,pageSize:30,defaultQueryPredicate:C.format(t)}):(f=$({selectedSubscriptions:g,supportedResourceTypes:S,criteria:t,searchColumn:"name",pageSize:30,defaultQueryPredicate:A.format((0,u.encodeKustoValue)(t))}),b=$({selectedSubscriptions:g,supportedResourceTypes:[R.Constants.ResourceTypes.ResourceGroups],criteria:t,searchColumn:"name",pageSize:30,dataSetForResourceGroups:"Containers"}));const s=async()=>{const e=T.start({source:"Search",action:"SearchResourcesAndResourceGroupsFromArg"}),[s,o]=await Promise.all([(0,i.getDataFromArt)(f,"Search.Resources"),b&&(0,i.getDataFromArt)(b,"Search.ResourceGroups")]),a=s?.data&&j(B(s),d,!0,r),c=o?.data&&j(B(o),d,!1,r);if(a||c){if(r.get(m.ServiceDependencyState).azureResourceGraphUnavailable(!1),T.completeTrace(e,{resources:a?.resultsSet.length,resourceGroups:c?.resultsSet.length}),a?.resultsSet.length<30){const e=await z(d,t,r);a.resultsSet.push(...e.slice(0,30-a.resultsSet.length)),a.totalCount=a.resultsSet.length}return T.completeTrace(n,{resources:a?.resultsSet.length,resourceGroups:c?.resultsSet.length,dataSource:"ARG"}),[U(a),U(c)]}T.cancelTrace(e,{message:"No results returned from ARG"})},c=async s=>{const i=await MsPortalFx.require(e.normalize("MsPortalImpl/Services/Services.Search")),c=T.start({source:"Search",action:"SearchResourcesAndResourceGroupsFromARM"}),u=(await i.search({criteria:t},r))[0].results,l=u.filter((e=>6===e.armId?.kind)),p=u.filter((e=>4===e.armId?.kind));if(l||p){T.completeTrace(c,{resources:l?.length,resourceGroups:p?.length});const e=l?.map((e=>H(e,r)))||[],i=p?.map((e=>H(e,r)))||[],u={resultsSet:e,totalCount:e.length},m={resultsSet:i,totalCount:i.length};if(l?.length<10){const e=await z(d,t,r);u.resultsSet.push(...e.slice(0,10-l?.length)),u.totalCount=u.resultsSet.length}T.completeTrace(n,{resources:l?.length,resourceGroups:p?.length,dataSource:"ARM"});const h=o.resourcesSearchTimedOut?a.Search.armTimeoutWarningMsg.format(`<a href='#settings/subscriptions'>${a.Search.subscriptionSettings}</a>`):null,S=o.resourceGroupsSearchTimedOut?a.Search.armTimeoutWarningMsg.format(`<a href='#settings/subscriptions'>${a.Search.subscriptionSettings}</a>`):null;return[U(u,s||h),U(m,s||S)]}T.cancelTrace(c,{message:"No results returned from ARM"}),T.cancelTrace(n,{message:"No results returned from ARM"})};if(!MsPortalFx.isFeatureEnabled("artbrowse"))return await c();try{return await s()}catch(e){if(!(e&&(e.httpStatusCode>=500||404===e.httpStatusCode)))throw T.cancelTrace(n,{error:e}),e;return r.get(m.ServiceDependencyState).azureResourceGraphUnavailable(!0),await c(a.Search.argUnavailableWarningMsg)}}return Promise.resolve(void 0)}s.ResourceAndResourceGroupsProvider=L=__decorate([__metadata("fx:diagnostics",[e,"ResourceAndResourceGroupsProvider"]),t.Class(),__metadata("design:paramtypes",[t.Container])],L);s.DEV={getResourcePill:()=>k}}));
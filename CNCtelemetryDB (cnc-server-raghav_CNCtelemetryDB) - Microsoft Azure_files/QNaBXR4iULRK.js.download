define("MsPortalImpl/UI/UI.LinkHandler",["require","exports","Fx/Composition/Selectable","MsPortalImpl/Base/Base.Sanitization","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/Base/Base.KeyboardHelper","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/Base/Base.Selectable2","FxInternal/Utils/Promise","FxInternal"],(function(e,n,r,t,o,a,i,l,s,d,u){"use strict";n.defaultHref=void 0,n.getBladeLinkUriAndHandler=k,n.getCallbackLinkUriAndHandler=m,n.getClickableLinkUriAndHandler=g,n.getLinkTelemetryLogger=h,n.getResourceLinkUriAndHandler=b,n.getUriAndHandler=function(e,n,r,t){if(function(e){return e&&"function"==typeof e}(r))return m(e,n,r,t);if(function(e){return e&&e.hasOwnProperty("bladeReference")}(r))return k(e,n,r,t);if(function(e){return e&&e.hasOwnProperty("resourceId")}(r))return b(e,n,r.resourceId,void 0,r.onLinkOpened,!1,!1,!1,t,null);if(function(e){return e&&e.hasOwnProperty("uri")}(r))return g(e,n,r,t);return f};var c=MsPortalFx.Base.Diagnostics.Telemetry;const p=n.defaultHref="#",f={uri:ko.observable(null),handler:(e,n,r)=>!0,uriPromise:null,errorMessage:ko.observable("value missing/invalid for fetching the uri or handler")};function m(e,n,r,t){return{uri:ko.observable(p),handler:(e,n,t)=>{if(y(e))return!0;const o=r(e);return"boolean"==typeof o?(o||(e.stopPropagation(),e.preventDefault()),o):void 0},uriPromise:null,errorMessage:ko.observable("")}}function k(e,n,r,t){const o=MsPortalFx.initObservable(r.bladeReference),a=ko.observable(""),d=ko.computed(e,o,(e=>{let n=null;var r;return e&&((r=e).bladeName&&r.extensionName?(n=(0,l.getBladeDeepLink)(e.extensionName,e.bladeName,e.parameters),n||a("URI fetch failed as the blade reference provided is not deep linkable")):(0,s.isProvisioningBladeReference)(e)?(n=(0,l.getGalleryDeepLink)(FxImpl.shellInterface(e).marketplaceId,{model:e.parameters}),n+=MsPortalFx.last((0,l.getBladeDeepLink)("","",e.parameters).split("//"))):a("URI fetch failed as the blade reference doesn't point to a supported blade")),n}));return{uri:d,handler:(e,n,l)=>!!y(e)||(!(t||!d()||"click"!==e.type||!(0,i.isCtrlOrCommandOnly)(e)&&!e.shiftKey)||(o()?n&&n.openBlade&&(n.openBlade(o(),l),r.onLinkOpened&&r.onLinkOpened("keydown"===e.type)):a("clickHandler noop'd as the blade reference is missing"),e.stopPropagation(),e.preventDefault(),!1)),uriPromise:null,errorMessage:a}}function b(e,n,t,a,s,c,p,f,m,k){let b=null;const g=ko.observable(""),h=ko.observable(),v=ko.observable(),I=ko.observable(),P=ko.observable(),w=n.get(o.AssetTypeService);return ko.reactor(e,(()=>{const e=ko.unwrap(t),r=ko.unwrap(a);h(null),I(null),P(null);const o=e?w.mapResourceIdAndKindToBladeInfo(e,r):Promise.reject(),i=u.tryImmediateResolve(o,(r=>{if(!(r=r||{}).bladeName)return Promise.reject();b={blade:r.bladeName,extension:r.bladeExtension,parameters:{id:e}},h((0,l.prependTenantToResourceDeepLink)(n,r.deepLink)),I(c?r.displayName:null),P(p?f?r.previewIcon:r.icon:null)}),(n=>{g(n&&("string"==typeof n?n:n.message)||(e?`URI fetch failed as the blade corresponding to the resource was not found - ${e}`:""))}));v(i)})),{uri:h,text:I,icon:P,handler:(e,n,t)=>{if(y(e))return!0;if(!m&&h()&&"click"===e.type&&((0,i.isCtrlOrCommandOnly)(e)||e.shiftKey))return!0;if(b){if(n&&n.openBlade){const o=k?k(b):b.parameters;(0,d.tryImmediateResolveValue)(o,(o=>{const a=new r.PdlBladeReference(b.blade,b.extension,{parameters:o});n.openBlade(a,t),s&&s("keydown"===e.type)}))}}else g("clickHandler noop'd as the blade reference corresponding to the resource is missing");return e.stopPropagation(),e.preventDefault(),!1},uriPromise:v,errorMessage:g}}function g(n,r,o,a){const l=ko.observable(""),s=ko.computed(n,[o.uri,o.target],((n,o)=>{const a=n&&t.sanitizeLinkUri(n,{diContainer:r,localRequire:e,windowContext:null});return!1===a?(l("URI fetch failed as the provided uri is not safe"),null):a||null}));return{uri:s,handler:(e,n,r)=>{if(y(e))return!0;if(s()){if(!a&&"click"===e.type&&((0,i.isCtrlOrCommandOnly)(e)||e.shiftKey))return!0;window.open(s(),o.target(),ko.unwrap(o.windowFeatures)||"noopener,noreferrer"),o.onLinkOpened&&(o.onLinkOpened("keydown"===e.type),h($(e.target),r)())}else l("clickHandler noop'd as the uri is missing");return e.stopPropagation(),e.preventDefault(),!1},uriPromise:null,errorMessage:l}}function h(e,n,r="LinkClicked"){const t=e.closest(".fxs-blade")[0],o=e[0],i=t&&$.data(t,a.CompositionInstanceDataName),l=i&&i.locator,s=l&&l.toFriendlyString(),d=i&&i.instanceId;return()=>{const e={bladeId:d||"##UnknownCompositionId##",link:o.textContent,target:o.getAttribute("href"),telemetryName:ko.unwrap(n)};c.trace({source:"Shell",action:r,name:s||"##UnknownBladeName##",data:e})}}function y(e){const n=e.target;return"keydown"===e.type&&!(13===e.which||32===e.which&&("BUTTON"===n.tagName||"button"===n.getAttribute("role")))}}));
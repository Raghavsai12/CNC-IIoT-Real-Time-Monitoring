define("MsPortalImpl/Controls/Helpers/Validators",["require","exports","MsPortalImpl.Controls/Fields/Base/FormValidation","MsPortalImpl/Controls/Helpers/Validation","Viva.Controls/Controls/Base/ValidationPlacements/Viva.Css","Viva.Controls/Controls/Base/ValidationPlacements/Viva.DockedBalloon","Viva.Controls/Controls/Base/Viva.Validators","Fx"],(function(i,t,a,e,l,s,o,d){"use strict";t.Validators=void 0;t.Validators=class{constructor(i,t,e,l,s){this._diContainer=i,this._validationInitialized=!1,this._doNotTriggerValidStyleChange=!1,this._lastValidated=void 0,this._pendingCount=0,this._pendingResults=[],this._widget=e,this._element=this._widget.element,this._noValidationBalloon=s,this._validationElement=l||this._element,this._viewModel=e.options||e.vm,this.ltm=t,this.validationPlacements=ko.observableArray(),this.internalValidators=ko.observableArray(),this.validationResults=this._viewModel.validationResults||ko.observableArray(),this.validatableViewModel=this._validatable={validators:ko.observableArray(),enableValidation:this._viewModel.enableValidation,valid:this._viewModel.valid,validationState:ko.observable(0)},t.registerForDispose((()=>{MsPortalFx.disposeDisposable([...this.internalValidators.removeAll(),...this._validatable.validators.removeAll(),...this.validationPlacements.removeAll()])})),this.validationState=this._validatable.validationState;const o=ko.unwrap(this._viewModel.validations);o&&o.length>0&&(ko.unwrap(this._viewModel.validations).forEach((i=>{this._addValidation(i)})),this._intializeValidation()),ko.isObservable(this._viewModel.validations)&&this._subscribeValidationChanges(this._viewModel.validations),this._subscribeValidationChanges(this.internalValidators),this.valid=this._viewModel.valid,this._viewModel._msPortalFxTriggerValidation((()=>this.triggerValidation())),this._viewModel._msPortalFxClearValidation((()=>(this._clearValidation(!0),Promise.resolve()))),a.markFormFieldElement(this._element[0],this._viewModel,this._validatable,this)}triggerValidation(){if(this._viewModel&&ko.unwrap(this._viewModel.loading)&&e.shouldValidate(this._viewModel,!1,!1,!1))return this._viewModel.valid(!1),Promise.resolve(!1);const i=[],t=this._viewModel.value();if(!e.shouldValidate(this._viewModel,this._widget.$disabled(),this._widget.isDiposed?.(),this.internalValidators().length>0))return Promise.resolve(!0);{const t=this._validatable.validators(),a=this._viewModel.value();if(void 0!==a&&!this._viewModel.showValidationMessagesBelowControl){t.some((i=>i.valid()))!==this._viewModel.valid()&&this._setValidState()}const l=e.validateValidators(t,a);let s=!0;this._pendingResults=[],this._pendingCount=0,t.forEach(((t,a)=>{const e=l[a];d.isPromise(e)?i.push(new Promise((i=>{this._pendingCount++,e.then((t=>{this._pendingCount--,i(t.valid),this._pendingResults.push(t.valid),this._setValidViaPendingStates()}))}))):s=s&&e.valid})),this._viewModel.valid()!==s?this._setValid(s):this._setValidState(s),i.push(Promise.resolve(s))}return this._lastValidated=t,Promise.all(i).then((i=>i.every(MsPortalFx.identity)))}_subscribeValidationChanges(i){i.subscribeArrayEdits(this.ltm,(i=>{const t=[];this._clearValidation(),i.forEach((i=>{"added"===i.status?this._addValidation(i.value):"deleted"===i.status&&t.push(i.value)})),t.length>0&&this._removeValidations(t),this._validationInitialized?this.triggerValidation():this._intializeValidation()}))}_intializeValidation(){this._validationInitialized=!0;const i=this.ltm,t=()=>{this.triggerValidation()};this._viewModel.value.subscribe(i,t),this._viewModel.dirty.subscribe(i,(i=>{i&&this._lastValidated!==this._viewModel.value()&&t()})),this._viewModel.validate.subscribe(i,t),this._viewModel.ensureValidation.subscribe(i,t),this._initializeValidationPlacements(),this._viewModel.valid.subscribe(i,(i=>{this._doNotTriggerValidStyleChange||this._setValidState(i)})),this._viewModel.enableValidation.subscribe(i,(i=>{this._validatable.validationState(0),i&&this._viewModel.dirty()?t():this._clearValidation(!0)})),this._widget.$disabled.subscribe(i,(i=>{i&&this._clearValidation()})),this._viewModel.loading.subscribe(this.ltm,(i=>{i||this._clearValidation()})),this._viewModel.dirty()&&t(),ko.reactor(this.ltm,(()=>{this.validationResults(o.getValidationResults(this._validatable.validators))}))}_initializeValidationPlacements(){const i=this.ltm,t=this.validationPlacements.removeAll();t.push(new l.Css(i)),this._noValidationBalloon||t.push(new s.DockedBalloon(this._diContainer,i,s.DockedBalloon.defaultOptions)),this.validationPlacements.subscribeArrayChanges(i,(i=>{i.initialize(this._validationElement,this._validatable)}),(i=>{i.dispose()})),this.validationPlacements(t)}_setValid(i){this._widget.$disabled()?this._clearValidation():this._viewModel.valid(i)}_setValidState(i,t){if(this._widget.$disabled())this._validatable.validationState(0);else{const a=i||this._viewModel.valid(),e=this._validatable.validators().some((i=>1===i.validationState()));(this._pendingCount>0||t)&&!e?(this._setValidWithoutTriggeringStyleUpdate(!1),this._validatable.validationState(3)):a?this._validatable.validationState(2):this._validatable.validationState(1)}}_setValidViaPendingStates(){let i=!0,t=!1;i=this._pendingResults.every((i=>i)),i&&this._validatable.validators().every((a=>{const e=a.validationState();return 1!==e&&3!==e||(i=!1,3===e&&(t=!0)),i&&!t}));const a=this._viewModel.valid();i===a?this._setValidState(i,t):this._setValid(i)}_setValidWithoutTriggeringStyleUpdate(i){this._doNotTriggerValidStyleChange=!0,this._setValid(i),this._doNotTriggerValidStyleChange=!1}_addValidation(i){const t=e.convertValidation(this.ltm,i);t&&this._validatable.validators.push(t)}_removeValidations(i){e.removeValidations(this._validatable,i)}_clearValidation(i){i&&this.internalValidators([]),this._validatable.validators().forEach((i=>{i.clear()})),this._validatable.validationState(0),i&&this._setValidWithoutTriggeringStyleUpdate(!0),this._viewModel.valid(!0)}}}));
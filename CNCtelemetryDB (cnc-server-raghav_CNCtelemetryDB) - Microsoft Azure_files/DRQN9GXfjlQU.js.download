define("MsPortalImpl/Services/Services.CopilotReactViewChannelFactory",["require","exports","Fx/DependencyInjection","FxInternal/Copilot/ShellAPIs","@microsoft/azureportal-reactview/internal/FunctionProxy","FxInternal/AsyncLoader","MsPortalImpl/Services/Services.Copilot","MsPortalImpl/Extension/ExtensionManager"],(function(e,t,o,r,n,i,s,a){"use strict";t.getReactViewPortForCopilotManagerHandler=t.getActiveReactViewsForCopilotManagerHandler=t.ReactViewChannelFactory=void 0;let l=t.ReactViewChannelFactory=class{constructor(e,t,o){this._rpcClient=e,this._diContainer=t,this._extensionManager=o,this._portsToTransfer=new Map,this._extensionManager.onUnload((e=>("Microsoft_Azure_Copilot"===e&&this._disposeCopilotExtension(),!0)))}createChannel(e,t,o){if((0,s.isCopilotEnabled)(this._diContainer)){const{port1:r,port2:n}=new MessageChannel,i=`Blade_${MsPortalFx.sessionId}_${o}_0`;return this._addPortToTransfer(t,i,r),e.registerForDispose((()=>this._disposeBlade(i))),Promise.resolve(n)}}getActiveReactViews(){return[...this._portsToTransfer.entries()].map((([e,{bladeId:t}])=>({id:t,instanceId:e})))}_addPortToTransfer(e,t,o){const r=new n.FunctionProxyImpl({pair:()=>{this._pair(t,e)}});r.setPort(o),this._portsToTransfer.set(t,{bladeId:e,shellToRVPort:o,bladeFunctionProxy:r})}_disposeBlade(e){const{copilotExtensionPortAcquisition:t}=this._portsToTransfer.get(e);t?.dispose(),this._portsToTransfer.delete(e)}_disposeCopilotExtension(){this._portsToTransfer.forEach((e=>{if(e?.isTransferred){const{copilotExtensionPortAcquisition:t}=e;e.isTransferred=!1,t?.dispose()}}))}_pair(e,t){const o=this.tryTransferPort(e);return"number"==typeof o?r.pushReactViewPortToCopilotManagerEndpoint.invoke(this._rpcClient,"Microsoft_Azure_Copilot",{bladeContext:{instanceId:e,id:t},portId:o}):Promise.resolve()}tryTransferPort(e){const t=this._portsToTransfer.get(e);if(!t||t.isTransferred)return null;const{shellToRVPort:o,bladeFunctionProxy:r,bladeId:n}=t;t.isTransferred=!0,r.setPort(null);const i=new MessageChannel;o.onmessage=t=>this._pair(e,n).then((()=>i.port1.postMessage(t.data))),i.port1.onmessage=t=>this._pair(e,n).then((()=>o.postMessage(t.data)));const s=this._rpcClient.acquireWindow("Microsoft_Azure_Copilot",0,i.port2);return t.copilotExtensionPortAcquisition=s,s.value}};t.ReactViewChannelFactory=l=__decorate([__metadata("fx:diagnostics",[e,"ReactViewChannelFactory"]),o.Class(),__metadata("design:paramtypes",[FxImpl.Rpc.Client,o.Container,a.ExtensionManagerImpl])],l);t.getReactViewPortForCopilotManagerHandler=(0,i.defineHandler)(r.getReactViewPortForCopilotManagerEndpoint,(({diContainer:e,messageArg:t})=>e.get(l).tryTransferPort(t))),t.getActiveReactViewsForCopilotManagerHandler=(0,i.defineHandler)(r.getActiveReactViewsForCopilotManagerEndpoint,(({diContainer:e})=>e.get(l).getActiveReactViews()))}));
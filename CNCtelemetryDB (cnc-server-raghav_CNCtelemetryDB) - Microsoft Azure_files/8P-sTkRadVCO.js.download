define("MsPortalImpl/Commands/Commands.FileDownloadCommand",["require","exports","MsPortalImpl/Commands/FileDownloadUtil","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Base/Base.ImplUtils"],(function(o,t,e,r,s,a){"use strict";t.FileDownloadCommand=void 0;var n=MsPortalFx.Base,l=n.Net2,i=n.Resources,d=MsPortalFx.ViewModels.Dialogs;const c=r.FileDownloadCommand,u=412;t.FileDownloadCommand=class{constructor(o,t,e,r,s){this._context=o,this._diContainer=t,this._formTarget=e,this._sourceTarget=r,this._locator=s,this.canExecute=ko.observable(!0),this._getResources()}execute(t){if(!this.canExecute())return Promise.resolve();this.canExecute(!1);const r=this._context,n=e.getHttpMethod(r);if(!n)return e.notifyError(r,u,c.typeError),this.canExecute(!0),Promise.resolve();r.downloadStatus(null);const d=this._diContainer.getAsync(s.DialogManager),h=d.then((o=>this._getTargetUri(o)));return Promise.all([d,h]).then((([o,t])=>{const s=t&&t.startsWith("data:");if(i.isUriAbsolute(t)||s){if(r.onStart&&r.onStart(),r.showDownloadProgressDialog&&r.showDownloadProgressDialog()&&this._showDldProgressDlg(o),!s)return l.ajaxExtended(e.getAjaxOptions(r,t,n)).then((t=>e.onSuccess(r,o,t.content,t.textStatus,t.jqXHR)),(t=>{const s=t;return e.onError(r,o,s.textStatus,s.jqXHR.status,s.errorThrown),Promise.reject(t)}));e.dataUriHandler(r,o,t)}else e.notifyError(r,u,c.absoluteUriError)})).catch((t=>{t&&(0,a.logToExtension)(o,this._sourceTarget,2,t)})).finally((()=>{this.canExecute(!0)}))}_getTargetUri(o){const t=Promise.withResolvers(),r=this._context,a=r.targetUriCallback&&r.targetUriCallback(),n=r.showUriCallbackConfirmationDialog&&r.showUriCallbackConfirmationDialog();if(a)n&&this._showUriCbProgressDlg(o),a().then((a=>{if(!a)return e.notifyError(r,u,c.uriError),t.reject(new Error(c.uriError)),void e.dismissDialog(o,r);if(n){const e=new s.MessageBox(this._dnldTitle,this._dnldText,2);return e.defaultButtonText=this._defaultBtnText,e.cancelButtonText=this._cancelBtnText,o.showDialog(e,this._formTarget,this._sourceTarget,{locator:this._locator}).then((o=>{4===o?t.resolve(a):t.reject(null)}))}t.resolve(a),e.dismissDialog(o,r)})).catch((s=>{const a=r.errorMessage()||c.downloadTargetUriCallbackFailed;e.dismissDialog(o,r),e.notifyError(r,u,a),t.reject(new Error(a))}));else{const o=r.targetUri?r.targetUri():null;o?t.resolve(o):(e.notifyError(r,u,c.uriError),t.reject(new Error(c.uriError)))}return t.promise}_showUriCbProgressDlg(o){this._showProgressDlg(o,this._uriCbProgressTitle,this._uriCbProgressText)}_showDldProgressDlg(o){this._showProgressDlg(o,this._progressTitle,this._progressText)}_showProgressDlg(o,t,e){const r=new d.ProgressBox(t,e);o.showDialog(r,this._formTarget,this._sourceTarget,{locator:this._locator})}_getResources(){const o=this._context,t=o.uriCallbackConfirmationDialogOptions||{},e=o.downloadProgressDialogOptions||{};this._uriCbProgressTitle=t.uriCallbackProgressTitle||c.uriCallbackProgressTitle,this._uriCbProgressText=t.uriCallbackProgressText||c.uriCallbackProgressText,this._dnldTitle=t.downloadTitle||c.downloadTitle,this._dnldText=t.downloadText||c.downloadText,this._defaultBtnText=t.defaultButtonText||c.defaultButtonText,this._cancelBtnText=t.cancelButtonText||c.cancelButtonText,this._progressTitle=e.downloadProgressTitle||c.downloadProgressTitle,this._progressText=e.downloadProgressText||c.downloadProgressText}}})),
define("MsPortalImpl/Commands/Commands.FxFileDownloadCommand",["require","exports","MsPortalImpl/Commands/FileDownloadUtil","Fx/Controls/FileDownload","MsPortalImpl/Resources/ImplScriptResources","FxInternal/Controls/FileDownload","MsPortalImpl/UI/Hubs/UI.NotificationManager","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Base/Base.ImplUtils"],(function(o,t,e,r,s,a,n,l,i){"use strict";t.userDownloadCancelInternalMessage=t.Impl=t.FxFileDownloadCommand=void 0;var d=MsPortalFx.Base,c=d.Net2,u=MsPortalFx.ViewModels.Dialogs;const h=window,g=s.FileDownloadCommand,w=t.userDownloadCancelInternalMessage="UserDownloadCancel_NoOp";function m(o){return o&&o.targetUri&&d.Resources.isUriAbsolute(o.targetUri)}function x(o,t,e=null){const r={status:t,errorMessage:e};o.downloadStatus(r),o.onComplete&&o.onComplete(r)}function D(o,t){const e=t.downloadDialogOptions();o&&e&&(e.showDownloadProgressDialog||e.showCallbackProgressDialog||e.showDownloadConfirmationDialog)&&o.dismissOpenDialog()}var p;function C(o,t,e){const s=o.errorMessage()?g.downloadErrorDetails2.format(o.errorMessage(),t):t;return D(e,o),p.notifyError(o,r.Status.DownloadPreConditionFailed,s),Promise.reject(new Error(t))}!function(o){o.notifyError=function(o,t,e=null){if(x(o,t,e),!o.disableNotifications){const t=o.errorTitle()||g.downloadCommandError;n.getNotificationManager().addSingleNotification({title:t,description:e,status:2})}},o.ajaxSuccessHandler=(o,t,s,a)=>{const n=t.targetFileName||e.getContentDispostionOrDefaultFileName(a.jqXHR),l=new Blob([a.content],{type:"application/octet-stream"});return D(s,o),e.saveAsDlg(l,n),x(o,r.Status.Success),Promise.resolve()}}(p||(t.Impl=p={}));t.FxFileDownloadCommand=class{constructor(o,t,e,r,s){this._downloadVM=o,this._diContainer=t,this._formTarget=e,this._sourceTarget=r,this._locator=s,this.canExecute=ko.observable(!0)}execute(t){if(!this.canExecute())return Promise.resolve();const e=this._downloadVM,r=e.downloadType;return this.canExecute(!1),e.downloadStatus(null),this._diContainer.getAsync(l.DialogManager).then((o=>r===a.DownloadType.OAuth?this._handleOAuthDownload(o):r===a.DownloadType.SasLike?this._handleSasLikeDownload(o):r===a.DownloadType.DataUri?this._handleDataUriDownload(o):r===a.DownloadType.BlobUri?this._handleBlobUriDownload(o):void 0)).catch((t=>{t&&t.message!==w&&(0,i.logToExtension)(o,this._sourceTarget,2,t)})).finally((()=>{this.canExecute(!0)}))}_getDownloadContext(o){const t=this._downloadVM,e=t.downloadDialogOptions();return t.downloadContextCallback?(e&&e.showCallbackProgressDialog&&this._showUriCbProgressDlg(o),t.downloadContextCallback().then((r=>{if(!r||!r.targetUri)return Promise.reject(new Error(g.uriError));if(e&&e.showDownloadConfirmationDialog){const t=new l.MessageBox(e.downloadConfirmationTitle||g.downloadTitle,e.downloadConfirmationText||g.downloadText,2);return t.defaultButtonText=e.downloadConfirmationOKButtonText||g.defaultButtonText,t.cancelButtonText=e.downloadConfirmationCancelButtonText||g.cancelButtonText,o.showDialog(t,this._formTarget,this._sourceTarget,{locator:this._locator}).then((o=>4===o?Promise.resolve(r):Promise.reject(w)))}return D(o,t),Promise.resolve(r)})).catch((e=>{let r=t.errorMessage()||g.downloadTargetUriCallbackFailed;return D(o,t),e&&e===w?(r=w,Promise.reject(new MsPortalFx.Errors.CanceledError(r))):(e&&(r=g.downloadErrorDetails2.format(r,e)),C(t,r,o))}))):t.downloadContext?Promise.resolve(t.downloadContext):C(t,g.downloadContextNotProvided,o)}_handleOAuthDownload(o){const t=this._downloadVM;return this._getDownloadContext(o).then((e=>{if(!m(e))return C(t,g.absoluteUriError,null);const s=e.httpMethod||"GET";return"GET"!==s&&"POST"!==s?C(t,g.typeError,null):(t.onStart&&t.onStart(),t.downloadDialogOptions()&&t.downloadDialogOptions().showDownloadProgressDialog&&this._showDldProgressDlg(o),c.ajaxExtended(function(o){const t=2===o.contentType?"binary":"text",e=o.authorizationToken,r=o.httpMethod||"GET",s=o.httpRequestContent||null,a=o.httpRequestContentType||"application/json",n=MsPortalFx.clone(o.headers||{});e&&(n.Authorization=e);const l={uri:o.targetUri,type:r,dataType:t,headers:n,checkVersion:!1,skipDomainValidation:!0};return"binary"===t&&(l.processData=!1,l.responseType="arraybuffer"),"POST"===r&&s&&(l.data=s,l.contentType=a),l}(e)).then((r=>p.ajaxSuccessHandler(t,e,o,r)),(e=>function(o,t,e){return D(t,o),p.notifyError(o,r.Status.DownloadError,g.downloadErrorDetails.format(o.errorMessage()||g.downloadError,e.textStatus,e.jqXHR.status,e.errorThrown)),Promise.reject(e)}(t,o,e))))}))}_handleDataUriDownload(o){return this._getDownloadContext(o).then((o=>{const t=this._downloadVM;if(!o||!o.targetUri||!o.targetUri.startsWith("data:"))return C(t,g.dataUriParseError,null);const s=o.targetFileName||g.defaultFileName,a=e.convertDataUriToBlob(o.targetUri,2===o.contentType?"binary":"text");t.onStart&&t.onStart(),a.errorMessage||!a.blob?p.notifyError(t,r.Status.UriError,a.errorMessage):(e.saveAsDlg(a.blob,s),x(t,r.Status.Success))}))}_handleBlobUriDownload(o){const t=this._downloadVM;return this._getDownloadContext(o).then((o=>o&&o.targetUri&&o.targetUri.startsWith("blob:")?(t.onStart&&t.onStart(),t.extensionisInWebWorker?a.downloadBlobUri(o.targetUri,o.targetFileName).then((()=>{x(t,r.Status.Success)})):t.onBlobUriDownload(o.targetUri,o.targetFileName).then((()=>{x(t,r.Status.Success)}))):C(t,g.blobUriError,null)))}_handleSasLikeDownload(o){const t=this._downloadVM,e=t.downloadDialogOptions();if(t.downloadContextCallback&&e&&e.showDownloadConfirmationDialog)return this._getDownloadContext(o).then((o=>{if(!m(o))return C(t,g.absoluteUriError,null);t.onStart&&t.onStart(),h.open(o.targetUri,"_blank")}));if(t.downloadContextCallback){const s=h.open("about:blank","_blank");return e&&e.showCallbackProgressDialog&&this._showUriCbProgressDlg(o),t.downloadContextCallback().then((e=>{if(!m(e))return C(t,g.absoluteUriError,o);D(o,t),t.onStart&&t.onStart(),s.location.href=e.targetUri})).catch((e=>{let a=t.errorMessage()||g.downloadTargetUriCallbackFailed;e&&(a=g.downloadErrorDetails2.format(a,e)),D(o,t),p.notifyError(t,r.Status.DownloadPreConditionFailed,a),s&&s.close()}))}return m(t.downloadContext)?(t.onStart&&t.onStart(),h.open(t.downloadContext.targetUri,"_blank"),Promise.resolve()):C(t,g.absoluteUriError,null)}_showUriCbProgressDlg(o){const t=this._downloadVM.downloadDialogOptions()||{};this._showProgressDlg(o,t.callbackProgressTitle||g.uriCallbackProgressTitle,t.callbackProgressText||g.uriCallbackProgressText)}_showDldProgressDlg(o){const t=this._downloadVM.downloadDialogOptions()||{};this._showProgressDlg(o,t.downloadProgressTitle||g.downloadProgressTitle,t.downloadProgressText||g.downloadProgressText)}_showProgressDlg(o,t,e){const r=new u.ProgressBox(t,e);o.showDialog(r,this._formTarget,this._sourceTarget,{locator:this._locator})}}})),
define("_generated/Less/MsPortalImpl/Controls/Controls.FileDownloadButton.css",["module"],(function(o){"use strict";return{css:'.fxc-fileDownloadButton{display:inline-flex;max-width:100%}.fxc-fileDownloadButton .fxc-simplebutton{display:inherit}.azc-toolbarButton-link-disabled[role="link"]{cursor:default;color:rgba(127,127,127,.7)}',moduleId:o.id}})),
define("MsPortalImpl/Controls/Controls.FileDownloadButton",["require","exports","MsPortalImpl/TsxStringMode/Tsx","MsPortalImpl/Base/Base.BrowserDetection","MsPortalImpl/Commands/Commands.FileDownloadCommand","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl.Controls/Controls/Base/Loadable","Fx/Controls/Button","MsPortalImpl/Commands/Commands.FxFileDownloadCommand","MsPortalImpl/Weave/Util","FxInternal/Css","_generated/Less/MsPortalImpl/Controls/Controls.FileDownloadButton.css"],(function(o,t,e,r,s,a,n,l,i,d,c,u){"use strict";t.Widget=t.FileDownloadButton=void 0;var h=e;(0,c.injectCss)(u);const g="fxc-fileDownloadButton",w="fxs-button-disabled",m=h.tsx(e.Root,null,h.tsx(e.KoIfNot,{condition:"$vm.asLink"},h.tsx("div",{"data-bind":{pcControl:"$ctl.buttonViewModel",attr:{title:"$ctl.tooltip"}}})),h.tsx(e.KoIf,{condition:"$vm.asLink"},h.tsx("a",{role:"link",class:"fxs-fileDownloadLink","data-bind":{text:"$vm.label",css:{"azc-toolbarButton-link-disabled":"$disabled"},attr:{title:"$ctl.tooltip",tabindex:'!$disabled() ? $tabIndex : "-1"',"aria-disabled":"$disabled","aria-label":"$vm.ariaLabel",href:'!$disabled() ? "#" : null'},click:"$ctl.handler"}})),h.tsx("div",{class:"fxc-dialogContainer"}));class x extends n.Widget{constructor(o,t,e){super(o,t,e),this._initializeWidgets()}dispose(){this._cleanElement(g,"fxs-button","fxs-portal-button-primary",w),super.dispose()}get options(){return this._options}getForm(){return this.element.find(".fxc-dialogContainer")[0]}hideForm(){}showForm(){}_initializeWidgets(){this.element.addClass(g),this.element.html(m);const o=this.options,t=this._diContainer;let e=ko.observable(null);const n=this.element[0];"downloadContext"in o?(this.command=new i.FxFileDownloadCommand(o,t,this,n),e=o.toolTip):this.command=new s.FileDownloadCommand(o.context(),t,this,n),this.tooltip=ko.computed(this.ltm,(()=>{if(r.isSafari&&r.webKitVersion<r.safari_11_webKitVersion)return this.command.canExecute(!1),a.FileDownloadCommand.safariDownload;const o=ko.unwrap(e);return o||(this.options.ariaLabel()?this.options.ariaLabel():this.options.label())}));const d=ko.pureComputed((()=>{const t=!this.command.canExecute()||o.disabled();return this.options.asLink||this.element.toggleClass(w,t),t}));this.handler=(t,e)=>{e&&(e.stopPropagation(),e.preventDefault()),d()||this.command.execute(o)},this.buttonViewModel=l.create(this.ltm,{text:this.options.label,icon:ko.pureComputed((()=>this.options.icon&&{position:0,image:this.options.icon()})),ariaLabel:this.options.ariaLabel,onClick:this.handler,disabled:d}),this._bindDescendants(),this.options.asLink||ko.computed(this.ltm,(()=>{this.element.find(".fxs-button").attr("title",this.tooltip())}))}}t.Widget=x;t.FileDownloadButton=(0,d.createControlComponentForKO)({widgetCtor:x})}));
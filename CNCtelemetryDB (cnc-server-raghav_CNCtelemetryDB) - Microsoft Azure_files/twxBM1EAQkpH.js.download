define("FxHubs/ArmHelpers/ArmResources",["require","exports","Fx/Ajax"],(function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.rpRegistrationCheckRetries=r.rpRegistrationCheckDelay=void 0,r.getProvisioningState=function(e){return((e&&e.properties||{}).provisioningState||"").toLowerCase()},r.getRawArmResource=i,r.getArmResource=function(e,r){return i(e,r).then((function(e){return e.content}))},r.buildError=function(e){e&&(e.jqXHR&&(e=n.buildSimplifiedError(e.jqXHR)),e.httpStatusCode&&(e=n.buildSimplifiedError(e)),0!==e.status||e.code||(e.code=o));return e};var n=FxImpl.Azure;r.rpRegistrationCheckDelay=1e3,r.rpRegistrationCheckRetries=3;var o="ClientNetworkError";function i(e,r){return(0,t.batch)({uri:e,type:"GET",options:0,setTelemetryHeader:r})}})),
define("FxHubs/ArmHelpers/ArmResourceGroups",["require","exports","Fx/Ajax","Fx/DependencyInjection","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/ArmHelpers/ArmResources","Fx","FxHubs/RpcEndPoints","Fx/Telemetry","Fx/ResourceManagement"],(function(e,r,t,n,o,i,s,a,l,u){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ProvisioningResourceGroupTags=r.allowlistedExtensions=r.resourceGroupCheckDelay=r.resourceGroupCheckRetries=r.rpRegistrationCheckRetries=void 0,r.checkResourceGroupStatus=g,r.createResourceGroup=function(e,n,i,d,p,y){return __awaiter(this,void 0,void 0,(function(){var m,_,b,P,T,x,R,F,C,A=this;return __generator(this,(function(w){switch(w.label){case 0:m=u.ArmId.stringify({subscription:n,resourceGroup:i,kind:4},4),_=(0,o.resourceGroupApi)(m),b={source:p,name:"".concat(f).concat(v),action:"start"},(0,l.trace)(b),P=!1,(null==(T=(null==e?void 0:e.scope)&&(null==e?void 0:e.get(h)))?void 0:T.tagsExp)&&(y=T.getTags(y)),x={name:i,location:d,tags:y},w.label=1;case 1:return w.trys.push([1,4,,5]),[4,__awaiter(A,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return(0,s.isFeatureEnabled)("armTokenTest")||r.allowlistedExtensions[FxImpl.postBootEnv.extensionName]?[4,a.ResourceManager.internalDeploymentHelper.invoke(FxImpl.Rpc.client,c.Constants.Shell,__assign(__assign({uri:_,type:"PUT",content:x},x),{setTelemetryHeader:"".concat(p,".").concat(f).concat(v),options:0}))]:[3,2];case 1:case 3:return[2,e.sent()];case 2:return[4,(0,t.batch)(__assign(__assign({uri:_,type:"PUT",content:x},x),{setTelemetryHeader:"".concat(p,".").concat(f).concat(v),options:0}))]}}))}))];case 2:return R=w.sent(),C=R.httpStatusCode,P=!0,(0,l.trace)(__assign(__assign({},b),{data:{httpStatusCode:C},name:"failed"})),[4,g(R.content,_,i)];case 3:return[2,w.sent()];case 4:throw F=w.sent(),P||(C=F.httpStatusCode,(0,l.trace)(__assign(__assign({},b),{data:{httpStatusCode:C},name:"failed"}))),F;case 5:return[2]}}))}))},r.getDeepLinkToResourceGroup=function(e){return"#asset/".concat("HubsExtension","/ResourceGroups").concat(e)},r.getDeepLinkToSubscription=function(e){return"resource".concat(e,"/resources")};var c=MsPortalFx.Base,d=MsPortalFx.Azure.ResourceManager.DeploymentStates;r.rpRegistrationCheckRetries=3,r.resourceGroupCheckRetries=5,r.resourceGroupCheckDelay=1e3;var p=c.Diagnostics.createLog(e),f="Deploy.",v="createRG";function g(e,t,n){return __awaiter(this,arguments,void 0,(function(e,t,n,o){var s,a;return void 0===o&&(o=r.resourceGroupCheckRetries),__generator(this,(function(l){switch(l.label){case 0:switch(s=(0,i.getProvisioningState)(e),s){case d.Succeeded:case d.Failed:return[3,1]}return[3,2];case 1:return p.verbose("Creating resource group ".concat(n," ").concat(s,".")),[2,e];case 2:return o?[4,new Promise((function(e){return setTimeout(e,r.resourceGroupCheckDelay)}))]:(p.warning("Creating resource group ".concat(n,": Status unknown after ").concat(r.resourceGroupCheckRetries," attempts.")),[2,e]);case 3:return l.sent(),a=g,[4,(0,i.getArmResource)(t,"".concat(f).concat(v,".attempt").concat(r.resourceGroupCheckRetries-o))];case 4:return[4,a.apply(void 0,[l.sent(),t,n,o-1])];case 5:return[2,l.sent()]}}))}))}r.allowlistedExtensions={VMCP:!0,Citrix_XenApp_Essentials:!0,Citrix_XenDesktop_Essentials:!0,CloudSimpleExtension:!0,SendGrid_EmailService:!0};var y="fx"!==(0,s.getEnvironmentValue)("extensionName")?"viewModel":"composition",h=function(){function r(){this.newResourceGroupName=ko.observable(),this.rgResourceType="microsoft.resources/subscriptions/resourcegroups",this.tagsExp=!0}return Object.defineProperty(r.prototype,"tags",{set:function(e){var r,t=this;this.resourceGroupTags=null===(r=e.find((function(e){return e.id.toLowerCase()===t.rgResourceType})))||void 0===r?void 0:r.tags},enumerable:!1,configurable:!0}),r.prototype.getTags=function(e){return this.resourceGroupTags&&!e&&this.tagsExp?this.resourceGroupTags.reduce((function(e,r){return e[r.name]=r.value,e}),{}):e},r=__decorate([__metadata("fx:diagnostics",[e,"ProvisioningResourceGroupTags"]),n.Class(y),__metadata("design:paramtypes",[])],r)}();r.ProvisioningResourceGroupTags=h})),
define("FxInternal/ResourceManagement/Policy/PolicyDataCore",["require","exports","Fx/Ajax","Fx/ResourceManagement","Fx/Telemetry","FxHubs/ArtHelpers/ArtApis"],(function(e,r,t,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.convertItemWithSubPropertyToStringLC=a,r.getPolicyJourney=function(e){return __awaiter(this,void 0,void 0,(function(){var r,t,n,i,s,c,h,m,_,b,T=this;return __generator(this,(function(x){return r=e.bladeName,t=e.scope,n=e.resolvedValuesToField,i=e.allowEmptyValues,MsPortalFx.isNullOrUndefined(i)&&(i=!1),((s=e.additionalTelemetry)||(s={})).__platform||((s||(s={})).__platform="KO"),e=__assign(__assign({},e),{allowEmptyValues:i,additionalTelemetry:s}),c=e.resourceTypeMetadata,h=MsPortalFx.isArrayOrObservableArray(c)?c:[c],m=function(t){(0,o.trace)({action:l.PolicyJourney,source:"PolicyDataCore",data:__assign(__assign({},t),{additionalTelemetry:e.additionalTelemetry,bladeName:r})})},_=e.allowEmptyValues?!MsPortalFx.isNullOrUndefined(e.resolvedValuesToField):(null==n?void 0:n.length)>0,(null==h?void 0:h.length)&&_?(b={policyJourneyId:MsPortalFx.newGuid(),getAliasesCallNamespaces:[],bladeName:null==e?void 0:e.bladeName},!MsPortalFx.isNullOrWhiteSpace(t.scopeId)&&h.length>0?[2,y(h,b).then((function(r){return __awaiter(T,void 0,void 0,(function(){var o,i,s,l,c,y,h,_,T,x,R,F,C,A,w,V,k,M,S,E,I;return __generator(this,(function(D){switch(D.label){case 0:return o=[],i=new MsPortalFx.Map,s=[],(l=Object.getOwnPropertyNames(r)).length?(l.forEach((function(l){var c=r[l];if(c.apiVersion)if(i.set(o.length,{}),u(c)){null==(d=c.resourceTypePropertyAlias)||d.forEach((function(r){var s=n.map((function(e){return a(e,r.resourceTypeSubProperty)}));s=MsPortalFx.unique(s),!MsPortalFx.isNullOrUndefined(e.allowEmptyValues)&&e.allowEmptyValues||(s=s.filter((function(e){return!MsPortalFx.isNullOrWhiteSpace(e)}))),i.set(o.length,{});var l=P(t,{field:r.resourceTypePropertyAlias,values:s},{apiVersion:c.apiVersion,resourceContent:{type:c.resourceType}},r.resourceTypeSubProperty,i.get(o.length));o.push(l)}))}else{var d=c.resourceTypePropertyAlias,p=P(t,d?{field:d,values:n}:void 0,{apiVersion:c.apiVersion,resourceContent:{type:c.resourceType}},void 0,i.get(o.length));o.push(p)}else"type"===c.resourceTypeProperty&&s.push(c.resourceType)})),s.length&&(i.set(o.length,{}),c=P(t,{field:"type",values:s},{},void 0,i.get(o.length)),o.push(c)),[4,Promise.all(o)]):[3,3];case 1:return y=D.sent(),h=MsPortalFx.clone(y,!0),_={},T=[],x={},R=[],null==h||h.forEach((function(e,r){var t,o,s;if(e)if(e.additionalTelemetry=i.get(r),e.error&&R.push(e.error),e.isPendingFieldsUndefined){var a=null===(o=null===(t=e.policyCheckResponse)||void 0===t?void 0:t.contentEvaluationResult)||void 0===o?void 0:o.policyEvaluations;a&&a.forEach((function(r){var t,o,i,s,a=null===(t=r.policyInfo)||void 0===t?void 0:t.policyAssignmentId,l=null===(o=r.policyInfo)||void 0===o?void 0:o.policyDefinitionReferenceId;a&&(g(_,a,l),null===(s=null===(i=r.evaluationDetails)||void 0===i?void 0:i.evaluatedExpressions)||void 0===s||s.forEach((function(r){var t=null==r?void 0:r.expressionValue;f(T,t,n,e.resourceTypeSubProperty)})))}))}else(null===(s=e.policyCheckResponse)||void 0===s?void 0:s.fieldRestrictions)&&e.policyCheckResponse.fieldRestrictions.forEach((function(r){var t;null===(t=r.restrictions)||void 0===t||t.forEach((function(r){var t,o,i,s,a,l,u=r.policy.policyAssignmentId,c=r.policy.policyDefinitionReferenceId;if(0===MsPortalFx.localeCompareIgnoreCase(r.result,"Deny"))g(_,u,c),null===(t=r.values)||void 0===t||t.forEach((function(r){f(T,r,n,e.resourceTypeSubProperty)}));else if(0!==MsPortalFx.localeCompareIgnoreCase(r.result,"Required")||"defaultValue"in r)MsPortalFx.localeCompareIgnoreCase(r.result,"Removed");else{g(_,u,c),o=T,i=r.values,s=n,a=e.resourceTypeSubProperty,null==(l=v(s,a,i))||l.forEach((function(e){p(o,e)}));var d=r.values;if(d&&d.length)if(x[e.resourceTypeSubProperty]){var y=d.filter((function(r){return x[e.resourceTypeSubProperty].includes(r)}));x[e.resourceTypeSubProperty]=y}else x[e.resourceTypeSubProperty]=d}}))}))})),F=Object.getOwnPropertyNames(_),C=F.map((function(e){return _[e]})),[4,Promise.all(C)];case 2:return A=D.sent(),w={},F.forEach((function(e,r){w[e]=A[r]})),O=w,N=[],Object.getOwnPropertyNames(O).forEach((function(e){N.push(O[e])})),V=N=N.sort((function(e,r){return((null==e?void 0:e.reason)||"").localeCompare((null==r?void 0:r.reason)||"")})),k=[],h[0].suggestedTagDefaultValue?p(k,h[0].suggestedTagDefaultValue):Object.getOwnPropertyNames(x).forEach((function(e){var r,t=x[e];null==(r=n.length?v(n,e,t):t)||r.forEach((function(e){p(k,e)}))})),M=d(T,k,V,b.getAliasesCallNamespaces,R),h.some((function(e){return!e.additionalTelemetry.cached}))&&(S=__assign(__assign({},b),{result:{valid:0===V.length,allResultsCount:V.length},allowedValuesLength:null===(E=M.allowedValues)||void 0===E?void 0:E.length,deniedValuesLength:null===(I=M.deniedValues)||void 0===I?void 0:I.length,debug:M.debug,allErrorResults:M.allErrorResults}),m(S)),[2,M];case 3:return[2,d([],[],[],b.getAliasesCallNamespaces,[])]}var O,N}))}))})).catch((function(e){var r=__assign(__assign({},b),{allowedValuesLength:0,deniedValuesLength:0,allErrorResults:[],debug:{getAliasesCallNamespaces:[],checkPolicyRestrictionsPromiseErrorsLength:0}});return m(r),d([],[],[],[],[])}))]:[2,d([],[],[],[],[])]):[2,d([],[],[],[],[])]}))}))},r.getConsolidatedFieldAliasPromise=y,r.clearCheckPolicyRestrictionsPromiseCache=function(){_={},h={}};var s=function(e){return Object.entries(e)};function a(e,r){var t=function(e,r){return r?e&&e[r]:e}(e,r);return(MsPortalFx.isNullOrUndefined(t)?"":"string"!=typeof t?JSON.stringify(t):t).toLowerCase()}var l={PolicyJourney:"PolicyJourney"};function u(e){return MsPortalFx.isArrayOrObservableArray(null==e?void 0:e.resourceTypePropertyAlias)}function c(e,r,n,o){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){return[2,t.batch({uri:r,type:e||"POST",setTelemetryHeader:n,content:o}).then((function(e){return e.content})).catch((function(e){throw{responseJSON:e.content,status:e.httpStatusCode}}))]}))}))}function d(e,r,t,n,o){return{deniedValues:e,allowedValues:r,allErrorResults:t,debug:{getAliasesCallNamespaces:n,checkPolicyRestrictionsPromiseErrorsLength:null==o?void 0:o.length}}}function p(e,r){e.includes(r)||e.push(r)}function f(e,r,t,n){if(!MsPortalFx.isNullOrWhiteSpace(r))if(n){if(t){var o=t.filter((function(e){var t=a(e,n);return 0===MsPortalFx.localeCompareIgnoreCase(t,r)}));o.length&&o.forEach((function(r){p(e,r)}))}}else p(e,r)}function v(e,r,t){var n=[];return t&&(null==e||e.forEach((function(e){var o=t.map((function(e){return a(e,"")})),i=a(e,r);o.includes(i)&&p(n,e)}))),n}function g(e,r,t){var o="".concat(r,"-").concat(t);void 0===e[o]&&(e[o]=function(e,r){return __awaiter(this,void 0,void 0,(function(){var t,o,s,a,l,u,d,p=this;return __generator(this,(function(f){switch(f.label){case 0:return f.trys.push([0,2,,3]),[4,c("GET","".concat(e,"?api-version=2020-09-01")).catch((function(r){return __awaiter(p,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return 403!==r.status?[3,2]:[4,(0,i.getDataFromArt)({query:'policyResources | where type =~ "Microsoft.Authorization/PolicyAssignments" and id =~ "'.concat(e,'" | project properties')},"getPermissionsDeniedPolicyAssignmentReason")];case 1:return[2,{properties:t.sent().data.rows[0][0]}];case 2:throw r}}))}))}))];case 1:return t=f.sent().properties,o="",(null==(s=null===(u=null==t?void 0:t.nonComplianceMessages)||void 0===u?void 0:u.filter((function(e){return e.policyDefinitionReferenceId})))?void 0:s.length)&&s.forEach((function(e){0===MsPortalFx.localeCompareIgnoreCase(e.policyDefinitionReferenceId,r)&&(o=e.message)})),o||(a=null===(d=null==t?void 0:t.nonComplianceMessages)||void 0===d?void 0:d.filter((function(e){return!e.policyDefinitionReferenceId})),o=(null==a?void 0:a.length)?a[0].message:t.displayName),[2,{policyAssignmentId:e,policyDefinitionReferenceId:r,reason:o}];case 2:return f.sent(),l=n.ArmId.parse(e),[2,{policyAssignmentId:e,policyDefinitionReferenceId:r,reason:"".concat(l.resourceName)}];case 3:return[2]}}))}))}(r,t))}function y(e,r){return __awaiter(this,void 0,void 0,(function(){var t,n,o,i;return __generator(this,(function(s){switch(s.label){case 0:return t={},n=!0,null==e||e.forEach((function(e){var r=((null==e?void 0:e.resourceTypeProperty)||"").toLowerCase(),o="identity.type"===r||r.startsWith("tags")||!r.includes("."),i=u(e);if(o||i){var s=m(e.resourceType,e.resourceTypeProperty);t[s]={resourceType:e.resourceType,apiVersion:e.apiVersion,resourceTypeProperty:e.resourceTypeProperty,resourceTypePropertyAlias:e.resourceTypePropertyAlias?e.resourceTypePropertyAlias:e.resourceTypeProperty}}else if(null==e?void 0:e.resourceTypePropertyAlias){s=m(e.resourceType,e.resourceTypePropertyAlias);t[s]=e}else n=!1})),n?[2,t]:[3,1];case 1:return o=[],null==e||e.forEach((function(e){var t,n;if(e.resourceTypePropertyAlias)n=new Promise((function(r){return r({metadata:e,aliases:void 0})}));else{var i=null===(t=e.resourceType)||void 0===t?void 0:t.split("/")[0];n=i&&e.resourceTypeProperty?function(e,r){var t=h[e];t||(null==r||r.getAliasesCallNamespaces.push(e),t=h[e]=c("GET","/providers/".concat(e,"?api-version=2019-10-01&$expand=resourceTypes/aliases"),"aliases"));return t}(i,r).then((function(r){var t,n=null===(t=r.resourceTypes.find((function(r){return 0===MsPortalFx.localeCompareIgnoreCase(r.resourceType,e.resourceType.split("/")[1])})))||void 0===t?void 0:t.aliases;return{metadata:e,aliases:n}})):new Promise((function(r){return r({metadata:e,aliases:void 0})}))}n&&o.push(n)})),[4,Promise.all(o)];case 2:return null==(i=s.sent())||i.forEach((function(e){var r=null==e?void 0:e.metadata,n=((null==e?void 0:e.aliases)||[]).reduce((function(e,t){var n;return 0!==MsPortalFx.localeCompareIgnoreCase(r.resourceTypeProperty,t.defaultPath)||e.includes(t.name)?null===(n=t.paths)||void 0===n||n.forEach((function(n){n.apiVersions.includes(r.apiVersion)&&0===MsPortalFx.localeCompareIgnoreCase(r.resourceTypeProperty,n.path)&&!e.includes(t.name)&&e.push(t.name)})):e.push(t.name),e}),[]);if(n.length){var o=!1;if(n.forEach((function(e){var n="".concat(r.resourceType,"-").concat(e);Object.getOwnPropertyNames(t).includes(n)&&(o=!0)})),!o){var i=m(r.resourceType,n[0]);t[i]={apiVersion:r.apiVersion,resourceType:r.resourceType,resourceTypeProperty:r.resourceTypeProperty,resourceTypePropertyAlias:n[0]}}}})),[2,t]}}))}))}var h={};function m(e,r){return"".concat(e,"-").concat(r)}var _={};function b(e,r){return Math.abs(e-r)}function P(e,r,t,n,o){return __awaiter(this,void 0,void 0,(function(){var i,a,l,u,d,p,f,v,g,y,h,m,P,T=this;return __generator(this,(function(x){switch(x.label){case 0:return t&&(null==e?void 0:e.resourceScopeId)&&(t.scope=e.resourceScopeId),i=MsPortalFx.isNullOrUndefined(r),a=void 0,l="tags"===(null===(m=null==r?void 0:r.field)||void 0===m?void 0:m.toLowerCase())&&1===(null===(P=r.values)||void 0===P?void 0:P.length)&&(MsPortalFx.isNullOrWhiteSpace(r.values[0])||r.values[0].startsWith("{")),u=[],d={},l?(p=r.values[0]||"{}",d=JSON.parse(p),(a=[]).push({field:r.field,values:[]}),Object.getOwnPropertyNames(d).forEach((function(e){var t="".concat(r.field,".").concat(e);u.push(t.toLowerCase()),a.push({field:t,values:[d[e]]})})),Object.assign(t.resourceContent,{tags:d})):i||(a=[]).push(r),f="".concat(JSON.stringify(e),"-").concat(JSON.stringify(a),"-").concat(JSON.stringify(t)),v=Date.now(),g=!0,y=function(e,r){var t,n=_[e];if(n){var o=b(r,n.timeCacheKey);Math.floor(o/1e3/60)<5&&(t=n.promise)}return t}(f,v),h={pendingFields:a,resourceDetails:t},y||(g=!1,y=__awaiter(T,void 0,void 0,(function(){var r,t,o,a,p,f,g,y,m,_,P,T,x;return __generator(this,(function(R){switch(R.label){case 0:return R.trys.push([0,2,,3]),[4,c("POST","".concat(e.scopeId,"/providers/Microsoft.PolicyInsights/checkPolicyRestrictions?api-version=2020-07-01"),"arm.policy",h)];case 1:if(r=R.sent(),P=b(v,Date.now()),t=void 0,l)for(null===(T=r.fieldRestrictions)||void 0===T||T.forEach((function(e){for(var r,t=e.restrictions.length-1;t>=0;t--){var n=e.restrictions[t];0===MsPortalFx.localeCompareIgnoreCase(n.result,"Required")&&u.includes(null===(r=e.field)||void 0===r?void 0:r.toLowerCase())&&n.values.includes(d[e.field])&&e.restrictions.splice(t,1)}})),null===(x=r.fieldRestrictions)||void 0===x||x.forEach((function(e){var r;o||(o={});var t=e.field.startsWith("tags.")?e.field.substring(5):e.field;o[t]||(o[t]=[]),null===(r=e.restrictions)||void 0===r||r.forEach((function(e){!("defaultValue"in e)&&0===MsPortalFx.localeCompareIgnoreCase(e.result,"Required")&&e.values&&o[t].push(e.values)}))})),t={},a=0,p=s(o);a<p.length;a++)f=p[a],g=f[0],(y=f[1]).every((function(e){return void 0===e}))?t[g]=[""]:(m=y.filter(Boolean).reduce((function(e,r){return e.filter((function(e){return r.includes(e)}))})),t[g]=m);return[2,{resourceTypeSubProperty:n,suggestedTagDefaultValue:t,isTagsScenario:l,policyCheckResponse:r,duration:P,isPendingFieldsUndefined:i,error:null}];case 2:return _=R.sent(),P=b(v,Date.now()),[2,{resourceTypeSubProperty:n,policyCheckResponse:null,duration:P,isPendingFieldsUndefined:i,isTagsScenario:!1,error:_}];case 3:return[2]}}))})),_[f]={timeCacheKey:v,promise:y}),o.content=h,o.cached=g,[4,y];case 1:return[2,x.sent()]}}))}))}})),
define("Fx/ResourceManagement/ControlPlaneValidators",["require","exports","Fx/Telemetry","Fx/Controls/Section","Fx/Controls/InfoBox","Fx/ResourceManagement","FxInternal/Resources/ControlPlaneValidatorsResources","FxInternal/ResourceManagement/Policy/PolicyDataCore"],(function(e,r,t,n,o,i,s,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ControlPlaneValidators=void 0;var l=function(){function e(e,r){this._container=e,this._bladeName=r.bladeName,this._inContextPane=r.inContextPane||!1,this._resourceScopeId=r.resourceScopeId;var t=r;if(t.subscriptionObservable&&t.resourceGroupObservable)this._scopeId=this._getScopeIdForResourceGroupDeployment(this._container,t);else{var n=r.scopeId;this._scopeId=ko.isObservable(n)?n:ko.observable(n)}}return e.policyEvaluator=function(e,r){return __awaiter(this,void 0,void 0,(function(){var t,n,o,i;return __generator(this,(function(s){switch(s.label){case 0:return((t=r.additionalTelemetry)||(t={})).__mode=u.ControlPlaneModes.PolicyEvaluator,r=__assign(__assign({},r),{additionalTelemetry:t}),[4,(0,a.getPolicyJourney)(r)];case 1:return n=s.sent(),o=r.inContextPane||!1,i=c(n,e,r.bladeName,r.additionalTelemetry),[2,__assign(__assign({},n),{allErrorResults:i,customHtml:d(i,o,!1)})]}}))}))},e.prototype.policyValidator=function(e){var r=this,t=e.additionalTelemetry;(t||(t={})).__mode=u.ControlPlaneModes.Validator;var n=e.allowEmptyValues;MsPortalFx.isNullOrUndefined(n)&&(n=!1),e=__assign(__assign({},e),{allowEmptyValues:n,additionalTelemetry:t});var o=[],i=function(r){var t=void 0===r?e.control.value():r,n=e.convertValue?e.convertValue(t):t,o=[];return MsPortalFx.isNullOrUndefined(n)||"string"==typeof n&&MsPortalFx.isNullOrWhiteSpace(n)||function(e){var r=!1;MsPortalFx.isNullOrUndefined(e)||"string"!=typeof e||(r=e.startsWith("[")&&e.endsWith("]"));return r}(n)||o.push(n),o};this._scopeId.subscribeAndRun(this._container,(function(){var r=!!e.allowEmptyValues||i().length>0;o.length&&e.control&&r&&e.control.triggerValidation()}));var s=new MsPortalFx.ViewModels.CustomValidation("",(function(t){return __awaiter(r,void 0,void 0,(function(){var r,n,o,s;return __generator(this,(function(l){switch(l.label){case 0:return r=i(t),this._scopeId()?[4,(0,a.getPolicyJourney)({scope:{scopeId:this._scopeId(),resourceScopeId:this._resourceScopeId},resolvedValuesToField:r,bladeName:this._bladeName,resourceTypeMetadata:e.resourceTypeMetadata,allowEmptyValues:e.allowEmptyValues,additionalTelemetry:e.additionalTelemetry})]:[3,2];case 1:return n=l.sent(),o=0===n.allErrorResults.length,s="",n.allErrorResults.length&&(s=d(c(n,this._container,this._bladeName,e.additionalTelemetry),this._inContextPane,!1)),[2,{valid:o,message:s}];case 2:return[2,{valid:!0}]}}))}))}));return o.push(s),o},e.prototype.policySelector=function(e){var r=this,t=e.additionalTelemetry;(t||(t={})).__mode=u.ControlPlaneModes.Selector;var n=e.allowEmptyValues;MsPortalFx.isNullOrUndefined(n)&&(n=!1),e=__assign(__assign({},e),{allowEmptyValues:n,additionalTelemetry:t});var o=new f(this._container,e,this._bladeName,this._inContextPane,d),i=function(){var t=o.getAllowedValues();(0,a.getPolicyJourney)({scope:{scopeId:r._scopeId(),resourceScopeId:r._resourceScopeId},resolvedValuesToField:t,bladeName:r._bladeName,resourceTypeMetadata:e.resourceTypeMetadata,allowEmptyValues:e.allowEmptyValues,additionalTelemetry:e.additionalTelemetry}).then((function(t){var n=c(t,r._container,r._bladeName,e.additionalTelemetry);o.setDeniedValues(t.deniedValues,n)}))};this._scopeId.subscribeAndRun(this._container,(function(){i()})),o.getItemsObservable().subscribeAndRun(this._container,(function(){i()}))},e.prototype._getScopeIdForResourceGroupDeployment=function(e,r){var t=r.subscriptionObservable,n=r.resourceGroupObservable,o=ko.observable(),i=function(){var e,r,i,s=t(),a=n(),l=null==s?void 0:s.subscriptionId,u="",c=0===(null==a?void 0:a.mode)&&!(null===(r=null===(e=null==a?void 0:a.value)||void 0===e?void 0:e.resourceId)||void 0===r?void 0:r.includes(l))?"":null===(i=null==a?void 0:a.value)||void 0===i?void 0:i.name;u=l&&c?"/subscriptions/".concat(l,"/resourceGroups/").concat(c):"",o()!==u&&o(u)};return t.subscribe(e,(function(){i()})),n.subscribe(e,(function(){i()})),i(),o},e}();r.ControlPlaneValidators=l;var u={ControlPlanePolicy:"ControlPlanePolicy",PolicyBladeLinkClicked:"PolicyBladeLinkClicked",PolicySelectorChangedSelection:"PolicySelectorChangedSelection",ControlPlaneModes:{PolicyEvaluator:"PolicyEvaluator",Validator:"Validator",Selector:"Selector"},PolicySelector:{AutoSelected:"AutoSelected",Cleared:"Cleared"}};function c(e,r,t,n){return e.allErrorResults.map((function(e){var o=e.reason,a=e.policyAssignmentId,l=i.ArmId.getResourceNames(i.ArmId.parse(a,!0)).slice(-1)[0];return{policyAssignmentName:l,resourceLink:function(){var e=new FxImpl.Composition.Selectable.PdlBladeReference("PolicyAssignmentDetailBlade","Microsoft_Azure_Policy",{parameters:{id:a},onClosed:function(){}});p(u.PolicyBladeLinkClicked,t,{},n),r.openBlade(e)},linkDisplayName:"(".concat(s.Azure.Validators.Policy.clickDetails,")"),noLinkDisplayName:"(".concat(s.Azure.Validators.Policy.policyDetailsFormat.format(l),")"),reason:o+" ",sysViolation:l.startsWith("sys")}}))}function d(e,r,t){var n,o,i,s,a,l=e.find((function(e){return e.sysViolation}));return l?{htmlTemplate:'<span role="alert">'.concat((n=l.reason,o=/https:\/\/\S+/g,i=n.split(o),s=n.match(o)||[],a=[],i.forEach((function(e,r){a.push("<span>".concat(e,"</span>")),r<s.length&&a.push('<a href="https://'.concat(s[r],'">').concat(s[r],"</a>"))})),a.join("")),"</span></span>")}:t?{htmlTemplate:'\x3c!-- ko foreach: allErrorResults --\x3e<span role="status" style="font-size: 12px; margin-left: 30px"><span data-bind="text: reason"></span>'+(r?'<div data-bind="text: noLinkDisplayName" style="margin-left: 30px"></div>':'<a data-bind="fxclick: resourceLink, text: linkDisplayName"></a>')+"</span><br/>\x3c!-- /ko --\x3e",viewModel:{allErrorResults:e}}:{htmlTemplate:'\x3c!-- ko foreach: allErrorResults --\x3e<span role="alert"><span data-bind="text: reason"></span>'+(r?'<div data-bind="text: noLinkDisplayName"></div>':'<a data-bind="fxclick: resourceLink, text: linkDisplayName"></a>')+"</span>\x3c!-- /ko --\x3e",viewModel:{allErrorResults:e}}}function p(e,r,n,o){(0,t.trace)({action:e,source:u.ControlPlanePolicy,data:__assign(__assign({},n),{additionalTelemetry:o,bladeName:r})})}var f=function(){function e(e,r,t,o,i){var s=this;if(this._container=e,this._options=r,this._bladeName=t,this._inContextPane=o,this._getCustomHtml=i,this._section=n.create(this._container),this._section.children.subscribeAndRun(this._container,(function(){s._section.visible(s._section.children().length>0)})),this._options.control.subLabel){var a={htmlTemplate:'<div data-bind="pcControl: section"></div>',viewModel:{section:this._section}};this._options.control.subLabel(a)}}return e.prototype.getItemsObservable=function(){return this._options.control.items},e.prototype.getAllowedValues=function(){var e=this,r=[];return this.getItemsObservable()().forEach((function(t){var n=e._options.convertValue(t.value);MsPortalFx.isNullOrUndefined(n)||r.push(n)})),r},e.prototype.setDeniedValues=function(e,r){var t=this,n=0,i=e.map((function(e){return(0,a.convertItemWithSubPropertyToStringLC)(e,"")}));if(this.getItemsObservable()().forEach((function(e){if(ko.isObservable(e.disabled)){var r=t._options.convertValue(e.value),o=(0,a.convertItemWithSubPropertyToStringLC)(r,"");!MsPortalFx.isNullOrWhiteSpace(o)&&i.includes(o)?(e.disabled(!0),n++,t._options.control.value()===e.value&&(t._options.control.value(null),p(u.PolicySelectorChangedSelection,t._bladeName,{event:u.PolicySelector.Cleared},t._options.additionalTelemetry))):e.disabled(!1)}})),n){var l=this.getItemsObservable()().filter((function(e){return ko.isObservable(e.disabled)&&!e.disabled()})),c=1===l.length?s.Policy.AutoSelect.info:s.Policy.ItemsAvailability.info,d={htmlTemplate:'<div data-bind="pcControl: infoBox" style="max-width: 480px; margin: 4px 0px 0px 0px;"></div>',viewModel:{infoBox:o.createInline(this._container,{text:"".concat(c," "),style:1})}},f=this._getCustomHtml(r,this._inContextPane,!0);this._section.children([d,f]),1===l.length&&([null,void 0].includes(this._options.control.value())&&(this._options.control.value(l[0].value),p(u.PolicySelectorChangedSelection,this._bladeName,{event:u.PolicySelector.AutoSelected},this._options.additionalTelemetry)),this._options.control.disabled(!0))}else this._section.children([]),this._options.control.disabled(!1)},e}()})),
define("FxInternal/ResourceManagement/Policies",["require","exports","Fx/DependencyInjection","Fx/Composition/Blade","FxInternal/Composition/ViewModel","Fx/Controls/Validations","Fx/Ajax","FxHubs/ArmHelpers/ArmApis","Fx/Composition","Fx/Telemetry","Fx/ResourceManagement","Fx","Fx/ResourceManagement/ControlPlaneValidators","Fx"],(function(e,r,t,n,o,i,s,a,l,u,c,d,p,f){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ProvisioningBladeDefaultPolicyAPI=r.PolicyValidationFactoryImpl=void 0,r.createPolicyValidationFactory=function(e){return new w(e)},r.getDefaultControlPlaneFromContainer=C,r.getProvisioningBladeDiContainer=A,r.setProvisioningBladeDiContainer=function(e,r){e[R]=r};var v=MsPortalFx.Resources.Strings.Azure.Validators.Policy,g=v.clickDetails,y=v.enforcement,h=v.fieldValueDenied,m=v.valueDenied,_=v.fieldRequired,b=v.fieldValueRequired,P=v.valueRequiredWithValue,T=v.valueRequired,x={timeout:750,method:"notifyWhenChangesStop"},R="_fx_di";var F=function(e){function r(r,t,n,o){var i=e.call(this,t,n)||this;i.triggerSubscribable=o,i.valueSubscribable=ko.observable();var s=i.valueSubscribable.subscribe(r,(function(e){return i.validate(e)})),a=ko.observable();return Object.defineProperty(i,"value",{get:a,set:a}),ko.computed(r,(function(){return i.value&&i.value()}),null).subscribe(r,(function(e){s.dispose(),i.validate.apply(i,[e,!0])})),i}return __extends(r,e),r}(i.CustomV);function C(e){var r,t=null===(r=A(e))||void 0===r?void 0:r.get(V);if(!(null==t?void 0:t.controlPlaneUsed))return null==t?void 0:t.controlPlane}function A(e){return e[R]}var w=function(){function e(e){var r=this;this._ltm=e,this.resourceType=ko.observable(""),this.addDefaults=!0,this._valueFunctors=ko.observableArray(),this._pendingFunctors=ko.observable({}),this._pendingFunctorGenerators=ko.observableArray(),this._onResponse=MsPortalFx.noop,this._onError=MsPortalFx.noop,this._validations=[],this._firstValidationStarted=ko.observable(!1),this._lastFailedValidationsMap=new WeakMap,this._lastValidationTriggerMap=new WeakMap,this._debounceObs=ko.observable(),this._debounce=function(e,r){void 0===r&&(r=20);var t=0;return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];clearTimeout(t),t=setTimeout((function(){return e.apply(void 0,n)}),r)}}(this._debounceObs,1.1*x.timeout),this._policyCheck=ko.computed(this._ltm,{read:function(){var e;r._validations.forEach((function(e){return r._lastFailedValidationsMap.get(e)&&r._lastValidationTriggerMap.get(e)({self:!0})}));var t="",n=r._valueFunctors().reduce((function(e,r){var n=r.changedValue,o=(0,r.buildResourceDetails)(e,n());return"requestScope"in o?(t=o.requestScope,o.resourceDetails):o}),{});r.resourceType(null===(e=null==n?void 0:n.resourceContent)||void 0===e?void 0:e.type);var o=__assign(__assign({},r._pendingFunctors()),r._pendingFunctorGenerators().reduce((function(e,r){var t=r.changedValue,n=r.generatedFields;return e=r.pendingValuesGenerator(t()).reduce((function(e,r){var n,o=__assign({valueToField:MsPortalFx.identity},r),i=o.field,s=__rest(o,["field"]);return e=__assign(__assign({},e),((n={})[i]=__assign({changedValue:t},s),n))}),e),n(Object.keys(e).map((function(r){var t=e[r];return{field:r,fieldToDisplay:t.fieldToDisplay,valueToField:t.valueToField}}))),e}),{})),i={resourceDetails:n,pendingFields:Object.keys(o).reduce((function(e,r){var t=o[r],n=t.changedValue,i=t.valueToField,s=t.values,a=n();return e.push(__assign(__assign({},i?{values:(void 0!==a?[a]:[]).concat(s?s():[]).map(i)}:{}),{field:r})),e}),[])};return i.scope=t,i=r._customizeRequest?r._customizeRequest(i):i,JSON.stringify(i)},deferEvaluation:!0}).extend({rateLimit:x}),this._validate=ko.computed(this._ltm,{read:function(){return __awaiter(r,void 0,void 0,(function(){var e,r,t,n,o,i,l,u,c=this;return __generator(this,(function(d){switch(d.label){case 0:if(f.nextTick((function(){return c._firstValidationStarted(!0)})),this._promiseFulfilled=!1,e=ko.unwrap(this._policyCheck),!(r=e&&JSON.parse(e)).resourceDetails.scope||!(null===(u=r.resourceDetails.resourceContent)||void 0===u?void 0:u.type)||!r.resourceDetails.apiVersion)return t={contentEvaluationResult:{policyEvaluations:[]},fieldRestrictions:[]},this._promiseFulfilled=!0,[2,new Promise((function(e){return e({response:t,request:r})}))];d.label=1;case 1:return d.trys.push([1,3,,4]),n=r.scope,o=__rest(r,["scope"]),[4,(0,s.batch)({uri:(0,a.getCheckPolicyRestrictionsApi)(n||r.resourceDetails.scope),type:"POST",content:o,setTelemetryHeader:"FieldPolicyCheck"})];case 2:return i=d.sent().content,this._onResponse(MsPortalFx.clone(i,!0)),this._promiseFulfilled=!0,[2,{response:i,request:r}];case 3:return l=d.sent(),this._promiseFulfilled=!0,this._onError(l),[2,{response:{contentEvaluationResult:{policyEvaluations:[]},fieldRestrictions:[]},request:r}];case 4:return[2]}}))}))},deferEvaluation:!0})}return e.createControlPlaneValidator=function(e){var r=e.container,t=e.control,n=e.resourceTypeProperty,o=e.convertValue,i=C(r);if(i&&n){var s=A(r).get(V).policyScope,a=MsPortalFx.memoize((function(e){var r=JSON.parse(e),s=r[0],a=r[1];return i.policyValidator({resourceTypeMetadata:{resourceType:s,apiVersion:a,resourceTypeProperty:n,resourceTypePropertyAlias:""},convertValue:o,control:t})}));return ko.computed(r,(function(){return s.resourceTypesWithApiVersion().reduce((function(e,r){var t=r[0],n=r[1];return __spreadArray(__spreadArray([],e,!0),a(JSON.stringify([t,n])),!0)}),[])}))}},e.getDisabledValues=function(e){return __awaiter(this,arguments,void 0,(function(e){var r,t,n,i,s,a,l,u,d,f,v,g,y,h,m,_,b=this,P=e.container,T=e.convertValue,x=e.values,R=e.resourceTypeProperty;return __generator(this,(function(e){switch(e.label){case 0:return r=A(P),(t=null==r?void 0:r.get(V))?(n=t.policyScope,i=null===(m=null==n?void 0:n.subscription())||void 0===m?void 0:m.subscriptionId,s=(null==n?void 0:n.resourceGroup())||{},a=s.value,l=s.mode,u=0===l&&!(null===(_=null==a?void 0:a.resourceId)||void 0===_?void 0:_.includes(i)),d=u?"":null==a?void 0:a.name,g=(v=!(f=1===l&&d)&&d)?4:1,y=i?c.ArmId.stringify({subscription:i,resourceGroup:d,kind:g}):"",h=!v&&f&&c.ArmId.stringify({subscription:i,resourceGroup:d,kind:4}),[4,n.resourceTypesWithApiVersion().reduce((function(e,t){return __awaiter(b,[e,t],void 0,(function(e,t){var n,i=t[0],s=t[1];return __generator(this,(function(t){switch(t.label){case 0:return[4,p.ControlPlaneValidators.policyEvaluator(P,{scope:{scopeId:y,resourceScopeId:h},resolvedValuesToField:x.map(T),resourceTypeMetadata:{resourceType:i,apiVersion:s,resourceTypeProperty:R,resourceTypePropertyAlias:""},bladeName:r.get(o.PartContext).id})];case 1:return n=t.sent(),[4,e];case 2:return[2,t.sent().concat(n.deniedValues)]}}))}))}),Promise.resolve([]))]):[2,[]];case 1:return[2,e.sent()]}}))}))},e.prototype.setOptions=function(e){var r=e.customizeRequest,t=e.enableDefaults,n=e.onResponse,o=void 0===n?function(){}:n,i=e.onError,s=void 0===i?function(){}:i;void 0!==t&&(this.addDefaults=t),this._customizeRequest=r,this._onResponse=o,this._onError=s},e.prototype.createFieldValidation=function(e){var r,t=this;this.addDefaults=!!e.enableDefaults;var n=MsPortalFx.extend(ko.observable(),{pauseNotifications:!1,notifySubscribers:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.pauseNotifications||ko.subscribable.fn.notifySubscribers.apply(this,e)},sneakyUpdate:function(e){this.pauseNotifications=!0,this(e),this.pauseNotifications=!1}});if(n.extend({notify:"always",equalityComparer:function(){return!0}}),"buildResourceDetails"in e){var o=e.buildResourceDetails;this._valueFunctors.push({buildResourceDetails:o,changedValue:n})}if("pendingValues"in e){var i=e.pendingValues,s=__assign({valueToField:MsPortalFx.identity},i),a=s.field,d=__rest(s,["field"]);this._pendingFunctors(__assign(__assign({},this._pendingFunctors()),((r={})[a]=__assign({changedValue:n},d),r)))}var p=ko.observableArray();if("pendingValuesGenerator"in e){var f=e.pendingValuesGenerator;this._pendingFunctorGenerators(__spreadArray(__spreadArray([],this._pendingFunctorGenerators(),!0),[{changedValue:n,generatedFields:p,pendingValuesGenerator:f}],!1))}var v=ko.observable(),x=ko.observable(),R=ko.observable({}),C=new F(this._ltm,"",(function(r,o){var i=R().self;if(o)return n.sneakyUpdate(r),R().self=!1,Promise.resolve({valid:!0,message:""});if(i?n.sneakyUpdate(r):n(r),R().self=!1,"pendingValues"in e||"pendingValuesGenerator"in e){var s=e.pendingValues,a=__assign({valueToField:MsPortalFx.identity},s),d=a.values,f=a.field,v=a.valueToField,x=a.fieldToDisplay;return t._debounce({}),t._debounceObs.fxAwait(t._ltm).then((function(){return t._validate()})).then((function(e){var n=e.response,o=e.request;if(!n.fieldRestrictions.length)return Promise.resolve({valid:!0});var i=p().concat(f?{field:f,fieldToDisplay:x,valueToField:v}:[]).reduce((function(e,r){var t=r.fieldToDisplay,n=r.valueToField;return e[r.field]={fieldToDisplay:t,valueToField:n},e}),{}),s=Object.keys(i),a=function(e){return!s.includes(e)&&s.includes("tags")&&e.startsWith("tags.")?"tags":e},R=((null==n?void 0:n.fieldRestrictions)||[]).map((function(e){return e.field})).filter((function(e){return s.includes(e)||s.includes("tags")&&e.startsWith("tags.")})),F=((null==n?void 0:n.fieldRestrictions)||[]).filter((function(e){return R.includes(e.field)})).map((function(e){return{field:e.field,restrictions:e.restrictions}})),A=F.filter((function(e){var t=a(e.field);return!!MsPortalFx.find((null==e?void 0:e.restrictions)||[],(function(e){var n;return i[t].valueToField&&(null===(n=e.values)||void 0===n?void 0:n.includes(i[t].valueToField(r)))}))})),w=A.map((function(e){var t=a(e.field),n=e.restrictions.filter((function(e){return"Deny"===e.result&&i[t].valueToField&&e.values.includes(i[t].valueToField(r))}))[0];return n&&{field:e.field,restriction:n}})).filter(MsPortalFx.identity),V=F.map((function(e){var r=e.restrictions.filter((function(e){return"Required"===e.result&&!("defaultValue"in e)}))[0];return r&&{field:e.field,restriction:r}})).filter(MsPortalFx.identity),k=w.map((function(e){var t={bladeReference:l.BladeReferences.forExtension("Microsoft_Azure_Policy").forBlade("PolicyAssignmentDetailBlade").createReference({parameters:{id:e.restriction.policy.policyAssignmentId},onClosed:function(){}}),telemetryName:"Policy Click"},n=e.field,o=e.restriction,s=a(n),u=c.ArmId.parse(e.restriction.policy.policyDefinitionId,!0).resourceName,d=g.format(u),p=m.format(i[s].valueToField(r));if(i[s]&&i[s].fieldToDisplay){var f=i[s].fieldToDisplay(n,r,o.result),v=f.displayField,y=f.displayValue;p=h.format(v,y||i[s].valueToField(r))}return{resourceLink:t,rejected:p,display:d}})),M=V.map((function(e){var t={bladeReference:l.BladeReferences.forExtension("Microsoft_Azure_Policy").forBlade("PolicyAssignmentDetailBlade").createReference({parameters:{id:e.restriction.policy.policyAssignmentId},onClosed:function(){}}),telemetryName:"Policy Click"},n=e.field,o=e.restriction,s=a(n),u=c.ArmId.parse(e.restriction.policy.policyDefinitionId).resourceName,d=g.format(u),p=o.values&&(o.values.length>1?"(".concat(o.values.join(", "),")"):o.values[0]),f=p?P.format(p):T;if(i[s]&&i[s].fieldToDisplay){var v=i[s].fieldToDisplay(n,r,o.result).displayField;f=p?b.format(v,p):_.format(v)}return{resourceLink:t,rejected:f,display:d}})),S=__spreadArray(__spreadArray([],k,!0),M,!0),E=__spreadArray(__spreadArray([],w,!0),V,!0);E.length&&u.trace({source:"PolicyCheckFactory",action:E.map((function(e){return e.restriction.result})).join(","),data:__assign({field:f,resourceLinks:S,values:d},v?{setValue:v(r)}:{})});var I=S[0],D=S[1],O=o.resourceDetails.resourceContent,N={htmlTemplate:"<span>".concat(y,'<span data-bind="text: resourceNameOrType"></span></span>')+'\x3c!-- ko ifnot: restrictionResults --\x3e<br/><span><span data-bind="text: firstRestrictionResult.rejected"></span><br/><a data-bind="fxclick: firstRestrictionResult.resourceLink, text: firstRestrictionResult.display"></a></span>\x3c!-- /ko --\x3e\x3c!-- ko if: restrictionResults --\x3e<ul data-bind="foreach: restrictionResults"><li><span><span data-bind="text:rejected"></span> <br/><a data-bind="fxclick: resourceLink, text: display"></a></span></li></ul>\x3c!-- /ko --\x3e',viewModel:{resourceNameOrType:O.name?" ".concat(O.name," : ").concat(O.type):" ".concat(O.type),firstRestrictionResult:I,restrictionResults:D&&S}};return t._lastFailedValidationsMap.set(C,!!S.length),Promise.resolve({valid:!S.length,message:S.length?N:""})}))}return Promise.resolve({valid:!0,message:""})}),R);return this._lastFailedValidationsMap.set(C,!1),this._lastValidationTriggerMap.set(C,R),this._validations.push(C),{value:C.valueSubscribable,validation:C,pendingResultValues:"pendingValues"in e?ko.computed(this._ltm,{read:function(){if(!t._firstValidationStarted())return{denied:[],removed:[],required:[],getPolicyAssignments:function(e){return[]}};var r=t._validate();return t._promiseFulfilled||r.then((function(r){var t=r.response.fieldRestrictions.find((function(r){return r.field===e.pendingValues.field}));v({denied:null==t?void 0:t.restrictions.reduce((function(e,r){return"Deny"===r.result?e.concat(r.values||[]):e}),[]),removed:null==t?void 0:t.restrictions.reduce((function(e,r){return"Removed"===r.result?e.concat(r.values||[]):e}),[]),required:null==t?void 0:t.restrictions.reduce((function(e,r){return"Required"===r.result?e.concat(r.values||[]):e}),[]),getPolicyAssignments:function(e){return null==t?void 0:t.restrictions.reduce((function(r,t){return(t.values||[]).includes(e)?r.concat(t.policy.policyAssignmentId):r}),[])}})})),v()||{denied:[],removed:[],required:[],getPolicyAssignments:function(e){return[]}}},deferEvaluation:!0}):void 0,generatedPendingResultValues:"pendingValuesGenerator"in e?ko.computed(this._ltm,{read:function(){if(!t._firstValidationStarted())return{};var e=t._validate();return t._promiseFulfilled||e.then((function(e){var r=e.response,t=p().map((function(e){return e.field})),n=r.fieldRestrictions.filter((function(e){return t.includes(e.field)}));x(n.reduce((function(e,r){return e[r.field]={denied:null==r?void 0:r.restrictions.reduce((function(e,r){return"Deny"===r.result?e.concat(r.values||[]):e}),[]),removed:null==r?void 0:r.restrictions.reduce((function(e,r){return"Removed"===r.result?e.concat(r.values||[]):e}),[]),required:null==r?void 0:r.restrictions.reduce((function(e,r){return"Required"===r.result?e.concat(r.values||[]):e}),[]),getPolicyAssignments:function(e){return null==r?void 0:r.restrictions.reduce((function(r,t){return(t.values||[]).includes(e)?r.concat(t.policy.policyAssignmentId):r}),[])}},e}),{}))})),x()||{}},deferEvaluation:!0}):void 0}},e.prototype.createChildFactory=function(r){var t=new e(this._ltm);return r.copyBuildResourceDetails&&t._valueFunctors(__spreadArray([],this._valueFunctors(),!0)),t},e}();r.PolicyValidationFactoryImpl=w;var V=function(){function r(e){this.di=e,this.policyApiFlag="cuid",this.policyValidationFactoryUsed=!1,this.policyScope={resourceGroup:ko.observable(),subscription:ko.observable(),resourceTypesWithApiVersion:ko.observableArray()},this.policyFactory=new w(e.get(n.Container));var r=this.policyScope,t=e.get(o.PartContext);this.controlPlane=new p.ControlPlaneValidators(e.get(n.Container),{resourceGroupObservable:r.resourceGroup,subscriptionObservable:r.subscription,bladeName:null==t?void 0:t.id})}return Object.defineProperty(r.prototype,"controlPlaneUsed",{get:function(){(0,d.isFeatureEnabled)("nofxpolicyaware")&&delete this.policyApiFlag;var e=Object.keys(requirejs.executedDefines).filter((function(e){return e.endsWith("/ControlPlaneData")}));e[0];return!!e[1]},enumerable:!1,configurable:!0}),r=__decorate([__metadata("fx:diagnostics",[e,"ProvisioningBladeDefaultPolicyAPI"]),t.Class("viewModel"),__metadata("design:paramtypes",[t.Container])],r)}();r.ProvisioningBladeDefaultPolicyAPI=V})),
define("FxInternal/Controls/TagsByResource",["require","exports","FxInternal/Controls/Base/Base","FxInternal/Utils/ValidationHelper","Fx/Controls/DropDown","FxInternal/ResourceManagement/Policies","FxHubs/ArmHelpers/ArmResourceGroups","Fx/Resources/ResourceManagement"],(function(e,r,t,n,o,i,s,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ViewModel=void 0;var l=MsPortalFx.Resources.Strings.Azure.ResourceGroups,u=function(e){function r(r,t){var n=e.call(this,r)||this;n.controlType=136,n.value=MsPortalFx.isObservableArray(t.value)?t.value:ko.observableArray(t.value||[]),n._msPortalFxPrivates={triggerValidation:ko.observable()},n.validations=MsPortalFx.initObservableArray(t.validations,[]);var u=(0,i.getProvisioningBladeDiContainer)(r),c=null==u?void 0:u.get(s.ProvisioningResourceGroupTags),d=ko.observableArray();n.resources=d,(null==c?void 0:c.tagsExp)&&n.value.subscribeAndRun(r,(function(e){c.tags=e})),ko.computed(r,(function(){return[ko.unwrap(t.resources),ko.unwrap(null==c?void 0:c.newResourceGroupName)]})).subscribeAndRun(r,(function(e){var r=e[0],t=e[1];if((null==c?void 0:c.tagsExp)&&t){var n=r.find((function(e){if("resourceType"in e)return e.resourceType.toLowerCase()===c.rgResourceType}));d(n?__spreadArray([],r,!0):__spreadArray(__spreadArray([],r,!0),[{resourceType:c.rgResourceType,displayName:a.resourceTitleWithParts.format(l.DropDown.defaultLabel,t),count:1}],!1))}else d(__spreadArray([],r,!0))}));var p=null==u?void 0:u.get(i.ProvisioningBladeDefaultPolicyAPI),f={},v=ko.observableArray([]);(0,i.getDefaultControlPlaneFromContainer)(r)&&ko.computed(r,(function(){return[ko.unwrap(p.policyScope.resourceTypesWithApiVersion),ko.unwrap(d)]})).subscribeAndRun(r,(function(e){var r=e[0],t=e[1];(r=__spreadArray(__spreadArray([],r,!0),c?[[c.rgResourceType,"2020-06-01"]]:[],!0)).filter((function(e){var r=e[0];return t.find((function(e){if("resourceType"in e)return r===e.resourceType}))})).reduce((function(e,r){var t,o=r[0],i=r[1];return e[o]=e[o]||(null===(t=p.controlPlane)||void 0===t?void 0:t.policyValidator({control:n,resourceTypeMetadata:{resourceType:o,apiVersion:i,resourceTypeProperty:"tags",resourceTypePropertyAlias:""},convertValue:function(e){return JSON.stringify(e.reduce((function(e,r){return r.id.toLowerCase()===o.toLowerCase()&&r.tags.reduce((function(e,r){return e["".concat(r.name)]=r.value,e}),e),e}),{}))}})),e}),f),v(r.reduce((function(e,r){var t=r[0];return e.push.apply(e,f[t]||[]),e}),[]))}));var g=ko.observableArray();ko.computed(r,(function(){return __spreadArray(__spreadArray(__spreadArray([],ko.unwrap(t.validations)||[],!0),[],!0),v()||[],!0)})).subscribeAndRun(r,g);var y=ko.observableArray(),h=ko.observable();return n.value.subscribeAndRun(r,(function(e){y([{text:"",value:e}]),h(e)})),n.hiddenCtrl=(0,o.create)(r,{validations:g,value:h,items:y}),n.dirty=ko.observable(!1),n.disabled=ko.observable(!1),n.valid=ko.observable(!0),n.customSubscriptionIds=MsPortalFx.initObservableArray(t.customSubscriptionIds,[]),n.buttonCommands=t.buttonCommands,n.menuCommands=t.menuCommands,n.hideResourceColumn=ko.isObservable(t.hideResourceColumn)?t.hideResourceColumn:ko.observable(t.hideResourceColumn),n.maxTagsReached=ko.observable(!1),n.triggerValidation=n._triggerValidation,n.resourceTagsAsMap=n._resourceTagsAsMap,n}return __extends(r,e),r.prototype._triggerValidation=function(){return(0,n.triggerValidation)({vm:this,ltm:this.lifetimeManager,msPortalFxTriggerValidation:this._msPortalFxPrivates.triggerValidation})},r.prototype._resourceTagsAsMap=function(e){var r=e.id||e.resourceType,t=this.value(),n=MsPortalFx.find(t,(function(e){return e.id===r})),o=n&&n.tags||[];return MsPortalFx.extendArrayIntoMap(Object.create(null),o.slice(),(function(e){return e.name}),(function(e){return e.value}))},r}(t.ViewModel);r.ViewModel=u})),
define("Fx/Controls/TagsByResource",["require","exports","FxInternal/Controls/TagsByResource"],(function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.create=function(e,r){var n;return ko.ignoreDependencies((function(){n=new t.ViewModel(e,r)})),n}})),
define("FxHubs/ArmHelpers/ArmTags",["require","exports","Fx/ResourceManagement","FxHubs/ArmClient","Fx/Ajax","FxHubs/ArmHelpers/ArmIds","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/Resources/FxHubsClientStrings","Fx","FxInternal","Fx/Composition","Fx/Notifications"],(function(e,r,t,n,o,i,s,a,l,u,c,d){"use strict";var p,f,v;Object.defineProperty(r,"__esModule",{value:!0}),r.DEV=void 0,r.patchInstancesToArm=S,r.handleTagsContextPaneResults=function(e){return __awaiter(this,void 0,void 0,(function(){var r,n,o,i,s,a,l,u,p,f,v,g,y,h,m,P,T,x,R,F,C,A;return __generator(this,(function(V){switch(V.label){case 0:return r=[],n=FxImpl.lowerCaseStringMap(),e.forEach((function(e,t){r.push(t),n.set(t,t)})),o=Object.create(null),i=Object.create(null),s=Object.create(null),a=Object.create(null),l=Object.create(null),[4,Promise.all(r.reduce((function(e,r){return t.ArmId.parse(r,!0)?(e.push(D(r,"getResourcesFromArm").then((function(e){return{id:r,tags:e}}),(function(){return null}))),e):e}),[]))];case 1:if(V.sent().forEach((function(r){var t=e.get(n.get(r.id));if(t){var u=Object.keys(r.tags).map((function(e){return(e||"").toLowerCase()}));Object.keys(t).forEach((function(e){if(!u.includes((e||"").toLowerCase()))return s[e]=!0;var n=(e||"").toLowerCase(),a=r.tags.hasOwnProperty(e)?e:MsPortalFx.find(Object.keys(r.tags),(function(e){return(e||"").toLowerCase()===n}));r.tags[a]!==t[e]&&(o[e]=!0,i[r.id]=!0)}));var c=Object.keys(t).map((function(e){return(e||"").toLowerCase()}));Object.keys(r.tags).forEach((function(e){c.includes((e||"").toLowerCase())||(a[e]=!0,l[r.id]=!0)}))}})),u=Object.keys(s).length,p=Object.keys(o).length,f=Object.keys(a).length,u+p+f===0)return[2];g=1===(v=u+p),y=new Map,h=0,e.forEach((function(e,r){h++;var t=new Map;Object.keys(e).forEach((function(r){return t.set(r.toLowerCase(),{name:r,value:e[r]})})),y.set(r,t)})),m=(0,d.publishPendingNotification)({title:v?b.savingTitle:b.removingTitle,description:v?w(0,v,h):w(1,f,h)}),V.label=2;case 2:return V.trys.push([2,4,,5]),[4,S(y)];case 3:return P=V.sent(),[3,5];case 4:return T=V.sent(),_.error(T),[2];case 5:if(x=[],P.armErrorsMap.forEach((function(e){return x.push(e.armError)})),x.length)(R={title:b.saveFailedTitle,description:"",linkTo:null,status:2}).description=g?b.saveFailedSingleDescription:b.saveFailedDescription.format(x.length,v),R.linkTo=new c.BladeReference({blade:"ArmErrorsBlade",extension:"HubsExtension",parameters:{errors:{details:x}},openInContextPane:!0});else{switch(R={title:"",description:"",status:4},F=[],u&&F.push(w(2,u,h)),p&&F.push(w(3,p,Object.keys(i).length)),(C=Object.keys(a).length)&&F.push(w(4,C,Object.keys(l).length)),A=void 0,F.length){case 1:A=F[0];break;case 2:A=b.saveMultiOperationDescription.format(F[0],F[1]);break;case 3:A=b.saveMultiOperationDescription.format(F[0],b.saveMultiOperationDescription.format(F[1],F[2]))}R.title=u+p>0?g?b.saveSingleSuccessTitle:b.saveMultiSuccessTitle:1===C?b.removedSingleSuccessTitle:b.removedMultiSuccessTitle,R.description=A}return m.complete(R),[2,P]}}))}))},r.fetchResourceTags=D;var g=MsPortalFx.Base.Diagnostics,y=MsPortalFx.Errors.Error,h=((p={})[0]=0,p[404]=0,p[401]=1,p[403]=1,p[409]=2,p[400]=3,p[405]=3,p[501]=3,p),m=((f={})[0]=a.Tags.Errors.unavailable,f[1]=a.Tags.Errors.unauthorized,f[2]=a.Tags.Errors.conflict,f[3]=a.Tags.Errors.notImplemented,f),_=g.createLog(e),b=a.Tags.Notifications,P=MsPortalFx.isFeatureEnabled("resourcetagsapi"),T=[[b.addingTagToResource,b.addingTagToResources],[b.addingTagsToResource,b.addingTagsToResources]],x=[[b.removingTagFromResource,b.removingTagFromResources],[b.removingTagsFromResource,b.removingTagsFromResources]],R=[[b.saveSuccessAddTagResource,b.saveSuccessAddTagResources],[b.saveSuccessAddTagsResource,b.saveSuccessAddTagsResources]],F=[[b.saveSuccessEditTagResource,b.saveSuccessEditTagResources],[b.saveSuccessEditTagsResource,b.saveSuccessEditTagsResources]],C=[[b.removeSuccessTagResource,b.removeSuccessTagResources],[b.removeSuccessTagsResource,b.removeSuccessTagsResources]],A=((v={})[0]=T,v[1]=x,v[2]=R,v[3]=F,v[4]=C,v);function w(e,r,t){var n=1===r?0:1,o=1===t?0:1,i=A[e][n][o];return n?o?i.format(r,t):i.format(r):o?i.format(t):i}function V(e,r){if(r=r||t.ArmId.parse(e,!0),i.ResourceArmIdKindMap[r.kind])return(0,s.resourceApi)(e);if(4===r.kind)return Promise.resolve((0,s.resourceGroupApi)(e));throw new Error("Cannot get instance URI for ID other than resource or resource group")}function k(e,r,t){var n=t&&parseInt(t),i=l.delay(n&&!isNaN(n)?1e3*n:5e3);return u.tryImmediateResolve(i,(function(){return(0,o.batch)({uri:r,setTelemetryHeader:"ArmTags.startPolling"}).then((function(t){if(![204,200].includes(t.httpStatusCode)){var n=t.headers.Location||r;return k(e,n,t.headers["Retry-After"])}return D(e,"ArmTags.getResource")}))}))}function M(e){var r=MsPortalFx.isFeatureEnabled("resourcetags2022");return"".concat(MsPortalFx.ensurePrefix(e,"/"),"/providers/Microsoft.Resources/tags/default?api-version=").concat(r?"2022-09-01":"2019-10-01")}function S(e){var r=new Map,n=new Map,i=[];return e.forEach((function(e,s){var l=Object.create(null);e.forEach((function(e){return l[e.name]=e.value})),i.push(function(e,r){return __awaiter(this,void 0,void 0,(function(){var n,i,s,l,u,c,d,p;return __generator(this,(function(f){switch(f.label){case 0:if(n=function(r){var t=(r.content||{}).error,n=r&&(r.status||r.httpStatusCode),o=h[n];void 0===o&&(o=4),t||(t={code:"".concat(n),message:m[o]||a.Tags.Errors.unknown,target:e});var s=i.resourceType;throw _.warning("Failed to save a tag for a resource. Returned ".concat(n),1e3,"ResourceType: ".concat(s),r),{armError:t,errorType:o}},i=t.ArmId.parse(e,!0),!P)return[3,4];f.label=1;case 1:return f.trys.push([1,3,,4]),[4,(0,o.batch)({uri:M(e),type:"PATCH",content:{operation:"Replace",properties:{tags:ko.toJS(r)}},setTelemetryHeader:"ArmTags.patchResourceTags"})];case 2:return s=f.sent(),[2,(d=s.headers.Location)?k(e,d,s.headers["Retry-After"]):Promise.resolve((s.content.properties||{}).tags)];case 3:return l=f.sent(),n(l),[3,4];case 4:return[4,V(e,i)];case 5:u=f.sent(),f.label=6;case 6:return f.trys.push([6,8,,9]),[4,(0,o.batch)({uri:u,type:"PATCH",content:ko.toJS({tags:r}),setTelemetryHeader:"ArmTags.patchResourceTags"})];case 7:return c=f.sent(),[2,(d=c.headers.Location)?k(e,d,c.headers["Retry-After"]):Promise.resolve(c.content.tags)];case 8:return p=f.sent(),n(p),[3,9];case 9:return[2]}}))}))}(s,l).then((function(e){n.set(s,e||Object.create(null))}),(function(e){r.set(s,e)})))})),Promise.all(i).then((function(){return{newTagsMap:n,armErrorsMap:r}}))}function E(e,r){return __awaiter(this,void 0,void 0,(function(){var o,i,s,a;return __generator(this,(function(l){switch(l.label){case 0:if(!e)throw"Resource ID could not be parsed";o=t.ArmId.stringify(e),l.label=1;case 1:return l.trys.push([1,6,,7]),i=void 0,4!==e.kind?[3,3]:[4,(0,n.getResourceGroup)(o,r)];case 2:return i=l.sent(),[3,5];case 3:return[4,(0,n.getResource)(o,r)];case 4:i=l.sent(),l.label=5;case 5:return[2,i.tags];case 6:if(s=l.sent(),!(a=s.httpStatusCode)||(u=a,d=[0,400,401,403,404],c&&(d=d.concat([500,503])),!("number"==typeof u?d.includes(u):u&&d.includes(u.status||u.httpStatusCode))))throw s;return _.warning("Failed to get resource from ARM",1,{resourceId:o,statusCode:a}),[3,7];case 7:return[2]}var u,c,d}))}))}function I(e,r){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return[4,(0,o.batch)({uri:M(e),setTelemetryHeader:r})];case 1:if(200===(t=n.sent()).httpStatusCode)return[2,((t.content||{}).properties||{}).tags||Object.create(null)];throw new Error("Failed to fetch tags using resource tags API. Error details: ".concat(MsPortalFx.getLogFriendlyMessage(t.content)))}}))}))}function D(e,r){return __awaiter(this,void 0,void 0,(function(){var n,o;return __generator(this,(function(i){switch(i.label){case 0:n=t.ArmId.parse(e,!0),i.label=1;case 1:return i.trys.push([1,6,,7]),P?[4,I(e,r)]:[3,3];case 2:return[2,i.sent()];case 3:return[4,E(n,r)];case 4:return[2,i.sent()];case 5:return[3,7];case 6:throw o=i.sent(),_.error(new y({message:'Failed to fetch tags for resource ID: "'.concat(e,'". Error details: ').concat(MsPortalFx.getLogFriendlyMessage(o)),innerErrors:o})),o;case 7:return[2]}}))}))}})),
define("FxHubs/Helpers/TagHelpers",["require","exports"],(function(e,r){"use strict";var t;Object.defineProperty(r,"__esModule",{value:!0}),r.DEV=r.getMaxTagsPerResource=r.disallowedTagValues=r.disallowedTagNamePrefixes=r.disallowedTagNameChars=void 0,r.tagNameHasValidLength=o,r.tagNameContainsValidChars=i,r.tagNameHasValidPrefix=s,r.isValidTagName=function(e){var r=o(e),t=i(e),n=s(e);return{isValid:r&&t&&n,hasValidChars:t,hasValidLength:r,hasValidPrefix:n}},r.tagValueHasValidLength=a,r.tagValueIsNotReserved=l,r.isValidTagValue=function(e){var r=a(e),t=l(e);return{isValid:r&&t,hasValidLength:r,hasValidValue:t}},r.disallowedTagNameChars=["<",">","%","&","\\","?","/"],r.disallowedTagNamePrefixes=["azure","microsoft","windows"],r.disallowedTagValues=["null","(null)"];var n=function(){var e=MsPortalFx.getFeatureValue("maxtagsperresource");t=e&&parseInt(e)||50};n();function o(e){return!!e&&e.length<=512}function i(e){for(var t=!0,n=0;t&&n<r.disallowedTagNameChars.length;)t=!(e||"").includes(r.disallowedTagNameChars[n]),n++;return t}function s(e){for(var t=!0,n=0,o=(e||"").toLowerCase();t&&n<r.disallowedTagNamePrefixes.length;)t=!o.startsWith(r.disallowedTagNamePrefixes[n]),n++;return t}function a(e){return!e||e.length<=256}function l(e){return!r.disallowedTagValues.includes((e||"").toLowerCase())}r.getMaxTagsPerResource=function(){return t},r.DEV={resetMaxTagsPerResource:n}}));
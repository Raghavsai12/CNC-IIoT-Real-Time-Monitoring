define("MsPortalImpl/UI/Hubs/UI.ResourceMapManager",["require","exports","Fx/ResourceManagement","Fx/DependencyInjection","FxInternal/AsyncLoader","FxHubs/ArmClient","FxHubs/RpcEndPoints","MsPortalImpl/Services/Services.AssetTypes"],(function(e,s,t,o,a,r,n,i){"use strict";s.mapResourceIdToDynamicSelectionAndIcon=s.mapResourceIdToAssetId=s.mapAssetIdToResourceId=s.getResourceAssetInformationForHubs=s.getResourceAssetInformation=s.getResource=s.ResourceMapManager=void 0;var c=MsPortalFx.Base,l=FxImpl.Extension;const d=c.Diagnostics.createLog(e),u="fulfilled";function m(e,s){return{resourceId:e,assetId:null,extensionName:null,assetType:null,compositeDisplayName:null,icon:null,browseType:-1,viewModelLocator:null,viewModel:null,viewModelExtensionName:null,contracts:0,dynamicSelection:null,reason:MsPortalFx.getLogFriendlyMessage(s)}}let p=s.ResourceMapManager=class{constructor(e){this._assetTypeService=e}_getResourceTypeMappingPacket(e){const s=this._assetTypeService.getAssetTypeByResourceType(e);return s?Promise.resolve({resourceType:e,assetType:s}):Promise.resolve({resourceType:e})}_getResourceAssetInformation(e,s){const o=FxImpl.lowerCaseStringMap();e.forEach((e=>{const s=t.ArmId.parse(e,!0).resourceType;let a=o.get(s)||o.get(t.ArmId.parse(e).resourceType);a||(a=[],o.set(s,a)),a.push(e)}));const a=[];return o.forEach(((e,s)=>{a.push(this._getResourceTypeMappingPacket(s))})),Promise.allSettled(a).then((e=>{const t=[];e.forEach((e=>{if(e.status===u){const a=e.value,r=a.resourceType.toLowerCase(),n=a.assetType;o.get(r).forEach((e=>{if(n){const o=t=>this._assetTypeService.mapResourceIdToDynamicSelectionAndIcon(e,s).then((s=>{const o=n.assetTypeManifest,{browseType:a}=o;return{resourceId:e,assetId:t,extensionName:n.extension,assetType:o.name,compositeDisplayName:n.compositeDisplayName,icon:s.icon,browseType:void 0!==a?a:-1,viewModelLocator:o.viewModelLocator,viewModel:o.viewModel,viewModelExtensionName:o.viewModelExtensionName,contracts:o.contracts,dynamicSelection:s.selection,isPreview:s.isPreview,isDisabled:o.isDisabled}})).catch((s=>(d.error(s),m(e,s))));t.push(o(e))}else t.push(Promise.resolve(m(e,new Error("No asset type for resource"))))}))}}));return Promise.all(t).finally((()=>{e.forEach((e=>{e.status===u&&e.value.ltm&&e.value.ltm.dispose()}))}))}))}getResourceAssetInformation(e,s){return this._getResourceAssetInformation(e,s)}};s.ResourceMapManager=p=__decorate([__metadata("fx:diagnostics",[e,"ResourceMapManager"]),o.Class(),__metadata("design:paramtypes",[i.AssetTypeService])],p);s.mapAssetIdToResourceId=a.defineHandler(l.mapAssetIdToResourceIdEndPoint,(e=>e.diContainer.get(i.AssetTypeService).mapAssetIdToResourceId(e.messageArg))),s.mapResourceIdToAssetId=a.defineHandler(l.mapResourceIdToAssetIdEndPoint,(e=>e.diContainer.get(i.AssetTypeService).mapResourceIdToAssetId(e.messageArg))),s.mapResourceIdToDynamicSelectionAndIcon=a.defineHandler(l.mapResourceIdToDynamicSelectionAndIconEndPoint,(e=>e.diContainer.get(i.AssetTypeService).mapResourceIdToDynamicSelectionAndIcon(e.messageArg.resourceId,`${e.messageContext.srcWindowId}:mapResourceIdToDynamicSelectionAndIcon`).then((e=>({...e}))))),s.getResourceAssetInformation=a.defineHandler(l.getResourceAssetInformationEndPoint,(e=>e.diContainer.get(p).getResourceAssetInformation(e.messageArg,`${e.messageContext.srcWindowId}:getResourceAssetInformation`).then((e=>e.slice())))),s.getResourceAssetInformationForHubs=a.defineHandler(n.AssetTypes.getResourceAssetInformationEndPoint,(e=>e.diContainer.get(p).getResourceAssetInformation(e.messageArg,`${e.messageContext.srcWindowId}:getResourceAssetInformationForHubs`).then((e=>e.slice())))),s.getResource=a.defineHandler(l.getResourceEndPoint,(e=>(0,r.getResource)(e.messageArg.resourceId,`${e.messageContext.srcWindowId}:getResource`)))})),
define("MsPortalImpl/Widgets/ResourceHoverCard",["require","exports","MsPortalImpl/TsxStringMode/Tsx","Fx/Controls/Toolbar","Fx/Controls/Pill","Fx/Controls/PillCollection","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/UI/UI.BladeOpener","MsPortalImpl/Widgets/Widgets.HoverCard","MsPortalImpl/Resources/ImplScriptResources","Fx/ResourceManagement","Fx/Composition/Selectable","FxHubs/ResourceCommands/BrowseCommanding","FxHubs/ArtHelpers/ArgBrowseHelpers","MsPortalImpl/UI/Commands/UI.CommandManager","FxHubs/ArtHelpers/ResourceHoverCardHelpers","FxHubs/RpcEndPoints","MsPortalImpl/Extension/Extension.Definition.Locator","FxHubs/ArmHelpers/ArmApisStartup","MsPortalImpl/UI/Hubs/UI.ResourceMapManager","MsPortalImpl/Widgets/AzureHome/AzureHome.Store"],(function(e,s,t,o,a,r,n,i,c,l,d,u,m,p,g,h,v,x,I,f,R){"use strict";s.ViewModel=s.HoverCardSource=void 0;var b,y=t,A=o.ToolbarItems.createBasicButton,M=FxImpl.TriggerableLifetimeManager,F=MsPortalFx.Base.Images;!function(e){e.AzureHomeRecent="AzureHomeRecent",e.AzureHomeFavorite="AzureHomeFavorite",e.Grid="Grid",e.ResourceLink="ResourceLink"}(b||(s.HoverCardSource=b={}));class P extends c.ViewModel{constructor(e,s,t,b,y){super(),this.isResourceFavorite=ko.observable(!1),this.favoriteIcon=F.Star({palette:99}),this.notFavoriteIcon=F.Favorite({palette:99}),this.resourceIcon=ko.observable(),this.resourceName=ko.observable(),this.viewIcon=F.View({palette:3}),this.toolbar=ko.observable(),this.resourceProperties=ko.observableArray(),this.tagCollection=ko.observable(),this._extensionName=ko.observable(),this._argBrowseItem=ko.observableArray(),this.openBlade=e=>{const s=new u.PdlBladeReference(e.bladeReference.blade,e.bladeReference.extension,{parameters:e.bladeReference.parameters});e.bladeReference.inContextPane?this._bladeManagement.openContextPane(s):this._bladeManagement.openBlade(s)},this.openResourceBlade=e=>{MsPortalFx.Assets.mapResourceIdToBladeReference(e.resourceId).then((e=>{this._bladeManagement.openBlade(e)}))},this._setNavigationManagement=(e,s)=>{this._dialogManagement={openDialog:s=>(Promise.all([this._diContainer.getAsync(n.DialogManager),this._diContainer.getAsync(g.AsyncPortalFormTarget)]).then((([t,o])=>{const a=new MsPortalFx.ViewModels.Dialogs.MessageBox(s.title,s.content,4);return t.showDialog(a,o,e[0],{locator:x.hubsLocator})})).then((e=>{6===e&&s.onClosed({button:6})})),Promise.resolve(!0))},this._bladeManagement=s??{openBlade:e=>this._diContainer.get(i.BladeOpener).openBlade(e,{flags:8,telemetryName:"ResourceHoverCard"}),openContextPane:e=>this._diContainer.get(i.BladeOpener).openBlade(e,{flags:9,telemetryName:"ResourceHoverCard"}),openBladeAsync:()=>Promise.resolve(!1),openContextPaneAsync:()=>Promise.resolve(!1)}},this._setToolbar=(e,s,t)=>{const a=[];if(a.push(A(this.lifetime,{label:l.ActionBarButtons.view,icon:this.viewIcon,onClick:()=>{(0,c.logTelemetry)("ViewResourceLinkClicked",this._resourceId),MsPortalFx.Assets.mapResourceIdToBladeReference(this._resourceId).then((e=>this._bladeManagement.openBlade(e))).catch((()=>{this._bladeManagement.openBlade(new u.PdlBladeReference("ResourceMenuBlade","HubsExtension",{parameters:{id:this._resourceId}}))}))}})),e.browseQueryManifest){const o=(0,m.createSelectionCommands)("ResourceHoverCard",e.browseQueryManifest,s,this.lifetime,(()=>this._extensionName()),t,this._argBrowseItem,this._dialogManagement,this._bladeManagement,8)||[];a.push(...o)}this.toolbar(o.create(this.lifetime,{items:a,showLabels:!0}))},this._setTags=e=>{const s=ko.observableArray();for(const t in e)(0,I.isHiddenTag)(t)||s.push(a.create(this.lifetime,{value:{key:t,value:e[t]},getKeyText:e=>e.key,getOperatorText:()=>":",getValueText:e=>e.value,createEditor:()=>(this._bladeManagement.openContextPane(new u.PdlBladeReference("ResourceTagsBlade","HubsExtension",{parameters:{resourceId:this._resourceId}})),null),showRemoveButton:!1}));this.tagCollection(r.create(this.lifetime,{items:s,theme:2,multipleRows:!0,maxVisibleItems:2}))},this._setResourceProperties=(e,s,t,o)=>{const a=[];for(const s of h.defaultProperties)s.isMetadata||a.push({name:s.name,value:(0,h.getValueFromArgResponse)(e,s.columnId)});a.push({name:l.ResourceProperties.subscription,value:(0,h.getValueFromArgResponse)(e,"subscriptionDisplayName"),resourceId:d.ArmId.stringify(s,1)}),a.push({name:l.ResourceProperties.resourceGroup,value:(0,h.getValueFromArgResponse)(e,"resourceGroup"),resourceId:d.ArmId.stringify(s,4)});const r={},n={},i=t.browseQueryManifest?.columns||[];for(const s of i)if(!a.some((e=>e.name===s.displayName)))switch(s.format){case 2:{const t=(0,h.getValueFromArgResponse)(e,s.name);a.push({name:s.displayName,value:d.ArmId.parse(t).resourceName,resourceId:t});break}case 5:case 7:a.push({name:s.displayName,value:(0,h.getValueFromArgResponse)(e,`${s.name}DisplayName`)});break;case 6:{let t=null;const o=(0,p.getColumnName)(s.bladeParameterColumn),r=(0,h.getValueFromArgResponse)(e,o);t="string"==typeof r||"number"==typeof r?{[o]:r}:r,a.push({name:s.displayName,value:(0,h.getValueFromArgResponse)(e,s.name),bladeReference:{extension:s.bladeExtensionName||this._extensionName(),blade:s.bladeName,parameters:t},shouldOpenContextPane:s.openBladeAsContextPane});break}case 9:{const t=(0,h.getValueFromArgResponse)(e,s.name)||{};a.push({name:s.displayName,value:t.text,propertyLink:t.link});break}case 11:{const t=(0,h.getValueFromArgResponse)(e,s.name)||{};a.push({name:s.displayName,value:t.text,propertyLink:t.link,propertyLinkIsExternal:!0});break}case 10:{const t=(0,h.getValueFromArgResponse)(e,s.name)||{};a.push({name:s.displayName,value:t.text,bladeReference:{extension:t.extension||this._extensionName(),blade:t.blade,parameters:t.parameters},shouldOpenContextPane:s.openBladeAsContextPane});break}case 8:{const t=(0,p.getColumnName)(s.iconColumn);a.push({name:s.displayName,value:(0,h.getValueFromArgResponse)(e,s.name),icon:{type:(0,h.getValueFromArgResponse)(e,t)}});break}case 3:r[s.name]=p.dateFormatter,n[s.name]=s,a.push({name:s.displayName,value:(0,p.dateFormatter)((0,h.getValueFromArgResponse)(e,s.name),null)});break;case 4:r[s.name]=p.numberFormatter,n[s.name]=s,a.push({name:s.displayName,value:(0,p.numberFormatter)((0,h.getValueFromArgResponse)(e,s.name),s)});break;default:a.push({name:s.displayName,value:(0,h.getValueFromArgResponse)(e,s.name)})}this._argBrowseItem((0,p.mapArgResponseToArgBrowseItems)(e,!0,o,r,n)),this.resourceProperties(a)},this.lifetime=new M,this.template=C,this.dockingElement=s,this.focusContent=this.toolbar,this._diContainer=t,this._resourceId=e,t.get(f.ResourceMapManager).getResourceAssetInformation([e],"ResourceHoverCard").then((e=>{e?.length?(this.resourceIcon(e[0].icon||F.Polychromatic.ResourceDefault()),this._extensionName(e[0].extensionName)):this.resourceIcon(F.Polychromatic.ResourceDefault())})),this._setNavigationManagement(s,b);const P=d.ArmId.parse(e),T=P.resourceType.toLowerCase();this.resourceName(d.ResourceName.getDisplayName({id:e,armId:P})),this.setFavorite=()=>{this.isResourceFavorite()?v.AssetTypes.removeFavoriteResourceEndPoint.invoke(FxImpl.Rpc.client,"HubsExtension",{resourceId:e,telemetrySource:"ResourceHoverCard"}).then((()=>{this.isResourceFavorite(!1),y&&y(),R.useAzureHomeStore.setState({favoriteResourcesLoading:!0,azHomeFavoriteResourcesLoading:!0})})):v.AssetTypes.addFavoriteResourceEndPoint.invoke(FxImpl.Rpc.client,"HubsExtension",{resourceId:e,name:this.resourceName(),telemetrySource:"ResourceHoverCard"}).then((e=>{e&&(this.isResourceFavorite(!0),y&&y(),R.useAzureHomeStore.setState({favoriteResourcesLoading:!0,azHomeFavoriteResourcesLoading:!0}))}))},v.ArtBrowse.getBrowsePrereqsEndpoint.invoke(FxImpl.Rpc.client,"fxw",{resourceType:T,includeColumnsVersion:2}).then((async s=>{const t=s.assetTypes||Object.create(null),o=t[T];this._setToolbar(s,o,P.resourceType);const a=[];a.push(...h.defaultProperties.map((e=>e.columnId))),a.push("id","name","type","subscriptionId","subscriptionDisplayName","resourceGroup","tags");const r=await(0,h.getResourceFromArg)(s.browseQueryManifest?.columns||[],a,s.browseQueryManifest?.browseQuery,P,this._resourceId,s.assetTypes,s.locations,s.directoriesMap,this.lifetime),n=(0,h.getValueFromArgResponse)(r,"tags");this._setTags(n),this.resourceName(d.ResourceName.getDisplayName({id:e,name:(0,h.getValueFromArgResponse)(r,"name"),armId:P,tags:n}));const i=(0,h.getValueFromArgResponse)(r,"kind")?.toLowerCase();if(i){const e=o.kindMap&&o.kindMap[i]||o.defaultKind;e?.icon&&this.resourceIcon(e.icon)}this._setResourceProperties(r,P,s,t)})),v.AssetTypes.isResourceFavoriteEndPoint.invoke(FxImpl.Rpc.client,"HubsExtension",{resourceId:e}).then((e=>this.isResourceFavorite(e)))}dispose(){this.lifetime.dispose()}}s.ViewModel=P;const C=y.tsx(t.Root,null,y.tsx("div",{class:"fxs-hover-card-container fxs-portal-background fxs-portal-text"},y.tsx("div",{class:"fxs-hide-accessible-label",id:"hoverCardDescriptionId",title:l.ServicesInfo.showResourceCard,"aria-hidden":"true"},l.ServicesInfo.showResourceCard),y.tsx("div",{class:"fxs-hover-card-initial"},y.tsx("div",{class:"fxs-hover-card-header"},y.tsx("div",{class:"fxs-hover-card-icon","data-bind":{image:"resourceIcon"}}),y.tsx("header",{class:"fxs-hover-card-title","data-bind":{text:"resourceName",attr:{title:"resourceName"}}}),y.tsx("div",{class:"fxs-hover-card-favoriteicon",role:"button","aria-pressed":"false","aria-label":l.KeyboardShortcuts.Toggle.toggleFavoriteService,"data-bind":{fxclick:"setFavorite",image:"isResourceFavorite() ? favoriteIcon : notFavoriteIcon"}})),y.tsx("div",{class:"fxs-hover-card-commands"},y.tsx("div",{"data-bind":{pcControl:"toolbar"},style:"max-width: 280px"}))),y.tsx(t.KoIf,{condition:"resourceProperties()&&resourceProperties().length"},y.tsx("div",{class:"fxs-hover-card-border"}),y.tsx("div",{class:"fxs-hover-card"},y.tsx("div",{class:"fxs-hover-card-additional"},y.tsx(t.KoIf,{condition:"tagCollection()&&tagCollection().items()&&tagCollection().items().length"},y.tsx("div",{class:"fxs-hover-card-padleftright","data-bind":{pcControl:"tagCollection"}})),y.tsx("div",{class:"fxs-hover-card-padless-header fxs-hover-card-no-border"},y.tsx("header",{class:"fxs-hover-card-heading"},l.ServicesInfo.HoverCard.Header.resourceDetails)),y.tsx("div",{class:"fxs-hover-card-padbottom fxs-hover-card-padleftright"},y.tsx("ul",{class:"fxs-hover-card-list","data-bind":{foreach:"resourceProperties"}},y.tsx(t.KoIf,{condition:"$data.value"},y.tsx("li",{class:"fxs-hover-card-list-item"},y.tsx("div",{class:"fxs-hover-card-resource-property"},y.tsx("div",{class:"fxs-hover-card-property-name","data-bind":{text:"$data.name"}}),y.tsx("div",{class:"fxs-hover-card-property-value"},y.tsx(t.KoIf,{condition:"$data.icon&&$data.icon.type"},y.tsx("div",{"data-bind":{image:"$data.icon"}})),y.tsx(t.KoIf,{condition:"$data.bladeReference"},y.tsx("a",{href:"","data-bind":{click:"$parent.openBlade",text:"$data.value",attr:{title:"$data.value"}}})),y.tsx(t.KoIf,{condition:"$data.propertyLink"},y.tsx(t.KoIf,{condition:"$data.propertyLinkIsExternal"},y.tsx("a",{href:"",target:"_blank","data-bind":{text:"$data.value",attr:{href:"$data.propertyLink",title:"$data.value"}}})),y.tsx(t.KoIfNot,{condition:"$data.propertyLinkIsExternal"},y.tsx("a",{href:"",target:"_self","data-bind":{text:"$data.value",attr:{href:"$data.propertyLink",title:"$data.value"}}}))),y.tsx(t.KoIf,{condition:"$data.resourceId"},y.tsx("a",{href:"","data-bind":{click:"$parent.openResourceBlade",text:"$data.value",attr:{title:"$data.value"}}})),y.tsx(t.KoIfNot,{condition:"$data.resourceId || $data.bladeReference || $data.propertyLink"},y.tsx("div",{"data-bind":{text:"$data.value"}})))))))))))))}));
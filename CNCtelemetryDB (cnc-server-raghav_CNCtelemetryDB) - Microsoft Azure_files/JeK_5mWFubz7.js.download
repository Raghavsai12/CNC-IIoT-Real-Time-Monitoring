define("MsPortalImpl.Controls/Controls/ResourceFilterHelper",["require","exports","Fx/DependencyInjection","FxHubs/ResourceManagement","MsPortalImpl/Services/Services.AssetTypes","Fx"],(function(e,s,t,i,r,o){"use strict";s.getLocations=s.ResourceFilterHelper=void 0;var n=MsPortalFx.Base,l=MsPortalFx.Extension.ResourceRoutingType;let c,a=s.ResourceFilterHelper=class{constructor(e){this._assetTypeService=e}getResourceTypes(e){let s=[];if(e&&e.length)return s=e.map((e=>({name:e.compositeDisplayName.plural,key:e.resourceType.toLowerCase(),keywords:e.keywords}))),MsPortalFx.stableSort(s,((e,s)=>MsPortalFx.localeCompareIgnoreCase(e.name,s.name)));if(!c){s=(this._assetTypeService.assetTypes||[]).filter((e=>{const s=e.assetTypeManifest,t=s.resourceType;return 1===s.browseType&&!(0,i.supportsOption)(s.options,1)&&e.lowerCaseResourceType!==n.Constants.ResourceTypes.ResourceGroups.toLowerCase()&&!(t&&(t.routingType===l.Tenant||t.routingType===l.ProviderProxy||t.routingType===l.Extension))})).map((e=>({name:e.compositeDisplayName.plural,key:e.lowerCaseResourceType,keywords:e.assetTypeManifest.keywords&&e.assetTypeManifest.keywords.split(",")}))),c=MsPortalFx.stableSort(s,((e,s)=>MsPortalFx.localeCompareIgnoreCase(e.name,s.name)))}return c}};s.ResourceFilterHelper=a=__decorate([__metadata("fx:diagnostics",[e,"ResourceFilterHelper"]),t.Class(),__metadata("design:paramtypes",[r.AssetTypeService])],a);s.getLocations=(0,o.memoizePromise)((()=>MsPortalFx.Azure.getLocations().then((e=>{const s=(0,o.forEachKey)(e,((e,s,t)=>{t.push({displayName:s,name:e})}),[]);return MsPortalFx.stableSort(s,((e,s)=>MsPortalFx.localeCompareIgnoreCase(e.displayName,s.displayName)))}))))})),
define("_generated/Less/MsPortalImpl.Controls/Controls/ResourceFilter.css",["module"],(function(e){"use strict";return{css:".fxc-resourcefilter-subscriptionsummary{margin-bottom:10px}.fxc-resourcefilter-summary-title{padding-right:5px}.fxc-resourcefilter-summary-filters{display:flex;flex-wrap:wrap}.fxc-resourcefilter-visible{flex:1 1 auto;min-width:200px;margin-bottom:10px;margin-right:10px}.fxc-resourcefilter-full{width:100%;display:block}.fxc-resourcefilter-hidden{display:none}.fxc-resourcefilter-opensubscriptionsettings{margin-left:3px}.fxc-resourcefilter-directories{width:100%}.ext-resourcefilter-header{border-bottom:1px solid #bbb;font-weight:400;width:100%;padding:0 4px 5px 8px;white-space:pre-wrap;margin-bottom:5px;margin-left:-8px}.ext-mode-dark .ext-resourcefilter-header{border-color:#666}.ext-resourcefilter-onlyselectedmsg{margin-right:3px}.ext-resourcefilter-excessmessage{margin-top:5px}",moduleId:e.id}})),
define("MsPortalImpl.Controls/Controls/ResourceFilter",["require","exports","Fx/Controls/DropDown","Fx/Controls/Section","Fx/Controls/TextBox","FxHubs/RpcEndPoints","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/UI.AuthStateManager","MsPortalImpl/Widgets/Widgets.Common","MsPortalImpl.Controls/Controls/Base/OptionsBase","MsPortalImpl.Controls/Controls/Base/Base","MsPortalImpl.Controls/Controls/ResourceFilterHelper","MsPortalImpl/Services/Services.Subscriptions","MsPortalImpl/Services/Services.Tenants","MsPortalImpl/Services/Services.ProjectedDirectories","MsPortalImpl/Weave/Util","FxInternal/Css","MsPortalImpl/Interactions/Interactions.PortalReader","_generated/Less/MsPortalImpl.Controls/Controls/ResourceFilter.css"],(function(e,s,t,i,r,o,n,l,c,a,u,p,d,h,b,m,x,_,g){"use strict";s.Widget=s.ResourceFilter=s.DEV=void 0,(0,x.injectCss)(g);var f=MsPortalFx.Base,S=FxImpl.Rpc,y=MsPortalFx.ViewModels,F=(o.Subscriptions,f.Diagnostics.Telemetry);const w=n.ResourceFilter,v="fxc-resourcefilter-summary-title",T="fxc-resourcefilter-summary-filters",M="fxc-resourcefilter-subscriptions-dd",P="fxc-subscription-summary",C="fxc-resourcefilter-hidden",k="fxc-resourcefilter-visible",I="azc-collapsed-hidden",L=ko.observable({value:0,type:0});let R;function V(e){return e?e.map((e=>e.subscriptionId.toLowerCase())).sort().join(","):null}function A(e){return e?e.map((e=>e.toLowerCase())).sort().join(","):null}function U(e,s,t){F.trace({action:t,source:"ResourceFilter "+(s&&s())||"",data:{selection:e}})}const D=`\x3c!-- ko if: data.showSubscriptionSummary --\x3e\x3c!-- ko if: !subsInitialized() --\x3e<span data-bind='text: text.loadingSubs'></span>\x3c!-- /ko --\x3e<div class='fxc-resourcefilter-subscriptionsummary ${I}'>\x3c!-- ko if: data.showTenantLevelSubscriptionSummary() && tenantName() --\x3e<strong class='${v}' data-bind='text: text.directory'></strong><span data-bind='text: tenantName'></span><span data-bind='visible: moreThanOneTenant'> &ndash; </span>\x3c!-- /ko --\x3e\x3c!-- ko ifnot: data.showTenantLevelSubscriptionSummary && !subsInitialized() --\x3e<strong data-bind='visible: subsCount, text: text.subscriptions' class='${v}'></strong><span data-bind='visible: !moreThanOneSubscription(), text: subsMessage, attr: { "aria-label": subsMessage }' tabindex="0"></span><a data-bind='visible: moreThanOneSubscription, text: subsMessage, attr: { "aria-label": subsMessageAriaLabel }' class='${P}' role='button' href=''></a>\x3c!-- /ko --\x3e<span data-bind='visible: dontSeeSubscriptionMessage'><span data-bind='visible: subsMessage'> &ndash; </span><span data-bind='visible: dontSeeSubscriptionMessage, text: dontSeeSubscriptionMessage'></span><a class='fxc-resourcefilter-opensubscriptionsettings' role='button' data-bind='text: $ctl.switchSubscriptionSettingsText, title: $ctl.switchSubscriptionSettingsText, attr: { href: $ctl.switchDirectoryUrl }'></a></span></div>\x3c!-- /ko --\x3e<div class='${T}'>\x3c!-- ko ifnot: $ctl._useSectionView --\x3e\x3c!-- ko if: $ctl.options.showTextFilter --\x3e<div data-bind='pcControl: $ctl._filterVM, css: $ctl._filterClass'></div>\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl._showDirectories --\x3e<div data-bind='pcControl: $ctl._directoriesVM' class='${I} fxc-resourcefilter-directories'></div>\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl.options.showSubscriptionFilter --\x3e<div data-bind='pcControl: $ctl._subscriptionsVM, css: $ctl._subscriptionsClass'></div>\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl.options.showResourceGroupFilter --\x3e<div data-bind='pcControl: $ctl._resourceGroupsVM, css: $ctl._resourceGroupsClass'></div>\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl.options.showTypeFilter --\x3e<div data-bind='pcControl: $ctl._resourceTypesVM, css: $ctl._resourceTypesClass'></div>\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl.options.showLocationFilter --\x3e<div data-bind='pcControl: $ctl._locationsVM, css: $ctl._locationsClass'></div>\x3c!-- /ko --\x3e\x3c!-- /ko --\x3e\x3c!-- ko if: $ctl._useSectionView --\x3e<div data-bind='pcControl: $ctl._sectionView'></div>\x3c!-- /ko --\x3e</div>`;class G extends a.Widget{getSubscriptionViewModel(){return this._subscriptionsVM}constructor(e,s,t){super(e,s,t),this._filterPlaceholderText=ko.observable(w.filterPlaceholderText),this._subscriptionsList=ko.observable(),this._subscriptionFilterEnabled=ko.observable(!0),this._rgLoading=ko.observable(),this.multiselect=ko.observable(),this._locationsList=ko.observable(),this._currentTenantInfo=ko.observable(),this._noRgText="",this._showDirectories=ko.observable(),this.switchDirectoryUrl="#menu/directory",this.switchSubscriptionSettingsText=w.openDirectoryAndSubscriptionText,this._resourceTypesList=ko.observable(),this._resourceGroupsList=ko.observable([]),this._hasUserUpdatedSelectedSubscriptions=!1,this._postBindSubscribeTextFilterRan=!1;const r=this.options,o=r._msPortalFxSectionOptions,n=this._useSectionView=!!o,a=r.textFilterPlaceholder,u=this._diContainer.get(h.TenantsService),m=this._diContainer.get(l.AuthStateManager),x=ko.observable(!1);this._portalReader=new _.PortalReader(this.ltm,{idPrefix:"resourcefilter"}),this._subscriptionsUserContext=this._diContainer.get(d.SubscriptionsUserContext),a&&(this._filterPlaceholderText=a),this._usingAdvancedFiltersPromise=this._subscriptionsUserContext.useAdvancedFiltersPromise,MsPortalFx.isFeatureEnabled("mspfilter")?this._projectedDirectoriesHelperPromise=(async()=>{const e=this._projectedDirectoriesPromise=this._diContainer.getAsync(b.ServicesProjectedDirectories),s=await e;x(await s.hasProjectedDirectories());const t=await this._projectedDirectoriesPromise;if(x()){const e=new((await MsPortalFx.require("MsPortalImpl.Controls/Controls/ResourceFilterProjectedDirectories")).ResourceFilterProjectedDirectoriesHelper)(this._diContainer);await e.initPromise;return(await t.getSelectedDirectoriesInSession()).subscribe(this.ltm,(()=>{this._handleSubscriptionsFilterUpdate()})),r.showDirectoryFilter&&(this._directoriesVM=e.getDirectoriesFilter(this.ltm),this._directoriesVM.items.subscribeAndRun(this.ltm,(e=>{const s=e.length>1;x(s),this._showDirectories(s)}))),e}})():(this._projectedDirectoriesPromise=Promise.resolve(null),this._projectedDirectoriesHelperPromise=Promise.resolve(null)),this._subscriptionsLoaded=r.subscriptionsLoaded,r.showTextFilter.subscribeAndRun(this.ltm,(e=>{e&&this._initializeTextFilter()})),r.showSubscriptionFilter.subscribeAndRun(this.ltm,(e=>{e&&this._initializeSubscriptionsFilter()})),r.showResourceGroupFilter.subscribeAndRun(this.ltm,(e=>{e&&this._initializeResourceGroupsFilter()})),r.showTypeFilter.subscribeAndRun(this.ltm,(e=>{e&&this._initializeTypesFilter()})),r.showLocationFilter.subscribeAndRun(this.ltm,(e=>{e&&this._initializeLocationsFilter()})),n&&(this._sectionView=i.create(this.ltm,o),this._sectionViewItems=[],this._sectionView.children(this._sectionViewItems),r.showTextFilter.subscribeAndRun(this.ltm,(e=>{e&&!this._sectionViewItems.includes(this._filterVM)&&(this._sectionViewItems.push(this._filterVM),this._sectionView.children(this._sectionViewItems))})),r.showSubscriptionFilter.subscribeAndRun(this.ltm,(e=>{e&&!this._sectionViewItems.includes(this._subscriptionsVM)&&(this._sectionViewItems.push(this._subscriptionsVM),this._sectionView.children(this._sectionViewItems))})),r.showResourceGroupFilter.subscribeAndRun(this.ltm,(e=>{e&&!this._sectionViewItems.includes(this._resourceGroupsVM)&&(this._sectionViewItems.push(this._resourceGroupsVM),this._sectionView.children(this._sectionViewItems))})),r.showTypeFilter.subscribeAndRun(this.ltm,(e=>{e&&!this._sectionViewItems.includes(this._resourceTypesVM)&&(this._sectionViewItems.push(this._resourceTypesVM),this._sectionView.children(this._sectionViewItems))})),r.showLocationFilter.subscribeAndRun(this.ltm,(e=>{e&&!this._sectionViewItems.includes(this._locationsVM)&&(this._sectionViewItems.push(this._locationsVM),this._sectionView.children(this._sectionViewItems))})));const g=ko.observable(!1);(async()=>{const e=await this._subscriptionsUserContext.getAllSubscriptionsCount();L(e)})(),this._childLifetime&&this._childLifetime.dispose(),this._childLifetime=this.ltm.createChildLifetime();let f=0;const S=async()=>{const e=F.start({source:"ResourceFilter",action:0===f?"subscriptionsLoaded":"subscriptionsReloaded"});f++;try{await this._loadSubscriptions(e)}catch{F.cancelTrace(e)}g(!0)};R=(async()=>{if(!await this._usingAdvancedFiltersPromise)return await S();(await this._subscriptionsUserContext.getGlobalSelectedSubscriptions()).subscribeAndRun(this._childLifetime,(()=>R=S()))})(),(async()=>{const e=await p.getLocations();this._locationsList(e)})();const y=this._diContainer.get(p.ResourceFilterHelper);r.assetTypes.subscribeAndRun(this._childLifetime,(e=>{this._resourceTypesList(y.getResourceTypes(e))}));const v=ko.observable(""),V=ko.observable(!1);(async()=>{const e=await m.getUserInfo();this._currentTenantInfo(e),v(e.uniqueDirectoryName||"")})(),(async()=>{const e=await u.getHomeTenants();V(e&&e.length>1)})();const A=ko.observable(!1),U=ko.pureComputed((()=>{const e=L(),s=e.value,t=this._subscriptionsList()||[],i=t.length,o=(r.selectedSubscriptions()||[]).length,n=s>1;if(A(n),4===e.type)return w.selectedSubscriptionsOnlyText.format(o);if(!r.isPersistentSubscriptionFilter&&1===i&&n)return w.filteredSubscriptionsText.format(i,s);if(!s)return w.noSubscriptionsText.format(v());if(x()){const e=(this._subscriptionsVM?.items()||[]).reduce(((e,s)=>{const t=s.children;return t?e.push(...t):e.push(s),e}),[]),s=e.length;if(1===s&&i)return e[0].text;if(s>1&&this._subscriptionsClass().includes(k))return s===o?w.allSubscriptionsText.format(s):w.filteredSubscriptionsText.format(o,s)}else{if(1===s&&i)return t[0].uniqueDisplayName;if(s>1&&this._subscriptionsClass().includes(k))return s===o?w.allSubscriptionsText.format(s):w.filteredSubscriptionsText.format(o,s)}return""})),G=ko.pureComputed((()=>V()||!r.isPersistentSubscriptionFilter&&L().value>1?w.dontSeeSubscriptionText:""));this._showSubscriptions=ko.pureComputed((()=>{const e=(this._subscriptionsList()||[]).length>1||x();return r.showSubscriptionFilter()&&e&&this._subscriptionFilterEnabled()})),this._showTypes=ko.pureComputed((()=>r.showTypeFilter()&&(this._resourceTypesList()||[]).length>1)),this._showLocations=ko.pureComputed((()=>r.showLocationFilter()&&(this._locationsList()||[]).length>1)),ko.explicitComputed(this.ltm,[r.showTextFilter,this._showSubscriptions,r.showResourceGroupFilter,this._showTypes,this._showLocations],((e,s,t,i,o)=>{r.noFilterVisible(!(e||s||t||i||o))})),this._filterClass=ko.pureComputed((()=>`${r.showTextFilter()?k:C} fxc-resourcefilter-filter`)),this._subscriptionsClass=ko.pureComputed((()=>{const e=this._showSubscriptions()?k:C,s=this._showDirectories()?"msportalfx-nested-control":"";return`${e} ${I} fxc-resourcefilter-subscriptions ${s}`})),this._resourceGroupsClass=ko.pureComputed((()=>`${r.showResourceGroupFilter()?k:C} ${I} fxc-resourcefilter-resourceGroups`)),this._resourceTypesClass=ko.pureComputed((()=>`${this._showTypes()?k:C} ${I} fxc-resourcefilter-resourcetypes`)),this._locationsClass=ko.pureComputed((()=>`${this._showLocations()?k:C} ${I} fxc-resourcefilter-locations`)),e.html(D),e.addClass("fxc-resourcefilter");const O=e.find(`.${T}`);this._bindDescendants({text:w,subsInitialized:g,tenantName:v,moreThanOneTenant:V,dontSeeSubscriptionMessage:G,subsCount:ko.pureComputed((()=>L().value)),subsMessage:U,subsMessageAriaLabel:ko.pureComputed((()=>w.multipleSubscriptionsSelectedText.format(U()))),moreThanOneSubscription:A}),r.showTextFilter.subscribeAndRun(this.ltm,(async e=>{e&&!this._postBindSubscribeTextFilterRan&&this._filterVM&&(await(0,c.waitForBindings)(O.find(">:first-child")[0]),this._postBindSubscribeTextFilter())})),e.on("click",`a.${P}`,(s=>{s.preventDefault();const t=e.find(`.${M}`);if(t.length){const e=t.find(".fxc-dropdown-open");e.length&&$(e[0]).trigger("mouseup")}}))}get options(){return this._options}dispose(){this.options.deferSelectedSubscriptionsUpdate&&this._hasUserUpdatedSelectedSubscriptions&&this._handleSubscriptionsFilterUpdate(),super.dispose()}_initializeTextFilter(){if(this._filterVM)return;const e=this.options,s=e.filterText()||"",t=this._filterPlaceholderText;this._filterVM=r.create(this.ltm,{placeHolderText:t,value:ko.observable(s),ariaLabel:t,suppressDirtyBehavior:!0,valueUpdateTrigger:4,visible:e.showTextFilter,label:this._useSectionView?w.filter:""})}_postBindSubscribeTextFilter(){const e=this._filterVM,s=this.ltm,t=this.options.filterText,i=e.value;let r,o=s.createChildLifetime();t.subscribeAndRun(o,(e=>{if(e&&e!==i()){r=!0;try{i(e)}finally{r=!1}}})),i.subscribe(s,(()=>{!r&&o&&(o.dispose(),o=null)}));const n=ko.computed(s,(()=>i()));n.extend({rateLimit:{timeout:800,method:"notifyWhenChangesStop"}}),n.subscribe(s,(e=>{t(e||"")})),this._postBindSubscribeTextFilterRan=!0}_initializeTypesFilter(){if(this._resourceTypesVM)return;const e=this.options,s=this._resourceTypesList,i=ko.observableArray(),r=ko.observable(Object.create(null)),o=this.ltm,n=e=>e.key,l=ko.observable(""),c=this._resourceTypesVM=t.create(o,{items:i,filter:!0,filterPlaceholder:w.filterPlaceholderText,multiselect:!0,selectAll:!0,ariaLabel:ko.observable(w.typesLabel),customFilter:e=>this._customTypeFilter(e),suppressDirtyBehavior:!0,multiItemDisplayText:l,visible:e.showTypeFilter,label:this._useSectionView?w.resourceTypes:"",telemetryName:e.context&&e.context()+"-ResourceTypeFilter"});let a;s.subscribeAndRun(o,(e=>{(e=e||[]).length&&this._resourceTypesVM.value(e.map(n)),r(MsPortalFx.extendArrayIntoMap(Object.create(null),e,n,(e=>e.name))),i(e.map((e=>({text:e.name,value:e.key}))))}));const u=this._diContainer.get(p.ResourceFilterHelper);c.isPopUpOpen.subscribe(o,(t=>{if(!t){let t=MsPortalFx.makeArray(c.value());t.length||(t=u.getResourceTypes(e.assetTypes()).map(n),c.value(t)),(a||t.length<s().length)&&A(t)!==A(a)&&t.length&&(t.length===s().length?e.selectedTypes([]):e.selectedTypes(t)),a=t}})),ko.reactor(o,(()=>{const t=MsPortalFx.makeArray(c.value()),i=0===t.length||t.length===(s&&s().length)?w.allResourceTypesSelectedText:1===t.length?r()[t[0]]||t[0]:w.multipleResourceTypesSelectedText.format(t.length);l(i),U(t.length,e.context,"TypeFilterUpdated")}))}_customTypeFilter(e){const s=e=>e.key;if(e.length){const t=this._resourceTypesList().filter((s=>{const t=e.toLocaleLowerCase(),i=s.name.toLocaleLowerCase().includes(t),r=s.keywords&&s.keywords.some((e=>e.toLocaleLowerCase().includes(t)));return i||r})).map(s);return Promise.resolve(t)}return Promise.resolve(this._resourceTypesList().map(s))}_initializeLocationsFilter(){if(this._locationsVM)return;const e=this.options,s=this._locationsList,i=ko.observableArray(),r=ko.observable(Object.create(null)),o=this.ltm,n=e=>e.name,l=ko.observable(""),c=this._locationsVM=t.create(o,{items:i,filter:!0,filterPlaceholder:w.filterPlaceholderText,multiselect:!0,selectAll:!0,ariaLabel:ko.observable(w.locationsLabel),suppressDirtyBehavior:!0,multiItemDisplayText:l,visible:e.showLocationFilter,label:this._useSectionView?w.location:"",telemetryName:e.context&&e.context()+"-LocationFilter"});let a;s.subscribeAndRun(o,(e=>{(e=e||[]).length&&this._locationsVM.value(e.map(n)),r(MsPortalFx.extendArrayIntoMap(Object.create(null),e,n,(e=>e.displayName))),i(e.map((e=>({text:e.displayName,value:e.name}))))})),c.isPopUpOpen.subscribe(o,(t=>{if(!t){let t=MsPortalFx.makeArray(c.value());t.length||(t=s().map(n),c.value(t)),(a||t.length<s().length)&&A(t)!==A(a)&&t.length&&(t.length===s().length?e.selectedLocations([]):e.selectedLocations(t)),a=t}})),ko.reactor(o,(()=>{const t=MsPortalFx.makeArray(this._locationsVM.value()),i=0===t.length||t.length===(s&&s().length)?w.allLocationsSelectedText:1===t.length?r()[t[0]]||t[0]:w.multipleLocationsSelectedText.format(t.length);l(i),U(t.length,e.context,"LocationFilterUpdated")}))}_initializeResourceGroupsFilter(){if(this._resourceGroupsVM)return;const e=this.options,s=this._resourceGroupsList,i=e.autoSelectAllResourceGroups(),r=ko.observableArray(),o=this.ltm,l=ko.observable(""),c=this.multiselect,a=this._resourceGroupsVM=new t.ViewModel(o,{items:r,filter:c,filterPlaceholder:w.filterPlaceholderText,selectAll:c,multiselect:!0,ariaLabel:ko.observable(w.resourcegroupsLabel),multiItemDisplayText:l,visible:e.showResourceGroupFilter,label:ko.observable(this._useSectionView?w.resourceGroup:""),validations:ko.observableArray([new y.CustomValidation("",(e=>y.getValidationResultPromise(0===e.length&&!i&&n.requiredField)))])});let u;s.subscribeAndRun(o,(e=>{(e=e||[]).length&&i&&this._resourceGroupsVM.value(e);const s=e.map((e=>e&&e.toLocaleLowerCase()===w.loading.toLocaleLowerCase()?{text:e,disabled:!0}:{text:e,value:e}));r(s)})),a.visibleItemLimit=parseInt(MsPortalFx.getFeatureValue("rgdropdownlimit"))||50,a.isPopUpOpen.subscribe(o,(async t=>{if(t){const e=(await this._subscriptionsUserContext.getInSessionSelectedSubscriptions())().map((e=>e.subscriptionId));!this._rgLoading()&&this._getResourceGroups(MsPortalFx.makeArray(e))}if(!t){let t=a.value()||[];const r=s();if(!t.length&&i&&(t=r,a.value(t)),A(t)!==A(u)){const s=this._getUnselectedItems(t,r),i=s.length<t.length;e.invertResourceGroupFilter(i),e.selectedResourceGroups(i?s:t)}u=t}})),e.selectedResourceGroups.subscribeAndRun(o,(s=>{const t=a.value,i=e.invertResourceGroupFilter()&&this._getUnselectedItems(s,this._resourceGroupsList())||s;A(i)!==A(t())&&t(i)})),ko.reactor(o,(()=>{const t=a.value()||[],r=s(),o=this._noRgText||(0===t.length&&i||t.length&&t.length===r.length?w.allRgsSelectedText:1===t.length?t[0]:w.multipleRgsSelectedText.format(t.length));l(o),U(t.length,e.context,"ResourceGroupsFilterUpdated")}))}_getUnselectedItems(e,s){const t=MsPortalFx.convertArrayToMap(e,(e=>e));return s.filter((e=>!t[e]))}async _loadSubscriptions(e){let s,t;if(this._subscriptionsLoaded(!1),this.options.isPersistentSubscriptionFilter||this.options.showAllSubscriptions){s=await this._subscriptionsUserContext.getGlobalDisplayedSubscriptions();t=(await this._subscriptionsUserContext.getGlobalSelectedSubscriptions())()}else{s=(await this._subscriptionsUserContext.getInSessionDisplayedSubscriptions()).subscriptions;t=(await this._subscriptionsUserContext.getInSessionSelectedSubscriptions())()}this._handleInputSubscriptionId(s,this.options.selectedSubscriptionId());const i=this._subscriptionFilterEnabled(),r=()=>{F.completeTrace(e,{displayedSubscriptionsCount:(this._subscriptionsList()||[]).length,selectedSubscriptionsCount:(this.options.selectedSubscriptions()||[]).length,subscriptionsFiltered:this.options.subscriptionsFiltered(),subscriptionFilterEnabled:i})};if(i){const e=t.map((e=>e.subscriptionId));this._selectedSubscriptionsIds=e,this.options.showSubscriptionFilter.subscribeAndRun(this.ltm,(e=>{e&&this._subscriptionsVM.value(this._selectedSubscriptionsIds)}));const i=function(e,s){const t=e.length+s.length,i=new Map,r=new Array(t);let o=Math.min(e.length,t);for(let s=0;s<o;s++){const t=e[s];i.set(t.subscriptionId,t),r[s]=t}const n=Math.min(s.length,t);let l=0;for(;l<n&&o<r.length;){const e=s[l++];i.has(e.subscriptionId)||(i.set(e.subscriptionId,e),r[o++]=e)}return r.length=o,r}(t,s);this._subscriptionsList(i),V(t)!==V(this.options.selectedSubscriptions())&&(this.options.subscriptionsFiltered(t.length!==i.length),this.options.selectedSubscriptions(t.slice())),this._subscriptionsLoaded(!0),r()}else this._subscriptionsList(s),this._subscriptionsLoaded(!0),r()}_initializeSubscriptionsFilter(){if(this._subscriptionsVM)return;const e=this.options,s=this._subscriptionsList,i=this.ltm,r=ko.observableArray(),o=ko.observable(Object.create(null)),l=ko.observable(""),c=ko.computed(i,(()=>this._useSectionView||this._showDirectories()?w.subscription:""));let a="";const p=this._subscriptionsVM=t.create(i,{cssClass:M,items:r,multiselect:!0,filter:!0,filterPlaceholder:w.filterPlaceholderText,selectAll:!0,ariaLabel:ko.observable(w.subscriptionsLabel),multiItemDisplayText:l,suppressDirtyBehavior:!0,visible:e.showSubscriptionFilter,label:c,telemetryName:e.context&&e.context()+"-SubscriptionFilter"});(0,u.setTrustedViewModel)(p),e.isSubscriptionPopupOpen.subscribeAndRun(i,(e=>p.isPopUpOpen(e)));const d={text:{htmlTemplate:e.isPersistentSubscriptionFilter||e.showAllSubscriptions?'<div class="ext-resourcefilter-header" data-bind="text: excessMessage, visible: excessMessage"></div>':'<div class="ext-resourcefilter-header" data-bind="visible: subsMessageForNonPersistentFilter"><div><span class="ext-resourcefilter-onlyselectedmsg" data-bind="text: subsMessageForNonPersistentFilter"></span><a href=\'#menu/directory\' data-bind="text: openGlobalSubscription"></a></div><div class="ext-resourcefilter-excessmessage" data-bind="text: excessMessage, visible: excessMessage"></div></div>',viewModel:{subsMessageForNonPersistentFilter:ko.pureComputed((()=>{const e=L(),s=e.value,t=e.type,i=p.items().length;return 1===t&&i<s?w.excessSubscriptionsMsgForTotalType.format(s,i):""})),openGlobalSubscription:w.globalSubscriptionFilter,excessMessage:ko.pureComputed((()=>{const s=L(),t=s.value;switch(s.type){case 1:{const s=p.items().length;return s<t&&e.isPersistentSubscriptionFilter?w.excessSubscriptionsMsgForTotalType.format(t,s):""}case 2:return"";case 4:return e.isPersistentSubscriptionFilter?w.errorGettingSubscriptions:""}}))}}};(async()=>{const[t,c]=await Promise.all([this._projectedDirectoriesHelperPromise,this._usingAdvancedFiltersPromise]),a=e.isPersistentSubscriptionFilter;t?s.subscribeAndRun(i,(e=>{e&&this._setSubscriptionsOptions(r,o,d,e,(()=>t.populateProjectedSubscriptionsFilter(e,l,a,c)))})):s.subscribeAndRun(i,(e=>{e=e||[],this._setSubscriptionsOptions(r,o,d,e,(()=>e.map((e=>{let s=e.uniqueDisplayName;return a&&(s=n.ResourceFilter.subscriptionNameAndIdLabelFormat.format(e.displayName,e.subscriptionId),"disabled"===e.state.toLowerCase()&&(s=n.disabledSubscriptionLabelFormat.format(s))),{text:s,value:e.subscriptionId,selectedItemOverride:l}}))))}))})(),(e.isPersistentSubscriptionFilter||e.showAllSubscriptions)&&(p.customFilter=()=>Promise.resolve([]),this._subscriptionsVM.showStatusMessage(!1),p.filterString.subscribe(i,(async e=>{if(!p.isPopUpOpen())return;a=e;const s=this._subscriptionsUserContext.getSubscriptionSearchResults(e),t=this._subscriptionsUserContext.getAllSubscriptionsCount(),[i,n,c,u]=await Promise.all([s,t,this._projectedDirectoriesHelperPromise,this._usingAdvancedFiltersPromise]);L(n);const d=i.subscriptions;if(i.searchString!==a)return;p.suppressSelectedUpdate(!0),o(MsPortalFx.extendArrayIntoMap(Object.create(null),d,(e=>e.subscriptionId),(e=>e.uniqueDisplayName)));let h=null;h=c?c.populateProjectedSubscriptionsFilter(d,l,!0,u):d.map((e=>({text:w.subscriptionNameAndIdLabelFormat.format(e.displayName,e.subscriptionId),value:e.subscriptionId}))),r(h),p.suppressSelectedUpdate(!1),p.showStatusMessage(0===p.items().length)})),p.selectAllOverride=async()=>{const e=MsPortalFx.makeArray(p.value()).length!==L().value||2===L().type,[t,i]=await Promise.all([this._subscriptionsUserContext.getAllSubscriptionIds(),this._subscriptionsUserContext.processNewSelectedSubscriptions({})]);s(i.displayedSubscriptions),L(t.allSubscriptionsCountData),p.value(e?t.subscriptionIds:[])}),p.isPopUpOpen.subscribe(i,(e=>{e||(this.options.deferSelectedSubscriptionsUpdate?this._hasUserUpdatedSelectedSubscriptions=!0:this._handleSubscriptionsFilterUpdate())}));const h=e.isPersistentSubscriptionFilter?this._subscriptionsUserContext.getGlobalSelectedSubscriptions():this._subscriptionsUserContext.getInSessionSelectedSubscriptions();(async()=>{const[e,s,t]=await Promise.all([h,this._projectedDirectoriesPromise,this._usingAdvancedFiltersPromise]);e.subscribe(i,(async e=>{const i=!t&&s?s.getSubscriptionsForSelectedDirectories(e):Promise.resolve(e),r=await i,o=r.map((e=>e.subscriptionId)),n=this.options,l=(e,s)=>{const t=n.selectedSubscriptions(),i=t.map((e=>e.subscriptionId));this._subscriptionsVM.value(o),this._subscriptionsList(e),o.length===i.length&&V(r)===V(t)||(n.subscriptionsFiltered(s),n.selectedSubscriptions(e.filter((e=>o.includes(e.subscriptionId))))),this._rgLoading(!1)};if(n.isPersistentSubscriptionFilter||n.showAllSubscriptions){l(await this._subscriptionsUserContext.getGlobalDisplayedSubscriptions(),o.length!==L().value)}else{l((await this._subscriptionsUserContext.getInSessionDisplayedSubscriptions()).subscriptions,o.length!==L().value)}}))})();const{allSubscriptionsSelectedText:b,multipleSubscriptionsSelectedText:m}=w;ko.reactor(i,(()=>{const e=MsPortalFx.makeArray(p.value()),s=this._showDirectories()&&!e.length?m.format(0):b,t=e.length&&e.length!==L().value?1===e.length?o()[e[0]]||e[0]:m.format(e.length):s;l(t)})),ko.reactor(i,[e.selectedSubscriptionId],(t=>{const i=s();if(i){this._handleInputSubscriptionId(i,t);U(MsPortalFx.makeArray(p.value()).length,e.context,"SubscriptionFilterUpdated")}}))}_handleSubscriptionsFilterUpdate(){if(this._subscriptionsVM){const e=MsPortalFx.makeArray(this._subscriptionsVM.value());if(this.options.isPersistentSubscriptionFilter){const s=4===L().type||e.length!==L().value?e:[];this._subscriptionsUserContext.setGlobalSelectedSubscriptions(s)}else this._subscriptionsUserContext.setInSessionSelectedSubscriptions(e)}}_setSubscriptionsOptions(e,s,t,i,r){s(MsPortalFx.extendArrayIntoMap(Object.create(null),i,(e=>e.subscriptionId),(e=>e.uniqueDisplayName)));const o=r();1!==L().type&&o.unshift(t),e(o)}_getResourceGroups(e){this._rgLoading(!0),this._portalReader.read(w.loadingResourceGroups),this.multiselect(!1),this._resourceGroupsList([w.loading]),(async()=>{const s=await FxImpl.Azure.getResourceGroupsFromSubscription(S.client,e,!0);if(s.length){this._noRgText="";const e=s.map((e=>e.name));this._resourceGroupsList(e),this.multiselect(!0)}else this._noRgText=w.noResourceGroups,this.multiselect(!1),this._resourceGroupsList([])})()}_handleInputSubscriptionId(e,s){const t=this.options;if(s){this._subscriptionFilterEnabled(!1);const i=MsPortalFx.find(e,(e=>e.subscriptionId===s));i?(t.subscriptionsFiltered(!0),t.selectedSubscriptions([i]),this._subscriptionsVM.value([s])):(this._subscriptionFilterEnabled(!0),t.showSubscriptionFilter(!0))}else this._subscriptionFilterEnabled(!0)}}s.Widget=G;s.ResourceFilter=(0,m.createControlComponentForKO)({widgetCtor:G})}));
define("MsPortalImpl/Extension/DxDefinitionCache",["require","exports","FxInternal/AsyncLoader","MsPortalImpl/Extension/Extension.Manifest","MsPortalFx/Globalization","Fx/Experimentation","Fx/Ajax","Fx","FxHubs/Utilities","MsPortalImpl/Extension/ExtensionManagerOptions"],(function(e,t,n,a,o,i,r,s,c,l){"use strict";t.checkGetStartedCapability=v,t.dxBladeMapV2Experiments=t.dxBladeMapV2=void 0,t.getDefaultUXManifest=async function(e,t,n){const o=e.get(a.ManifestCache),i=(await o.getManifestAsync("Microsoft_Azure_GeneratedExtension","assetTypes")).pageVersion,r=F(t,i);try{return await MsPortalFx.Base.Net2.ajax({uri:MsPortalFx.pathJoin("/",r,"generated",n),useRawAjax:!0})}catch(e){return u.trace({source:"DxDefinitionCache",action:"CannotFetchGeneratedContent",actionModifier:u.ActionModifier.Mark,data:{extensionUri:r,content:n,status:e?.jqXHR?.status}}),""}},t.getDxBladeDefinition=async function(e,t,n,o,i,r){const s=e.get(a.ManifestCache),c=e.get(FxImpl.Rpc.Client);if("Microsoft_Azure_GeneratedExtension"===n){const a=M(o);if(a){o=a.bladeName;let l=await y(e,n,a.bladeName,i,s,c,t,!0);const d=l?"GeneratedViewExists":"GeneratedViewNotFound";return u.trace({source:"DxDefinitionCache",action:d,actionModifier:u.ActionModifier.Mark,data:{bladeName:o,bladeInfo:a}}),l||(l=await y(e,n,a.fallbackBladeName,i,s,c,t,r)),l}u.trace({source:"DxDefinitionCache",action:"Error",actionModifier:u.ActionModifier.Mark,data:{bladeName:o}})}return await y(e,n,o,i,s,c,t,r)},t.getDxContentHandler=void 0,t.getDynamicViewName=C,t.getRuntimeBlade=async function(e,t,n){const o=e.get(a.ManifestCache);if("Microsoft_Azure_GeneratedExtension"===t.name){const e=M(n);e&&(n=e.bladeName)}const i=await N(e,t,o,n,!0);return{bladeName:i?.bladeName,extensionName:i?.extensionName}},t.getV2RuntimeBladeInfo=N;var d=FxImpl.Extension,u=MsPortalFx.Base.Diagnostics.Telemetry;const f=t.dxBladeMapV2={markdown:{blade:"MarkdownBlade"},getstarted:{blade:"GetStartedBlade"},form:{blade:"FormBlade"},apiexplorer:{blade:"ApiExplorer.ReactView"},overview:{blade:"OverviewBlade"},properties:{blade:"PropertiesBlade"},monitoring:{blade:"MonitoringBlade"},capabilities:{blade:"CapabilitiesBlade"},recommendations:{blade:"RecommendationsBlade"},tutorials:{blade:"TutorialsBlade"},galleryview:{blade:"GalleryBlade"},databrowse:{blade:"DataBrowseBlade"},autogenform:{blade:"AutogenFormBlade"},dashboard:{blade:"Dashboards.ReactView",extension:"Microsoft_Azure_PortalDashboard"}},p=t.dxBladeMapV2Experiments={markdown:{featureGate:"DxReactMarkdown",blade:"MarkdownView.ReactView"},properties:{featureGate:"DxReactProperties",blade:"PropertiesView.ReactView"},getstarted:{featureGate:"DxReactGetStarted",blade:"GetStartedView.ReactView",capable:v}},x={},m={},w=8,g={},b={Small:0,Medium:1,Large:2,XLarge:3};function M(e){const t=e.split("__");if(5===t.length&&""===t[0]&&"rt"===t[1]){const e=t[2],n=t[3];return{bladeName:`${e}_${n}_dx`.toLowerCase(),fallbackBladeName:`microsoft_generic_resources_${n}_dx`.toLowerCase()}}}function h(e,t,n,a){return MsPortalFx.Base.Net2.ajax({uri:MsPortalFx.pathJoin("/",e,"Dx","Views",n,`${t.toLowerCase()}.json`),useRawAjax:!0}).catch((n=>{if(e.startsWith("https://localhost")||u.trace({source:"DxDefinitionCache",action:"CannotFetchGeneratedContent",actionModifier:u.ActionModifier.Mark,data:{extensionUri:e,content:t,status:n?.jqXHR?.status}}),a&&(404===n.jqXHR?.status||e.startsWith("https://localhost")))return null;throw n}))}async function y(e,t,n,a,o,i,r,s){const c=await N(e,a,o,n,s);if(s&&!c)return null;if(!c||c.error)return Promise.reject(c?.error?c.error:"BladeDefinitionIsNull");const l=c.viewKind,u=c.bladeName,f=c.content,p=u.toLowerCase().endsWith(".ReactView".toLowerCase())&&u,x=a.armResourceId?MsPortalFx.Base.Net2.ajax({uri:MsPortalFx.pathJoin("/",c.extensionContentUri,"AzurePortalMetadata/SourceManifest.json"),useRawAjax:!0}):null,m=o.getManifestAsync(t,"assetTypes"),w=o.getManifestAsync(t,"assetTypesMenu"),g=await Promise.all([p?B(p,(()=>r.getBladeDefinition(c.extensionName,p))):B(u,(()=>d.getBladeDefinitionEndPoint.invoke(i,c.extensionName,u))),m,w,x]);let[M]=g;const[,h,y,C]=g;M=MsPortalFx.clone(M,!0),M.name=n;const v=function(e,t,n,a){const o=n&&n.assetTypes||[],i=a&&a.assetTypesMenu||[],r=i.find((({overview:n,groups:a})=>{let o;if(n&&n.bladeName)o=n;else if(a&&a.length>0){const e=a[0].items||[];e&&e.length>0&&(o=e[0])}if(o){const n=!o.bladeExtensionName||o.bladeExtensionName===e,a=o.bladeName===t;return n&&a}})),s=r&&(o||[]).find((e=>e.name===r.name));return s}(t,n,h,y);if(p){const e=function(e,t,n,a,o){return[{valuesFrom:[{referenceType:5,constantValue:o,property:"constant_parameters_dxContent"}],property:"parameters.dxContent"},{valuesFrom:[{referenceType:5,constantValue:{bladeName:t,extensionName:e,viewKind:a,assetType:n},property:"constant_parameters_dxContext"}],property:"parameters.dxContext"}]}(t,n,v,l,f);M.effectiveInputs.push(...e);const a=M.lenses[0]?.partInstances[0]?.inline;if(a){a.bindings=M.effectiveInputs;const t=a.inputs;t&&e.forEach((e=>t.push(e.property)))}}else M.effectiveInputs=function(e,t,n,a,o){return[{valuesFrom:[{referenceType:5,constantValue:o,property:"constant_content"}],property:"content"},{valuesFrom:[{referenceType:5,constantValue:{bladeName:t,extensionName:e,viewKind:a,assetType:n},property:"constant_dxContext"}],property:"dxContext"},{valuesFrom:[{referenceType:1,property:"dxParameters"}],property:"dxParameters"}]}(t,n,v,l,f);M.contextPaneWidth=2;const D=(C?.views||[]).filter((e=>e.name===n));return D.length&&(M.dxSourcePath=D[0].path),M.attributes=4|M.attributes,M.pinnable=!!v,M.contextPaneWidth=function(e){if(!e)return;return b[e]}(f?.view.contextPaneWidth)??M.contextPaneWidth,M.dxView={runtimeExtension:c.extensionName,runtimeBlade:c.bladeName},v&&(M.assetType=v.name,M.assetIdInputProperty="id"),M}async function N(e,t,n,a,r){if(function(e,t){return x[e]?.[t]}(t.name,a))return null;const s=F(t,(await n.getManifestAsync(t.name,"assetTypes")).pageVersion);let c;const l=C(a);if(l){if(c=await async function(e,t){const n={bladeNameSuffix:e},a={extensionName:t,options:n};return function(e){const t=`${e.extensionName}-${e.options.bladeNameSuffix}`;(function(e,t){const n=m[e];if(n){const e=Math.abs(t-n);if(Math.floor(e/1e3)>=w)return!0}return!1})(t,Date.now())&&(D.delete(e),delete m[t])}(a),D(a)}(l,t.name),!c?.view?.kind)return{error:FxImpl.createError(c?.error?.message||"Error loading content")}}else{try{c=await h(s,a,o.displayLanguage,r)}catch{/^en$/i.test(o.displayLanguage)||(c=await h(s,a,"en",r))}if(!c?.view?.kind)return function(e,t){x[e]||(x[e]={});x[e][t]=!0}(t.name,a),null}const d=E(t.name,a);g[d]=c;const u=c.view.kind.toLowerCase();let b=p[u];if(b){const t=e.get(i.Experimentation).shellAssignments.getBooleanValue(b.featureGate)??!1,n=!t||!b.capable||b.capable(c);t&&n||(b=null)}const M=f[u];return{extensionContentUri:s,content:c,viewKind:u,bladeName:b?.blade||M?.blade||u,extensionName:b?.extension||M?.extension||"Microsoft_Azure_CreateUIDef"}}function C(e){const t=/__dv__(.*)__dx/i.exec(e);return t?.length>0&&t[1]}function v(e){const t=e.view.properties?.tabs,n=t?.filter((e=>"Recommendations"===e.kind||"DataBrowse"===e.kind));return!(n?.length>0)}const D=(0,s.memoizePromise)((async e=>MsPortalFx.Services.Rpc.invokeCallback(e.extensionName,"getDynamicDxView",e.options).then((async e=>(0,r.batch)({uri:"/providers/microsoft.portalservices/compilefile?api-version=2023-01-01-preview",type:"POST",content:{contents:e.viewSource,stringSource:e.stringSource,files:e.files}}).then((e=>e.content)).catch((e=>{if(400===e.httpStatusCode)return e.content;throw e})))).catch((e=>null))),{cacheFactory:()=>new c.MapWithKeyTransform({sourceToInternal:e=>{const t=`${e.extensionName}-${e.options.bladeNameSuffix}`;return m[t]=Date.now(),t}})});const P={};async function B(e,t){return P[e]||(P[e]=t()),P[e]}function F(e,t){const n=MsPortalEarly.ExtensionLoader.getUri(e),a=function(e){return e.stamp&&e.isSideloaded&&!e.isTestExtension}(e)||function(e){return!e.stamp&&!e.isSideloaded&&!e.isTestExtension}(e)?MsPortalFx.pathJoin("/",n,"Content",t):MsPortalFx.pathJoin("/",n,"Content");return a}t.getDxContentHandler=n.defineHandler(FxImpl.Extension.CreateUiDef.getDxContentEndPoint,(async e=>{const t=e.messageArg.extensionName,n=e.messageArg.bladeName,o=E(t,n),i=g[o];if(i)return i;const r=e.diContainer.get(l.ExtensionManagerOptions),s=e.diContainer.get(a.ManifestCache),c=r.getNormalizedMetadata(e.messageArg.extensionName,!0),d=await N(e.diContainer,c,s,n);return d?.content??d?.error}));function E(e,t){return`${e}.${t}`.toLowerCase()}}));
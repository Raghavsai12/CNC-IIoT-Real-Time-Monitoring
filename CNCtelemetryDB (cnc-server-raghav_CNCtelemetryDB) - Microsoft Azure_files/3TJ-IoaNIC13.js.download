define("FxHubs/ArmHelpers/ArmResourceProviders",["require","exports","Fx/Ajax","FxHubs/ArmHelpers/ArmApis","FxHubs/ArmHelpers/ArmResources","Fx"],(function(e,t,r,a,n,s){"use strict";var o,i=MsPortalFx.Base;return function(t){t.rpRegistrationCheckDelay=1e3,t.rpRegistrationCheckRetries=10;var o=i.Diagnostics.createLog(e),c="Deploy.",l="registerRP",u="registered",p="rejected";function d(e){return(e&&e.registrationState||"").toLowerCase()}function m(e,r,a,i,p){return void 0===p&&(p=t.rpRegistrationCheckRetries),Promise.resolve().then((function(){return d(e)===u?e:p?s.delay(t.rpRegistrationCheckDelay).then((function(){return(0,n.getArmResource)(r,"".concat(c).concat(l,".attempt").concat(t.rpRegistrationCheckRetries-p))})).then((function(e){return m(e,r,a,i,p-1)})):(o.warning("Status unknown for registering sub ".concat(a," with RP ").concat(i," after ").concat(t.rpRegistrationCheckRetries," attempts.")),e)}))}t.getRegistrationState=d,t.registerResourceProvider=function(e,t,s){var o=!1,i=(0,a.getResourceProviderWithSubscriptionApi)(e,t),p="".concat(c).concat(l,".checkState");return(0,n.getArmResource)(i,p).then((function(n){var s=d(n);if(o=s===u)return Promise.resolve(n);var i=(0,a.registerResourceProvidersApi)(e,t);return(0,r.batch)({uri:i,type:"POST",setTelemetryHeader:c+l}).then((function(e){return e.content}))})).then((function(r){return!o&&s?m(r,i,e,t):Promise.resolve(r)}))},t.registerResourceProviders=function(e,r){return r.length?Promise.resolve().then((function(){var a=r.map((function(r){return t.registerResourceProvider(e,r,!0)}));return Promise.allSettled(a)})).then((function(t){t.forEach((function(t,a){if(t.status===p&&t.reason&&[401,403].includes(t.reason.httpStatusCode))throw(0,n.buildError)(t.reason);t.status===p&&o.warning("Failed to register ".concat(r[a]," for sub ").concat(e,". ")+(0,n.buildError)(t.reason).message)}))})):Promise.resolve()}}(o||(o={})),o})),
define("FxHubs/DeploymentTelemetry",["require","exports"],(function(e,t){"use strict";var r,a,n;Object.defineProperty(t,"__esModule",{value:!0}),t.ActionModifier=t.Action=t.Source=void 0,function(e){e.CreateHub="CreateHub"}(r||(t.Source=r={})),function(e){e.CreateDeploymentEnd="CreateDeploymentEnd",e.CreateDeploymentPreflight="CreateDeploymentPreflight",e.CreateDeploymentStart="CreateDeploymentStart"}(a||(t.Action=a={})),function(e){e.Canceled="Canceled",e.Default="Default",e.Failed="Failed",e.Succeeded="Succeeded",e.UnknownError="UnknownError"}(n||(t.ActionModifier=n={}))})),
define("FxInternal/ResourceManagement/ArmTemplate",["require","exports","Fx/DependencyInjection","FxInternal/ResourceManagement/ArmCreateTelemetry","Fx","Fx/Ajax","Fx/Errors","Fx/ResourceManagement","FxHubs/ArmHelpers/ArmApis","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/ArmHelpers/ArmIds","FxHubs/ArmHelpers/ArmResourceGroups","FxHubs/ArmHelpers/ArmResourceProviders","FxHubs/ArmHelpers/ArmResources","FxHubs/Helpers/TagHelpers","FxHubs/DeploymentTelemetry","FxHubs/RpcEndPoints","FxInternal/Composition/ExtensionTelemetry","FxInternal/ResourceManagement/Permissions","jsonc-parser"],(function(e,t,r,a,n,s,o,i,c,l,u,p,d,m,v,k,y,g,f,h){"use strict";var _,b;Object.defineProperty(t,"__esModule",{value:!0}),t.DEV=t.buildStackFailureFromBatchItemError=t.buildTemplateFailureFromBatchItemError=t.fulfillPrerequisites=t.pollDeployment=t.startDeploymentImpl=t.validateAsyncImpl=t.validateTemplateImpl=t.validateStackImpl=t.submitDeploymentRequest=t.notifyProgress=t.getDeploymentName=t.validateAssetType=t.registerResourceProviders=t.provisionTemplateResourceGroup=t.stackSanity=t.sanity=t.templateSanity=t.initialTemplateSetup=t.initialStackSetup=t.validateTemplate=t.deployStack=t.deployTemplate=t.pollForDeployment=void 0,t.getDeploymentLevel=W,t.getDeploymentScope=z,t.hasPermission=K,t.canRegisterSubscriptionWithRPs=function(e,t){return __awaiter(this,arguments,void 0,(function(e,t,r){var a,n,s,o,i=this;return void 0===r&&(r=[]),__generator(this,(function(l){switch(l.label){case 0:return r.length?[4,r.reduce((function(r,a,n){return __awaiter(i,void 0,void 0,(function(){var s,o,i,l,u;return __generator(this,(function(p){switch(p.label){case 0:if(!a)return[2,r];p.label=1;case 1:return p.trys.push([1,6,,10]),s=(0,c.getResourceProviderWithSubscriptionApi)(t,a),[4,(0,m.getArmResource)(s,"canRegisterSubscriptionWithRPs")];case 2:return o=p.sent(),i=(0,d.getRegistrationState)(o),["registered","registering"].includes(i)?[3,5]:[4,K(e,"/subscriptions/"+t,{actions:["".concat(a,"/register/action")]})];case 3:return p.sent().valid?[3,5]:[4,r];case 4:p.sent().failedRPs.push(a),p.label=5;case 5:return[3,10];case 6:return l=p.sent(),"httpStatusCode"in(u=l)&&"disallowedprovider"===D.buildSimplifiedError(u).code.toLowerCase()?[4,r]:[3,8];case 7:return p.sent().disallowedRPs.push(a),[2,r];case 8:return[4,r];case 9:return p.sent().promiseRejections[n]=u,[3,10];case 10:return[2,r]}}))}))}),Promise.resolve({failedRPs:[],disallowedRPs:[],promiseRejections:Array(r.length)}))]:[2,{success:!0,failedRPs:void 0,disallowedRPs:void 0}];case 1:return a=l.sent(),n=a.disallowedRPs,s=a.failedRPs,o=a.promiseRejections,r.forEach((function(e,a){var n=o[a];if(n)return n=D.buildSimplifiedError(n.jqXHR||n),void C.warning("Failed to check if the subscription ".concat(t," has permissions to register with the resource provider ").concat(r[a],". Continue with create. Details: ").concat(n.message))})),[2,{success:!s.length&&!n.length,failedRPs:s,disallowedRPs:n}]}}))}))},t.pollDeploymentFromId=function(e){return __awaiter(this,arguments,void 0,(function(e,t){var r,a,n=this;return void 0===t&&(t="DeploymentManager"),__generator(this,(function(o){switch(o.label){case 0:r=(0,c.appendDeploymentApiVersion)(e),a=!1,o.label=1;case 1:return o.trys.push([1,,3,4]),[4,Promise.race([__awaiter(n,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:e=1,n.label=1;case 1:return n.trys.push([1,3,,5]),[4,s.batch({options:0,setTelemetryHeader:"".concat(t,".fetchDeployment.poll-").concat(e++),type:"GET",uri:r})];case 2:return[2,n.sent()];case 3:return n.sent(),[4,new Promise((function(e){return setTimeout(e,10001)}))];case 4:return n.sent(),[3,5];case 5:if(!a)return[3,1];n.label=6;case 6:return[2]}}))})),new Promise((function(e,t){return setTimeout(t,6e4)}))])];case 2:return[2,o.sent()];case 3:return a=!0,[7];case 4:return[2]}}))}))},t.getInnerError=Y,t.buildError=Z,t.buildTemplateFailure=ee,t.buildStackFailure=te,t.startDeployStack=function(e,r){var a=__assign({deploymentMode:8},MsPortalFx.clone(r,!0,!0));return(0,t.startDeploymentImpl)(e,{stack:a,track:{},template:null})};var I=FxImpl.Rpc,S=MsPortalFx.Base,P=MsPortalFx.ViewModels.getValidationResultPromise,w=S.Diagnostics.Telemetry,R=MsPortalFx.Azure.ResourceManager,D=FxImpl.Azure,T=R.DeploymentStages,F="",x={deployTemplateFailure:F,pollForDeploymentFailure:F,validateTemplateFailure:F,optionsUndefined:F,subscriptionIdUndefined:F,scopeUndefined:F,actionOnUnmanagedUndefined:F,deploymentModeUndefined:F,stackNameUndefined:F,deploymentNameUndefined:F,parametersLinkAndParameters:F,duplicateKey:F,templateLinkAndJson:F,uriNotAString:F,parsingTemplateJson:F,invalidResourceId:F,invalidPrimaryResourceId:F,invalidResourceProviders:F},A=FxImpl.getErrorMap(x),C=S.Diagnostics.createLog(e),E=R.DeploymentStates,N=((_={})[E.Succeeded]=!0,_[E.Failed]=!0,_[E.Deleted]=!0,_[E.Canceled]=!0,_),M=((b={})[E.Deleted]=!0,b[E.Deleting]=!0,b.movingresources=!0,b),G=k.Source.CreateHub,U=k.Action,H=k.ActionModifier,L=H.Default,q=H.Failed,O=H.Succeeded,j=U.CreateDeploymentEnd,B=U.CreateDeploymentPreflight,J=U.CreateDeploymentStart,V=(0,n.isFeatureEnabled)("wrapnewrgtemplate");function W(e){var t=e.stack,r=e.template;if(t){var a=i.ArmId.parse(t.scope);switch(a.kind){case 4:return 2;case 1:return 1;case 8:return"microsoft.management/managementgroups"===a.resourceType.toLowerCase()?3:0;default:return 0}}return r.resourceGroupName?2:r.subscriptionId?1:r.managementGroupId?3:0}function z(e){var t,r,a=e.stack,n=e.template;if(a)return a.scope||(null===(t=a.tenant)||void 0===t?void 0:t.name);switch(W(e)){case 2:return i.ArmId.stringify({resourceGroup:n.resourceGroupName,subscription:n.subscriptionId,kind:4},4);case 1:return i.ArmId.stringify({subscription:n.subscriptionId,kind:1},1);case 3:return i.ArmId.stringify({provider:"Microsoft.Management",resourceType:"Microsoft.Management/managementGroups",resourceName:n.managementGroupId,kind:8},8);default:return(null===(r=n.tenant)||void 0===r?void 0:r.name)||""}}t.pollForDeployment=function(e,t){return ue(e,t,!0)};t.deployTemplate=function(e,t){return ue(e,t)};t.deployStack=function(e,r){return __awaiter(void 0,void 0,void 0,(function(){var a,n,s,o,i,c,l,u,p,d,v,k,y,f,h;return __generator(this,(function(_){switch(_.label){case 0:return a=MsPortalFx.clone(r,!0,!0),i=t.startDeploymentImpl,c=[e],l={template:null,stack:__assign({telemetryId:a.launchingContext.telemetryId,deploymentMode:8},a)},u={},p={primaryResourceId:a.primaryResourceId,provisioningHash:a.provisioningHash},d={bladeName:a.launchingContext.createBlade},[4,e.get(g.ExtensionTelemetry).extensionName];case 1:return[4,i.apply(void 0,c.concat([(l.track=(u.postProvisioning=(p.createBlade=(d.extension=_.sent(),d),p),u),l)]))];case 2:return n=_.sent(),s=n.stack,o=n.track,[2,__assign(__assign({},s),{correlationId:null===(k=null===(v=o.deployment)||void 0===v?void 0:v.properties)||void 0===k?void 0:k.correlationId,deploymentId:null===(y=o.deployment)||void 0===y?void 0:y.id,timestamp:new Date(null===(h=null===(f=o.deployment)||void 0===f?void 0:f.properties)||void 0===h?void 0:h.timestamp),requestTimestamp:new Date(null==o?void 0:o.requestTimestamp),operations:o.operations,deploymentStatusCode:o.deploymentStatusCode,provisioningState:(0,m.getProvisioningState)(o.deployment)})]}}))}))};function K(e,t,r,a){return __awaiter(this,void 0,void 0,(function(){var n,s,o;return __generator(this,(function(i){switch(i.label){case 0:return n=ko.unwrap(r),(s=n&&n.actions||[]).length<1?[4,P()]:[3,2];case 1:case 4:case 6:return[2,i.sent()];case 2:return i.trys.push([2,5,,7]),[4,e.get(f.PermissionChecker).hasPermission(t,s)];case 3:return o=i.sent(),[4,P(!o&&(n.message||a||"{0}").format(s.join(", ")))];case 5:return i.sent(),C.warning("Failed to get permissions on [".concat(s.join(", "),"] over scope '").concat(t,"'.")),[4,P()];case 7:return[2]}}))}))}t.validateTemplate=function(e,r){return __awaiter(void 0,void 0,void 0,(function(){var a,n,s,o,i,c,l;return __generator(this,(function(u){switch(u.label){case 0:(a=MsPortalFx.clone(r,!0,!0)).deploymentMode=4,a.suppressDefaultNotifications=!0,a.validateTemplate=!0,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,(0,t.startDeploymentImpl)(e,{template:a,track:{},stack:null})];case 2:return n=u.sent(),o=n.template,i=n.track,[2,__assign(__assign({},o),i)];case 3:throw s=u.sent(),o=s.template,i=s.track,c=s.error,l=s.details,__assign(__assign({error:c,details:l},o),i);case 4:return[2]}}))}))};t.initialStackSetup=function(e){var t=e.template,r=e.track,a=e.stack;try{var s=a.launchingContext,o=a.telemetryId=a.telemetryId||(null==s?void 0:s.telemetryId);MsPortalFx.isUndefined(o)&&(o=a.telemetryId=(0,n.getUniqueId)()),r.deploymentStatusCode=0,r._retryAfter=[]}catch(e){ee(t,e,T.InitialSetup)}return{track:r,template:t,stack:a}};t.initialTemplateSetup=function(e){var t=e.template,r=e.track,a=e.stack;try{var s=void 0;MsPortalFx.isUndefined(s=t.skipPreflight)&&(s=t.skipPreflight=!1),MsPortalFx.isUndefined(t.validateTemplate)&&(t.validateTemplate=!s),!V||t.templateLinkUri||t.templateLink||t.resourceGroupName&&(t.resourceGroupWrap={});var o=t.deploymentMode,i=t.launchingContext||{},c=t.telemetryId=t.telemetryId||i.telemetryId;MsPortalFx.isUndefined(c)&&(c=t.telemetryId=(0,n.getUniqueId)()),MsPortalFx.isUndefined(t.submitDeployment)&&(t.submitDeployment=4!==o),MsPortalFx.isUndefined(t.getAllOperations)&&(t.getAllOperations=3===o),MsPortalFx.isUndefined(t.pollForUpdates)&&(t.pollForUpdates=[2,3].includes(o)),r.deploymentStatusCode=0,r._retryAfter=[]}catch(e){ee(t,e,T.InitialSetup)}return{track:r,template:t,stack:a}};t.templateSanity=function(e){var t,r,a=e.template,n=e.track,s=e.stack;try{var o=function(e){return(e||"").toString()};a||be({template:a,track:n,stack:s},A.optionsUndefined);var c=Ie(a.subscriptionId),l=!!a.resourceGroupName;!c&&l&&be({template:a,track:n,stack:s},A.subscriptionIdUndefined,a.subscriptionId||"");var p=a.deploymentName;Ie(p)||be({template:a,track:n,stack:s},A.deploymentNameUndefined,p||"");var d=a.parametersLinkUri;if(d&&((a.parameters||a.referenceParameters)&&be({template:a,track:n,stack:s},A.parametersLinkAndParameters),Ie(d)||be({template:a,track:n,stack:s},A.uriNotAString,o(d),"parametersLinkUri")),a.parameters&&a.referenceParameters){var m=MsPortalFx.find(Object.keys(a.parameters),(function(e){return Object.keys(a.referenceParameters).some((function(t){return e===t}))}));m&&be({template:a,track:n,stack:s},A.duplicateKey,m)}var v=(null===(t=a.templateLink)||void 0===t?void 0:t.id)||(null===(r=a.templateLink)||void 0===r?void 0:r.uri)||a.templateLinkUri;1===[!!Object.keys(a.templateLink||{}).length,!!a.templateLinkUri,!!a.templateJson].filter(MsPortalFx.identity).length||be({template:a,track:n,stack:s},A.templateLinkAndJson),v&&!Ie(v)&&be({template:a,track:n,stack:s},A.uriNotAString,o(v),"templateLinkUri");var k=a.resourceId,y=i.ArmId.parse(k,!0);k&&!u.ResourceArmIdKindMap[y.kind]&&4!==y.kind&&be({template:a,track:n,stack:s},A.invalidResourceId,o(k));var g=a.resourceProviders;!g||Array.isArray(g)&&!g.some((function(e){return!Ie(e)}))||be({template:a,track:n,stack:s},A.invalidResourceProviders,o(g))}catch(e){ee(a,e,T.SanityCheck,!0)}return a};t.sanity=function(e){var t=e.template,r=e.track,a=e.stack;t||a||be({template:t,track:r,stack:a},A.optionsUndefined)};t.stackSanity=function(e){var t=e.template,r=e.track,a=e.stack;try{var n=function(e){return(e||"").toString()},s=a.stackName,o=a.template,c=a.scope,l=a.parameters,p=a.updateBehavior,d=a.actionOnUnmanage,m=a.resourceProviders,v=a.primaryResourceId;Ie(c)||be({template:t,track:r,stack:a},A.scopeUndefined,c||""),Ie(p)||d||be({template:t,track:r,stack:a},A.actionOnUnmanagedUndefined,p||""),Ie(s)||be({template:t,track:r,stack:a},A.stackNameUndefined,s||"");var k=1===["uri"in l,"json"in l].filter(MsPortalFx.identity).length;k||be({template:t,track:r,stack:a},A.parametersLinkAndParameters),"uri"in l&&!Ie(l.uri)&&be({template:t,track:r,stack:a},A.uriNotAString,n(l.uri),"parameters.uri"),(k=1===["uri"in o,"json"in o,"id"in o].filter(MsPortalFx.identity).length)||be({template:t,track:r,stack:a},A.templateLinkAndJson),"uri"in o&&!Ie(o.uri)&&be({template:t,track:r,stack:a},A.uriNotAString,n(o.uri),"template.uri");var y=i.ArmId.parse(v,!0);v&&!u.ResourceArmIdKindMap[y.kind]&&4!==y.kind&&be({template:t,track:r,stack:a},A.invalidPrimaryResourceId,n(v)),!m||Array.isArray(m)&&!m.some((function(e){return!Ie(e)}))||be({template:t,track:r,stack:a},A.invalidResourceProviders,n(m))}catch(e){te(a,e,T.SanityCheck,!0)}return a};var X=function(e,r,a){return __awaiter(void 0,[e,r,a],void 0,(function(e,r,a){var s=r.template,o=r.stack;return __generator(this,(function(r){return s?[2,(0,t.provisionTemplateResourceGroup)(e,{template:s},a)]:(null==o?void 0:o.deploymentScope)&&(0,n.isFeatureEnabled)("byoStackTemplate")?[2,$(e,{stack:o})]:[2]}))}))},$=function(e,t){return __awaiter(void 0,[e,t],void 0,(function(e,t){var r,a,n,s,o,c,u,d,v=t.stack;return __generator(this,(function(t){switch(t.label){case 0:r=i.ArmId.parse(v.deploymentScope),n=(a=r||{}).resourceGroup,s=a.subscription,t.label=1;case 1:return t.trys.push([1,3,,6]),[4,(0,m.getArmResource)((0,l.resourceGroupApi)(i.ArmId.stringify({resourceGroup:n,subscription:s,kind:4})),"".concat("Deploy.").concat("createRG",".checkExistence"))];case 2:return o=t.sent(),c=(0,m.getProvisioningState)(o),M[c]&&(u=new Error("Cannot deploy to resource group ".concat(n,": ").concat(c,".")),te(v,u,T.ProvisionResourceGroup,!0)),[3,6];case 3:return de(d=t.sent())&&404===d.httpStatusCode?[4,(0,p.createResourceGroup)(e,s,n,v.location,"".concat("Deploy.").concat("createRG",".stack}"))]:[3,5];case 4:return t.sent(),C.verbose("Resource group ".concat(n," created.")),[2,v];case 5:throw d;case 6:return[2]}}))}))};t.provisionTemplateResourceGroup=function(e,t,r){return __awaiter(void 0,[e,t,r],void 0,(function(e,t,r){var a,s,o,c,u,d,v,k,g,f,h,_,b,P=t.template;return __generator(this,(function(t){switch(t.label){case 0:if(a=P.resourceGroupName,!(s=P.subscriptionId)||!a)return[2,P];o=(0,l.resourceGroupApi)(i.ArmId.stringify({resourceGroup:a,subscription:s,kind:4},4)),t.label=1;case 1:t.trys.push([1,14,,15]),t.label=2;case 2:if(t.trys.push([2,10,,13]),c=void 0,!(0,n.isFeatureEnabled)("armTokenTest")&&!p.allowlistedExtensions[FxImpl.postBootEnv.extensionName])return[3,7];t.label=3;case 3:return t.trys.push([3,5,,6]),[4,y.ResourceManager.internalDeploymentHelper.invoke(I.client,S.Constants.Shell,{options:0,setTelemetryHeader:"".concat("Deploy.").concat("createRG",".checkExistence"),type:"GET",uri:o})];case 4:return u=t.sent(),c=u.content,[3,6];case 5:throw d=t.sent(),JSON.parse(d.message);case 6:return[3,9];case 7:return[4,(0,m.getArmResource)(o,"".concat("Deploy.").concat("createRG",".checkExistence"))];case 8:c=t.sent(),t.label=9;case 9:return v=(0,m.getProvisioningState)(c),M[v]&&(f=new Error("Cannot deploy to resource group ".concat(a,": ").concat(v,".")),ee(P,f,T.ProvisionResourceGroup,!0)),C.verbose("Resource group ".concat(a," already exists.")),[3,13];case 10:return de(k=t.sent())&&404===k.httpStatusCode?r?(P.resourceGroupWrap&&(P.resourceGroupWrap.create=!0),[2,P]):[4,(0,p.createResourceGroup)(e,P.subscriptionId,P.resourceGroupName,P.resourceGroupLocation||P.location,"".concat("Deploy.").concat("createRG",".template}"))]:[3,12];case 11:return t.sent(),C.verbose("Resource group ".concat(a," created.")),[2,P];case 12:throw k;case 13:return[3,15];case 14:return g=t.sent(),f=void 0,h=!1,(_=de(g))?f=g.content.error:(f=g.error,h=g.expected),b="message"in(g||{})?g.message:null==f?void 0:f.message,_&&403===g.httpStatusCode&&(b="Unauthorized access to resource group ".concat(a,": ").concat(b),h=!0),C.verbose(b),ee(P,f,T.ProvisionResourceGroup,h,f),[3,15];case 15:return[2,P]}}))}))};t.registerResourceProviders=function(e){return __awaiter(void 0,[e],void 0,(function(e){var t,r,a,n=e.template,s=e.stack;return __generator(this,(function(e){switch(e.label){case 0:if(t=null==n?void 0:n.subscriptionId,s&&(r=i.ArmId.parse(s.scope).subscription,t=r?i.ArmId.stringify({subscription:r,kind:1},1):t),!t)return[2,{template:n,stack:s}];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,(0,d.registerResourceProviders)(t,(null==n?void 0:n.resourceProviders)||(null==s?void 0:s.resourceProviders)||[])];case 2:return e.sent(),[3,4];case 3:return a=e.sent(),ee(n,Z(a),T.RegisterResourceProviders),[3,4];case 4:return[2,{template:n,stack:s}]}}))}))};t.validateAssetType=function(e,t){return __awaiter(void 0,[e,t],void 0,(function(e,t){var r,a,n,s,i,c,l,u,p,d,m,v,k,f,h=t.template,_=t.stack,b=t.track;return __generator(this,(function(t){switch(t.label){case 0:return(r=(null==h?void 0:h.assetType)||(null==_?void 0:_.assetType))?(a=r.toLowerCase(),[4,(n=e.get(g.ExtensionTelemetry)).extensionName]):[2,b];case 1:return"microsoft_azure_createuidef"!==(s=t.sent().toLowerCase())?[3,3]:[4,n.getBladeId()];case 2:(c=t.sent())&&c.endsWith("_dx")&&(l=c.toLowerCase().split("/")).length&&"extension"===l[0]&&(i=l[1]),t.label=3;case 3:return t.trys.push([3,5,,6]),p=void 0,[4,y.AssetTypes.getAssetTypesInformationEndPoint.invoke(FxImpl.Rpc.client,"fxw",void 0)];case 4:for(d=t.sent(),m=0,v=d;m<v.length;m++)if((k=v[m]).lowerCaseAssetType===a&&(i&&k.lowerCaseExtension===i||k.lowerCaseExtension===s)){p="".concat(k.extensionName,">").concat(k.assetType);break}return p?b.postProvisioning=__assign(__assign({},b.postProvisioning),{assetTypeId:p}):u=new o.FxError('Asset type "'.concat(r,'" could not be verified. Error details: AssetNotFound')),[3,6];case 5:return f=t.sent(),u=new o.FxError({message:'Asset type "'.concat(r,'" could not be verified. Error details: ').concat(MsPortalFx.getLogFriendlyMessage(f)),innerErrors:f}),[3,6];case 6:return u&&C.error(u),[2,b]}}))}))};t.getDeploymentName=function(e){return __awaiter(void 0,[e],void 0,(function(e){var t,r,a=e.template,n=e.stack,s=e.track;return __generator(this,(function(e){switch(e.label){case 0:if(!a)return[2,{template:a,stack:n,track:s}];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,me(a.deploymentName,{template:a,stack:n,track:s},0)];case 2:return t=e.sent(),a.deploymentName=t,[3,4];case 3:return r=e.sent(),ee(a,r,T.GetDeploymentName),[3,4];case 4:return[2,{template:a,stack:n,track:s}]}}))}))};t.notifyProgress=function(e,t){var r,a=e.track,n=e.template;if(n&&"notify"in n){var s=a.deployment,o=null!==(r=null==s?void 0:s.properties)&&void 0!==r?r:{};n.notify({deploymentStatusCode:a.deploymentStatusCode,subscriptionId:n.subscriptionId,deploymentName:n.deploymentName,resourceGroupName:n.resourceGroupName,location:n.location,managementGroupId:n.managementGroupId,resourceId:n.resourceId,requestTimestamp:a.requestTimestamp,deployment:s,correlationId:o.correlationId,provisioningState:o.provisioningState,timestamp:o.timestamp,operations:t,templateJson:n.templateJson,templateLink:n.templateLink,templateLinkUri:n.templateLinkUri,resourceProviders:n.resourceProviders})}};t.submitDeploymentRequest=function(e,r){return __awaiter(this,arguments,void 0,(function(e,r){var a,n=e.template,s=e.track,o=e.stack;return __generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),pe(I.client,{template:n,track:s,stack:o},1,r),n?[4,ae({track:s,template:n,stack:o},r)]:[3,2];case 1:e.sent(),e.label=2;case 2:return o?[4,ne({track:s,template:n,stack:o},r)]:[3,4];case 3:e.sent(),e.label=4;case 4:return[3,6];case 5:if(a=e.sent(),he({template:n,track:s,stack:o}),!MsPortalFx.isUndefined(a.stage))throw a;return(0,t.buildTemplateFailureFromBatchItemError)(n,T.SubmitDeploymentRequest,a),[3,6];case 6:return[2,{template:n,track:s,stack:o}]}}))}))};t.validateStackImpl=function(e){return __awaiter(this,arguments,void 0,(function(e){var r,a,n,s,o,i=e.track,l=e.stack;return __generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),r=z({stack:l,track:i}),a=W({stack:l,track:i}),i.stackDeploymentRequest=se(l,a,i),n=MsPortalFx.clone(i.stackDeploymentRequest,!0),[4,(0,t.validateAsyncImpl)({content:n,options:9,setTelemetryHeader:"Deploy.validate",type:"POST",uri:(0,c.validateDeploymentApi)(r,l.stackName,!0)})];case 1:return s=e.sent(),l.validationResult=s.content,[3,3];case 2:return o=e.sent(),(0,t.buildStackFailureFromBatchItemError)(l,T.ValidateTemplate,o),[3,3];case 3:return[2,l]}}))}))};t.validateTemplateImpl=function(e){return __awaiter(this,arguments,void 0,(function(e){var r,a,s,o,i,l,u=this,d=e.template,m=e.track,v=e.stack;return __generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),d.resourceGroupName,d.location,r=__rest(d,["resourceGroupName","location"]),m.deploymentRequest=ve({template:d,track:m,stack:v}),a=MsPortalFx.clone(m.deploymentRequest,!0),s=z({stack:v,track:m,template:(null===(l=d.resourceGroupWrap)||void 0===l?void 0:l.create)?r:d}),o=d,[4,__awaiter(u,void 0,void 0,(function(){var e,r;return __generator(this,(function(o){switch(o.label){case 0:if(!(0,n.isFeatureEnabled)("armTokenTest")&&!p.allowlistedExtensions[FxImpl.postBootEnv.extensionName])return[3,5];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,y.ResourceManager.internalDeploymentHelper.invoke(I.client,S.Constants.Shell,{content:a,options:9,setTelemetryHeader:"Deploy.validate",retryStatusCodes:d.validateRetry,type:"POST",uri:(0,c.validateDeploymentApi)(s,d.deploymentName)})];case 2:return e=o.sent(),[3,4];case 3:throw r=o.sent(),JSON.parse(r.message);case 4:return[3,7];case 5:return[4,(0,t.validateAsyncImpl)({content:a,options:9,retryStatusCodes:d.validateRetry,setTelemetryHeader:"Deploy.validate",type:"POST",uri:(0,c.validateDeploymentApi)(s,d.deploymentName)})];case 6:e=o.sent(),o.label=7;case 7:return[2,e.content]}}))}))];case 1:return o.validationResult=e.sent(),[3,3];case 2:return i=e.sent(),(0,t.buildTemplateFailureFromBatchItemError)(d,T.ValidateTemplate,i),[3,3];case 3:return[2,d]}}))}))};t.validateAsyncImpl=function(e){return __awaiter(this,void 0,void 0,(function(){var t,r,a,o,i,c=this;return __generator(this,(function(l){switch(l.label){case 0:return t=e.options,r=e.setTelemetryHeader,r+="Poll",a=0,o=function(e){return __awaiter(c,void 0,void 0,(function(){var i;return __generator(this,(function(c){switch(c.label){case 0:return 202===e.httpStatusCode?[3,1]:[3,4];case 1:return[4,(0,n.delay)(1e3*parseInt(e.headers["Retry-After"]||"5"))];case 2:return c.sent(),[4,s.batch({options:t,setTelemetryHeader:r+(a++||""),uri:e.headers.Location,type:"GET"})];case 3:return i=c.sent(),[2,o(i)];case 4:return[2,e]}}))}))},[4,s.batch(e)];case 1:return i=l.sent(),[2,o(i)]}}))}))};t.startDeploymentImpl=function(e,r){return __awaiter(this,arguments,void 0,(function(e,r){var a,n,s,o,i,c,l,u,p,d,m,v,k,y,g=r.template,f=r.track,h=r.stack;return __generator(this,(function(r){switch(r.label){case 0:g=g&&__assign({location:g.resourceGroupLocation},g),a=new Date,r.label=1;case 1:return r.trys.push([1,8,,10]),(0,t.sanity)({template:g,track:f,stack:h}),g?(g=(0,t.templateSanity)({template:g,track:f,stack:h}),m=(0,t.initialTemplateSetup)({template:g,track:f,stack:h}),g=m.template,f=m.track,h=m.stack,[4,ce(e,{template:g,track:f,stack:h},a)]):[3,3];case 2:g=r.sent(),r.label=3;case 3:return h?(h=(0,t.stackSanity)({template:g,track:f,stack:h}),v=(0,t.initialStackSetup)({template:g,track:f,stack:h}),g=v.template,f=v.track,h=v.stack,[4,le(e,{template:g,track:f,stack:h})]):[3,5];case 4:f=r.sent(),r.label=5;case 5:return[4,ie({template:g,track:f,stack:h},a)];case 6:return r.sent(),[4,oe({template:g,track:f,stack:h},a)];case 7:return n=r.sent(),[2,3].includes(null==g?void 0:g.deploymentMode)&&(g=n.template,f=n.track,h=n.stack),[3,10];case 8:return s=r.sent(),o=s.error||{},i=o.message,c=o.name,l=o.details,u=o.code,p=__assign(__assign({},s),{error:{code:u,details:l,message:i,name:c,stack:null===(y=null===(k=null==s?void 0:s.error)||void 0===k?void 0:k.stack)||void 0===y?void 0:y.slice(0,6e3)}}),[4,pe(I.client,{template:g,track:f,stack:h},4,a,p)];case 9:throw d=r.sent(),__assign(__assign({},p),{notificationTimestamp:d});case 10:return[2,{template:g,track:f,stack:h}]}}))}))};t.pollDeployment=function(e,t,r){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(a){return t=JSON.parse(JSON.stringify(t)),[2,y.ResourceManager.pollDeploymentEndPoint.invoke(e,S.Constants.Shell,{options:t,date:r}).catch(A.deployTemplateFailure)]}))}))};function Y(e){var t;return(null!==(t=null==e?void 0:e.properties)&&void 0!==t?t:{}).error}function Z(e){return e?(e.jqXHR&&(e=D.buildSimplifiedError(e.jqXHR)),0!==e.status||e.code||(e.code="ClientNetworkError"),e):e}function ee(e,t,r,a,n){throw{deploymentStatusCode:-1,stage:r,expected:!!a,error:t,subscriptionId:(e=e||{}).subscriptionId,resourceGroupName:e.resourceGroupName,location:e.location,deploymentName:e.deploymentName,details:n||void 0}}function te(e,t,r,a,n){throw{deploymentStatusCode:-1,stage:r,expected:!!a,error:t,scope:(e=e||{}).scope,updateBehavior:e.updateBehavior,location:e.location,stackName:e.stackName,marketplaceItemId:e.marketplaceItemId,details:n||void 0}}function re(e){var t,r,a=e;if(null===(r=null===(t=null==a?void 0:a.error)||void 0===t?void 0:t.details)||void 0===r?void 0:r.find((function(e){var t=e.code,r=e.additionalInfo;return"RequestDisallowedByPolicy"===t&&r})))return!0}t.fulfillPrerequisites=function(e,r,a,n){return __awaiter(this,arguments,void 0,(function(e,r,a,n){var s,o,i,c=r.template,l=r.track,u=r.stack;return __generator(this,(function(r){switch(r.label){case 0:pe(I.client,{template:c,track:l,stack:u},0,a),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,Promise.allSettled([X(e,{template:c,track:l,stack:u},n),(0,t.registerResourceProviders)({template:c,stack:u}),(0,t.getDeploymentName)({template:c,stack:u,track:l}),(0,t.validateAssetType)(e,{template:c,stack:u,track:l}).then((function(e){return l=e}))])];case 2:if(s=r.sent(),o=MsPortalFx.find(s,(function(e){return"rejected"===e.status})))throw o.reason;return[3,4];case 3:if(i=r.sent(),!MsPortalFx.isUndefined(i.stage))throw i;return ee(c,i,T.FulfillPrerequisites),[3,4];case 4:return[2,{template:c,stack:u,track:l}]}}))}))};t.buildTemplateFailureFromBatchItemError=function(e,t,r){var a=null==r?void 0:r.content;re(a)&&_e(a);var n=(null==a?void 0:a.error)||a;ee(e,Z(n),t,r.httpStatusCode>=400&&r.httpStatusCode<500,n)};function ae(e,t){return __awaiter(this,arguments,void 0,(function(e,t){var r,a,o,i,l,u,d,v,k=e.track,g=e.template,f=e.stack;return __generator(this,(function(e){switch(e.label){case 0:return r=k.deploymentRequest,g.resourceGroupName,g.location,a=__rest(g,["resourceGroupName","location"]),r||(r=k.deploymentRequest=ve({template:g,track:k})),o=z({track:k,template:(null===(v=g.resourceGroupWrap)||void 0===v?void 0:v.create)?a:g}),i=k.deploymentUri=(0,c.getDeploymentApi)(o,g.deploymentName),(null==g?void 0:g.validationResult)&&(r.properties.validationLevel="Template"),k._startDeploymentTs=Date.now(),(0,n.isFeatureEnabled)("armTokenTest")||p.allowlistedExtensions[FxImpl.postBootEnv.extensionName]?[4,y.ResourceManager.internalDeploymentHelper.invoke(I.client,S.Constants.Shell,{content:r,options:1,setTelemetryHeader:"".concat("Deploy.").concat("submitDeployment"),type:"PUT",uri:i}).catch((function(e){throw JSON.parse(e.message)}))]:[3,2];case 1:return l=e.sent(),[3,4];case 2:return[4,s.batch({content:r,options:1,setTelemetryHeader:"".concat("Deploy.").concat("submitDeployment"),type:"PUT",uri:i})];case 3:l=e.sent(),e.label=4;case 4:return u=l.content,he({template:g,track:k,stack:f}),(0,m.getProvisioningState)(u)!==E.Accepted&&((d=new Error("Deployment not accepted.")).details=u,ee(g,d,T.SubmitDeploymentRequest,!1,{message:d.message})),k.deployment=u,k.postProvisioning&&(k.postProvisioning.id=u.id),pe(I.client,{template:g,track:k,stack:f},2,t),[2]}}))}))}function ne(e,t){return __awaiter(this,arguments,void 0,(function(e,t){var r,a,n,o,i,l,u,p,d,m,v,k,y,g=e.track,f=e.stack;return __generator(this,(function(e){switch(e.label){case 0:return r=z({stack:f,track:g}),a=W({stack:f,track:g}),n=g.deploymentUri=(0,c.getDeploymentStacksApi)(r,f.stackName),o=se(f,a,g),g._startDeploymentTs=Date.now(),[4,s.batch({content:o,options:1,setTelemetryHeader:"".concat("Deploy.").concat("submitDeployment"),type:"PUT",uri:n})];case 1:if(i=e.sent(),l=i.headers,u=i.content,p=l["Azure-AsyncOperation"],d=u.properties.provisioningState,!l["Retry-After"]||!p)return[3,6];m=1,e.label=2;case 2:return[4,new Promise((function(e){return setTimeout(e,1e3*parseInt(l["Retry-After"]))}))];case 3:return e.sent(),[4,s.batch({options:1,setTelemetryHeader:"".concat("Deploy.").concat("submitDeployment",".PollAsync").concat(m++),type:"GET",uri:p})];case 4:v=e.sent(),d=null===(y=null==v?void 0:v.content)||void 0===y?void 0:y.status,e.label=5;case 5:if(!N[d.toLowerCase()]&&d!==E.Deploying)return[3,2];e.label=6;case 6:return he({track:g,stack:f}),[E.Accepted,E.Succeeded,E.Deploying].includes(d)||((k=new Error("Deployment not accepted.")).details=u,te(f,k,T.SubmitDeploymentRequest,!1,{message:k.message})),g.deployment=u,g.postProvisioning&&(g.postProvisioning.id=u.id),pe(I.client,{track:g,stack:f},2,t),[2]}}))}))}function se(e,t,r){var a,n=e.actionOnUnmanage;if(!n){var s="PurgeResources"===e.updateBehavior?"delete":"detach";n={resources:s,resourceGroups:s,managementGroups:s}}return __assign(__assign({},2===t?{}:{location:e.location}),{properties:__assign(__assign(__assign(__assign(__assign(__assign({debugSetting:{detailLevel:"none"},actionOnUnmanage:n},"denySettings"in e?{denySettings:e.denySettings}:{denySettings:{mode:"none"}}),"bypassStackOutOfSyncError"in e?{bypassStackOutOfSyncError:e.bypassStackOutOfSyncError}:{}),"description"in e?{description:e.description}:{}),"deploymentScope"in e?{deploymentScope:e.deploymentScope}:{}),"json"in e.parameters?{parameters:e.parameters.json}:{parametersLink:e.parameters}),"json"in e.template?{template:e.template.json}:{templateLink:e.template}),tags:Se({primaryResourceId:e.primaryResourceId,assetTypeId:null===(a=r.postProvisioning)||void 0===a?void 0:a.assetTypeId})})}function oe(e,r){return __awaiter(this,arguments,void 0,(function(e,r){var a,n,s,o=e.template,i=e.track,c=e.stack;return __generator(this,(function(e){switch(e.label){case 0:if(!(8&(null==c?void 0:c.deploymentMode)||o&&(null==o?void 0:o.pollForUpdates)))return[3,5];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,(0,t.pollDeployment)(I.client,{template:o,track:i,stack:c},r)];case 2:if("error"in(a=e.sent()))throw{stage:a.stage||T.GetDeploymentStatus,error:a.error};switch(n=q,[2,3].includes(null==o?void 0:o.deploymentMode)&&(o=a.template,i=a.track,c=a.stack),(0,m.getProvisioningState)(i.deployment)){case E.Succeeded:n=O;break;case E.Canceled:case E.Deleted:n=L}return fe({template:o,track:i,stack:c},j,n,T.GetDeploymentStatus),[2,{template:o,track:i,stack:c}];case 3:throw s=e.sent(),fe({template:o,track:i,stack:c},j,q,s.stage,s),s;case 4:return[3,7];case 5:return[4,pe(I.client,{template:o,track:i,stack:c},3,r)];case 6:return e.sent(),[2,{template:o,track:i,stack:c}];case 7:return[2]}}))}))}function ie(e,r){return __awaiter(this,arguments,void 0,(function(e,r){var a,n,s=e.template,o=e.track,i=e.stack;return __generator(this,(function(e){switch(e.label){case 0:if(!(8&(null==i?void 0:i.deploymentMode)||(null==s?void 0:s.submitDeployment)))return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,(0,t.submitDeploymentRequest)({template:s,track:o,stack:i},r)];case 2:return n=e.sent(),s=n.template,o=n.track,i=n.stack,fe({template:s,track:o,stack:i},J,O,T.SubmitDeploymentRequest),!s||s.deploymentMode&&1!==s.deploymentMode?(0,t.notifyProgress)({template:s,track:o,stack:i},null):fe({template:s,track:o,stack:i},j,L,T.SubmitDeploymentRequest),[3,4];case 3:throw a=e.sent(),fe({template:s,track:o,stack:i},J,q,a.stage,a),a;case 4:return[2]}}))}))}function ce(e,r,a){return __awaiter(this,arguments,void 0,(function(e,r,a){var n,s,o,i,c=r.template,l=r.track,u=r.stack;return __generator(this,(function(r){switch(r.label){case 0:if(c.skipPreflight)return[3,6];n=function(e){var t=e.template,r=e.track,a=e.stack,n=ke({template:t,track:r,stack:a},T.InitialSetup);return r._startPreflightTs=Date.now(),w.startTrace({source:G,action:B,actionModifier:L,name:n.galleryItemId||t.deploymentName,data:n})}({template:c,track:l,stack:u}),s=u&&4&u.deploymentMode||c&&c.validateTemplate,r.label=1;case 1:return r.trys.push([1,5,,6]),[4,(0,t.fulfillPrerequisites)(e,{template:c,track:l,stack:u},a,V&&!(c.templateLinkUri||c.templateLink)&&4===c.deploymentMode)];case 2:return i=r.sent(),c=i.template,u=i.stack,l=i.track,c.validateTemplate?[4,(0,t.validateTemplateImpl)({template:c,track:l,stack:u})]:[3,4];case 3:c=r.sent(),r.label=4;case 4:return n&&ge(n,{template:c,track:l,stack:u},!s),[3,6];case 5:throw o=r.sent(),n&&ge(n,{template:c,track:l,stack:u},!s,o),o;case 6:return[2,c]}}))}))}function le(e,r){return __awaiter(this,arguments,void 0,(function(e,r){var a,n,s,o,i=r.template,c=r.track,l=r.stack;return __generator(this,(function(r){switch(r.label){case 0:return a=X(e,{template:i,track:c,stack:l},!1),4&l.deploymentMode?[4,(0,t.validateStackImpl)({template:i,track:c,stack:l})]:[3,2];case 1:l=r.sent(),r.label=2;case 2:return l.assetType?[3,4]:[4,a];case 3:return r.sent(),[2,c];case 4:n=ke({template:i,track:c,stack:l},T.FulfillPrerequisites),c._startPreflightTs=Date.now(),s=w.startTrace({source:G,action:B,actionModifier:L,name:n.galleryItemId||l.stackName,data:n}),r.label=5;case 5:return r.trys.push([5,8,,9]),[4,(0,t.validateAssetType)(e,{template:i,track:c,stack:l})];case 6:return c=r.sent(),[4,a];case 7:return r.sent(),w.endTrace(s,O,ke({template:i,track:c,stack:l},R.DeploymentStages.FulfillPrerequisites)),[3,9];case 8:throw o=r.sent(),w.endTrace(s,O,ke({template:i,track:c,stack:l},R.DeploymentStages.FulfillPrerequisites,o)),o;case 9:return[2,c]}}))}))}function ue(e,r,a){var n=MsPortalFx.clone(r,!0,!0);return a&&(n.skipPreflight=!0,n.submitDeployment=!1,n.pollForUpdates=!0),Q.promise((function(r,a,s){n.notify=s,(0,t.startDeploymentImpl)(e,{template:n,track:{},stack:null}).then((function(e){var t,a,n,s,o,i=e.track,c=e.template;delete c.notify;var l=null===(a=null===(t=i.deployment)||void 0===t?void 0:t.properties)||void 0===a?void 0:a.timestamp,u=null==i?void 0:i.requestTimestamp,p={correlationId:null===(s=null===(n=i.deployment)||void 0===n?void 0:n.properties)||void 0===s?void 0:s.correlationId,deploymentName:null===(o=i.deployment)||void 0===o?void 0:o.name,operations:i.operations,deploymentStatusCode:i.deploymentStatusCode,provisioningState:(0,m.getProvisioningState)(i.deployment),resourceGroupName:c.resourceGroupName,subscriptionId:c.subscriptionId,debug:c.debug,launchingContext:c.launchingContext,managementGroupId:c.managementGroupId,provisioningHash:c.provisioningHash,resourceId:c.resourceId,assetType:c.assetType,timestamp:l&&new Date(l),requestTimestamp:u&&new Date(u)};r(p)})).catch(a)}))}function pe(e,t,r,a,n){var s=(t=JSON.parse(JSON.stringify(t))).stack,o=t.template,i=t.track;return y.ResourceManager.notifyDeploymentEndPoint.invoke(e,S.Constants.Shell,{options:{stack:s,template:o,track:i},stage:r,failure:n,date:a}).catch(A.deployTemplateFailure)}function de(e){return!!e.httpStatusCode}function me(e,t){return __awaiter(this,arguments,void 0,(function(e,t,r){var a,n,s,i,l,u,p,d=t.stack,v=t.track,k=t.template;return void 0===r&&(r=0),__generator(this,(function(t){switch(t.label){case 0:e.length>64&&(e=e.slice(0,64)),a=e,r&&(n="_"+r,a=e.slice(0,64-n.length)+n),t.label=1;case 1:return t.trys.push([1,4,,5]),k.resourceGroupName,k.location,s=__rest(k,["resourceGroupName","location"]),i=z({stack:d,track:v,template:(null===(p=k.resourceGroupWrap)||void 0===p?void 0:p.create)?s:k}),[4,(0,m.getArmResource)((0,c.getDeploymentApi)(i,a),"".concat("Deploy.").concat("getDepName"))];case 2:return l=t.sent(),N[(0,m.getProvisioningState)(l)]?[2,a]:[4,me(e,{stack:d,template:k,track:v},++r)];case 3:return[2,t.sent()];case 4:return de(u=t.sent())&&404!==u.httpStatusCode&&C.warning(new o.FxError({message:"Failed to get deployment with name ".concat(a,". Proceeding with ").concat(e,". Returned error: ").concat(MsPortalFx.getLogFriendlyMessage(u.content)),innerErrors:[u.content]})),[2,a];case 5:return[2]}}))}))}function ve(e){var t,r=e.template,a=e.track,s={mode:"incremental",debugSetting:{detailLevel:"none"}};if(Ie(r.parametersLinkUri))s.parametersLink={uri:r.parametersLinkUri};else{var o={};(0,n.forEachKey)(r.parameters,(function(e,t){o[e]={value:t}})),(0,n.forEachKey)(r.referenceParameters,(function(e,t){o[e]={reference:t}})),s.parameters=o}var i=r.templateJson;if(i){var c;try{if(Ie(i)){c="Invalid JSON. ";var l=[];i=(0,h.parse)(i,l),l.length&&(l.forEach((function(e){return c+="".concat((0,h.printParseErrorCode)(e.error)," at position ").concat(e.offset,". ")})),be({template:r,track:a},A.parsingTemplateJson,c))}else c="Non-serializable object",i=ko.toJS(i)}catch(e){be({template:r,track:a},A.parsingTemplateJson,c)}s.template=r.templateJson=i}else r.templateLink?s.templateLink=r.templateLink:r.templateLinkUri&&(s.templateLink={uri:r.templateLinkUri});var u,p=r.provisioningHash,d=(0,v.isValidTagValue)(p);p&&!d.isValid&&(C.error("provisioningHash provided in templateDeploymentOptions is not a valid tag value and will not be persisted as a tag on the deployment. See MsPortalFx.Azure.ResourceManager.DeploymentApiArgs for provisioningHash usage details.",1,{validationResult:d}),p=null);var m=(0,n.getFeatureValue)("deployapiver");if((!m||parseInt(m.slice(0,4))>=2019)&&(u=Se({primaryResourceId:r.resourceId,provisioningHash:p,assetTypeId:null===(t=a.postProvisioning)||void 0===t?void 0:t.assetTypeId,marketplaceItemId:r.marketplaceItemId||(r.launchingContext||{}).galleryItemId})),r.resourceGroupWrap&&r.resourceGroupWrap.create){var k=s.parameters,y=s.template.parameters;return delete s.parameters,MsPortalFx.extend(s,{expressionEvaluationOptions:{scope:"inner"},parameters:Object.keys(k).reduce((function(e,t){return e[t]={value:"[parameters('".concat(t,"')]")},e}),{})}),{location:r.location,properties:{mode:"incremental",debugSetting:{detailLevel:"none"},parameters:k,template:{$schema:"https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",contentVersion:"1.0.0.0",parameters:y,resources:[{type:"Microsoft.Resources/resourceGroups",apiVersion:"2018-05-01",location:r.location,name:r.resourceGroupName,properties:{}},{type:"Microsoft.Resources/deployments",apiVersion:"2019-10-01",properties:s,name:"".concat(r.deploymentName,".nested"),resourceGroup:r.resourceGroupName,dependsOn:[r.resourceGroupName],tags:u}],outputs:{}}}}}return __assign({properties:s,tags:u},r.resourceGroupName?{}:{location:r.location})}function ke(e,t,r){var a,n=e.template,s=e.track,o=e.stack,i=(n||o).launchingContext||{},c=i&&i.galleryItemId,l=null==n?void 0:n.debug,u=__assign(__assign({galleryItemId:c,stage:T[t],bladeInstanceId:i.bladeInstanceId},n?{subscriptionId:n.subscriptionId,telemetryId:n.telemetryId}:{}),o?{scope:o.scope,telemetryId:o.telemetryId}:{}),p=i.source,d=i.createBlade,m=s.deployment,v=m&&m.properties,k=v&&v.correlationId,y=Y(m);return y?a=ye(y,{additionalInfo:!0,details:!0}):r&&(a=D.scrubError(r)),p&&(u.context=p),k&&(u.correlationId=k),d&&(u.createBlade=d),l&&(u.debug=l),a&&(u.details=a),s._pollingStats&&(u.pollingStats=s._pollingStats),!n||n.deploymentMode&&1!==n.deploymentMode||(u.pollForUpdates=!1),u}function ye(e,t){var r={};return(0,n.forEachKey)(e,(function(e,a){t[e]||(r[e]=a&&"object"==typeof a?ye(a,t):a)})),r}function ge(e,t,r,a){var n=t.track,s=t.template,o=t.stack;n._endPreflightTs=Date.now();var i=r?T.FulfillPrerequisites:T.ValidateTemplate;w.endTrace(e,a?q:O,ke({template:s,track:n,stack:o},i,a))}function fe(e,t,r,a,n){var s=e.template,o=e.track,i=e.stack,c=ke({template:s,track:o,stack:i},a,n);FxImpl.ProvisioningTelemetry.traceDeployment({source:G,action:t,actionModifier:r,name:c.galleryItemId||(null==s?void 0:s.deploymentName)||(null==i?void 0:i.stackName),data:c})}function he(e){var t=e.template,r=e.track,a=e.stack;t&&(t.parameters={},t.templateJson="{}",t.templateLinkUri="",t.templateLink={},t.validationResult&&delete t.validationResult.properties),(null==r?void 0:r.deploymentRequest)&&delete r.deploymentRequest.properties,a&&(a.parameters={uri:"sanitized"},a.template={uri:"sanitized"})}function _e(e){r.container.get(a.ArmCreateTelemetry).traceComparisonToProvisionedResourceTypes(e.error.details.reduce((function(e,t){var r;return null===(r=null==t?void 0:t.additionalInfo)||void 0===r||r.forEach((function(t){"PolicyViolation"===t.type&&t.info.evaluationDetails.evaluatedExpressions.forEach((function(t){"type"===t.expression&&e.push(t.expressionValue)}))})),e}),[]))}function be(e,t,r,a){var n,s,o=e.template,i=e.track,c=e.stack;he({template:o,track:i,stack:c}),t([(null===(n=null==o?void 0:o.launchingContext)||void 0===n?void 0:n.galleryItemId)||(null===(s=null==c?void 0:c.launchingContext)||void 0===s?void 0:s.galleryItemId)||""].concat([r,a]))}function Ie(e){return!(!e||"string"!=typeof e)}function Se(e){var t=e.primaryResourceId,r=e.assetTypeId,a=e.provisioningHash,n=e.marketplaceItemId,s=Object.create(null),o=new RegExp(".{1,".concat(256,"}"),"g").exec(t||"")||[];return o.length>8&&(C.error("resourceId provided in templateDeploymentOptions is longer than ".concat(2048," characters and will not be persisted as tags on the deployment.")),o.length=0),o.forEach((function(e,t){var r=0===t?"primaryResourceId":"primaryResourceIdExt".concat(t);s[r]=e})),n&&(s.marketplaceItemId=n),a&&(s.provisioningHash=a),r&&(s["hidden-assetTypeId"]=r),s}t.buildStackFailureFromBatchItemError=function(e,t,r){var a=null==r?void 0:r.content;re(a)&&_e(a);var n=(null==a?void 0:a.error)||a;te(e,Z(n),t,r.httpStatusCode>=400&&r.httpStatusCode<500,n)},t.DEV={resetWrapNewRgTemplate:function(){return V=(0,n.isFeatureEnabled)("wrapnewrgtemplate")}}}));
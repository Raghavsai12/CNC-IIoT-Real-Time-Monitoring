define("MsPortalImpl/Base/Base.HierarchyMap",["require","exports"],(function(e,t){"use strict";t.HierarchyMap=void 0;const n="##-##";t.HierarchyMap=class{constructor(){this._observable=ko.observableArray()}addItem(e,t){if(!e||!e.length)throw new Error("Invalid path");if(e.some((e=>!e)))throw new Error("Invalid path segment");if(this._getItemIndex(e)>=0)throw new Error(`Duplicate path '${JSON.stringify(e)}'.`);this._observable.push({path:e,_pathKey:e.join(n),value:t})}removeItem(e){const t=this._getItemIndex(e);t>=0&&this._observable.splice(t,1)}removeItemsInPath(e){const t=[];this._getItemsWithPath(e,!0,((e,n)=>!e&&t.push(n))),this._observable(t)}_getItemIndex(e){const t=e.join(n);return MsPortalFx.findIndex(this._observable.peek(),(e=>e._pathKey===t))}getItem(e){const t=this._getItemIndex(e);return t>=0?this._observable.peek()[t]:null}getItemsInPath(e){return this._getItemsWithPath(e,!0)}getItemsUnderPath(e){return this._getItemsWithPath(e,!1)}getObservable(){return this._observable}_getItemsWithPath(e,t,o){const i=e.join(n);return this._observable.peek().filter((n=>{const s=n._pathKey.startsWith(i)&&(t||n.path.length>e.length);return o&&o(s,n),s}))}}})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Journey",["require","exports","MsPortalImpl/UI/Compositions/UI.Composition.Blade","MsPortalImpl/Base/Base.HierarchyMap","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Finder","MsPortalImpl/Widgets/Widgets.Journey","Fx/ResourceManagement","MsPortalImpl/Widgets/Widgets.Portal.init"],(function(e,t,n,o,i,s,a,r,l,d,c){"use strict";t.Instance=void 0,t.create=function(e,t){return new m(e,t)};var p=s.CompositionType;function u(e,t){return e.id===t.id}class m extends a.Instance{constructor(e,t,n,i,s,a){super("Journey",e,null,n,i,s),this.journeyBlades=ko.observableArray(),this.lastModifiedTime=ko.observable(Date.now()),this.originTile=t,this._updateBladesMetadata(),this._ambientSettings=a||new o.HierarchyMap,this._setupEditScopeReactor(this.originTile)}get ambientSettings(){return this._ambientSettings}getCompositionType(){return p.Journey}getDeepLink(){return this.await(7).then((()=>{const e=this.children,t=e.length;return t?e[t-1].getDeepLink():this.diContainer.get(r.Finder).findPartsContainer(this.originTile).getDeepLink()}))}isStartedWithContextBlade(){const e=this.children;return e.length>0&&!!(1&e[0].flags)}observeEditScopeChanges(e,t){this._observeEditScopeChanges(e,t,!0)}_observeEditScopeChanges(e,t,n){ko.computed(e,(()=>{const e=t.editScopeId&&t.editScopeId();if(e){const o=this.diContainer.get(i.EditScopeManager).getStateObservable(e)(),s=2===o,a=1===o||s,r=t.ownerLocatable.journeyPath,l=this._ambientSettings;if(a){let o;const i=l.getItem(r);if(i){const e=i.value;if(e){const t=e.editScope;!t||t.dirty===a&&t.saving===s||(l.removeItem(r),o=!0)}}else o=!0;o&&l.addItem(r,{type:t.ownerType,editScope:{editScopeId:e,dirty:a,saving:s,disposeOnSelectionChange:t.disposeOnSelectionChange,disposeOnJourneyDiscard:n}})}else l.removeItem(r)}}))}removeChildAt(e,t){super.removeChildAt(e,t),this._updateBladesMetadata()}_addChildrenInternal(e,t){super._addChildrenInternal(e,t),this._updateBladesMetadata()}_setupEditScopeReactor(e){e&&e.await(7).then((()=>{if(!this.isDisposed()&&e.partDefinition.editScopeType){const t=e,n={editScopeId:e.editScopeId,ownerType:e.locator.type,ownerLocatable:e,disposeOnSelectionChange:!1};this._observeEditScopeChanges(t,n,!1)}}))}_updateBladesMetadata(){const e=this.journeyBlades;if(e){const t=e(),n=MsPortalFx.unique(this.children,u);let o=[];t.forEach((e=>{const t=MsPortalFx.find(n,(t=>u(e,t)));t&&(o.push(e),e.subtitle(t.subtitle()),e.title(t.title()))})),o=MsPortalFx.pushUnique(o,n,u),e(o)}}_compose(e,t){if(!e.options.getJourneyWidget()){const t=new l.ViewModel(this.id,(()=>(0,c.getPortalViewModel)(this.diContainer).getRootPageDisplayType()),this.diContainer);this.widget=new l.Widget(e.options.getJourneyArea(),t)}t.resolve()}getCurrentResourceId(){const e=this.children;for(let t=e.length-1;t>=0;t--){const n=e[t].assetId();if(n&&0!==d.ArmId.parse(n,!0).kind)return n}}}t.Instance=m})),
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Handler",["require","exports","MsPortalImpl/UI/Compositions/UI.Composition.Journey","MsPortalImpl/UI/Compositions/UI.Composition.Blade","Fx","Fx/DependencyInjection","Fx/Experimentation","Fx/ResourceManagement","MsPortalImpl/Base/Telemetry","MsPortalImpl/Base/Base.Pipeline","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/UI.ContextPane","MsPortalImpl/UI/UI.JourneyManager","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpenerBase","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.Finder","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/Extension/ViewModelManager","FxInternal"],(function(e,t,n,o,i,s,a,r,l,d,c,p,u,m,g,f,h,I,y,b){"use strict";t.OpenBladeHandler=void 0,t.shouldSkipPromptForBladesWithEdits=D;var v=MsPortalFx.Base.Diagnostics,C=f.mapMasterModelToBladeModel;const M=v.createLog(e),B=MsPortalFx.noop,_=I.getModelValue,P="disablermbrebindresourcetypes",S=c.Locator.forExtension("HubsExtension").withBlade("ResourceMenuBlade");let x=t.OpenBladeHandler=class{constructor(e,t,n,o){this._diContainer=e,this._options=t,this._resources=n,this._bladeRedirector=o}createDescriptor(e,t){const n=t.value;if(void 0!==n&&(!Array.isArray(n)||n.length)){let e=t.timestamp;const i=t.invocationInput.selectableSetV1?n[0]:n,s=!!this._resources.selectable2,{registrationInfo:{invocationInput:a,detailsDefinition:r,additionalInputs:l}}=this._resources,d=C(this._options.masterModelId,i,a);let p=a.opensDynamicBlades?function(e,t,n){const o=t.referenceExtension;return(0,g.mapDynamicSelectionToBladeLocator)(e,n,c.Locator.forExtension(o.name),t.masterModelId)}(this._diContainer,this._options,i):this._resources.detailsBladeLocator;const{container:u}=this._resources;let m,f;p=this._bladeRedirector.applyRedirects(p,d,u instanceof o.Instance&&{bladeDefinition:u.bladeDefinition,locator:u.locator,model:u.getViewModel(1)});let h=!1,I=!!r.asSubJourney,y=!1,b=!1,v=!1,M=!1,B=!1,_=!1,P=!1,S="";a.opensDynamicBlades&&i&&(m=i.openInContextPane,f=i.persistentContextPane,s&&(e=i.timestamp,h=!!(2&i.flags),I=!!(8&i.flags),y=!!(128&i.flags),b=!!(256&i.flags),v=!!(512&i.flags),M=!!(64&i.flags),B=!!(1024&i.flags),_=!!(2048&i.flags),P=!!(4096&i.flags),S=i.telemetryName)),void 0===m&&(m=r.openInContextPane,f=r.persistentContextPane);let x=m?1:0;f&&(x|=2),!h&&(x|=4),I&&(x|=8),y&&(x|=16),b&&(x|=32),v&&(x|=128),M&&(x|=64),B&&(x|=256),_&&(x|=512),P&&(x|=1024);const D={timestamp:e,locator:p,masterInvocationProperty:a.source.property,bindings:l.slice(0),model:d,masterInputKeys:Object.keys(d),masterDetailsDefinition:r,flags:x};l.forEach((e=>{D.model[e.targetProperty]=e.source.constantValue})),this._options.configureBindings&&D.bindings&&D.bindings.length&&this._options.configureBindings(D.bindings),this._options.configureBladeDescriptor(D),i&&(D.openedByContext=i.context,i.defaultMenuItemId&&(D.defaultMenuItemId=i.defaultMenuItemId,D.contentBladeReference=i.contentBladeReference,i.flags|=64)),D.telemetryName=S;const E=this._options.referenceComposition&&this._options.referenceComposition.partDefinition;i&&(i.assetType&&i.detailBladeInputs?D.originAssetType=i.assetType:i.originAssetType&&i.detailBladeInputs&&i.detailBlade?(D.originAssetType=i.originAssetType,D.originAssetTypeExtension=i.originExtension):E&&(D.originAssetType=E&&E.assetType,D.originAssetTypeExtension=this._options.referenceExtension&&this._options.referenceExtension.name)),t.descriptor=D}}openBlade(e,t){const n=this._options,o=this._resources,s=t.invocationInput,d=o.container,c=t.value;(0,g.traceInvocationChange)(M,"Executing invocation property change",this._diContainer,n,s,c),d&&d.onInvocationStarted();const f=function(e,t,n,o,s,d,c){const g=c.invocationInput;let f=!0;const v=g.selectableSetV1&&s;if(!(void 0===s||v&&0===v.length))return function(e,t,n,o,s,d,c){const g=e.get(h.Finder),f=c.invocationInput,v=c.additionalInputs,B=c.detailsDefinition,x=Promise.withResolvers(),E=()=>{x.resolve([])},O=s;let w=!0;const A=n.getCloseOtherDetailBladesHandler(f,B)||((t,s)=>function(e,t,n,o,s,l,d){const c=e.get(u.JourneyManager),p=e.get(h.Finder),g=p.findSiblingBlades(t.referenceComposition,!!(32&l.flags),!!(512&l.flags)),f=e=>t.isBladeOpenedByMaster(e)&&e.masterInvocationProperty===o.source.property;let I,y,b=!0,v=!1,C=d&&d.getContent();C&&C.id&&g.some((e=>e.id===C.id))&&(C=null);I=g.filter((e=>{let t=!1;const n=e.bladeDefinition,o=!!(2&l?.flags),i=!!(2&e.flags);if(!(e.isDisposed()||256&e.flags||512&e.flags||o!==i))if(!f(e)||1&n?.attributes||64&l?.flags)t=!0;else{if(e.locator.equals(l.locator)){const n=function(e,t){let n=e;if(e&&t&&t.length){const o={};t.forEach((e=>{o[e.targetProperty]=!0})),n=MsPortalFx.forEachKey(e,((e,t,n)=>{o[e]||(n[e]=t)}),{})}return n}(l.model,s);t=!(0,m.deepSubset)(e.getBindableContainer().getViewModel(),n),y=e}else t=!0}return t}));let B=D(e,I);if(I.length===g.length&&y&&function(e,t,n){let o=[];const s=e.widget,a=n.shellAssignments.getBooleanValue("disablebladerebind");s&&(o=s.options.commandBar.menuItems(),e.children.forEach((e=>{e.children.forEach((e=>{const t=e.widget;t&&(o=o.concat(t.options.commands))}))})));const l=t.masterDetailsDefinition,d=l&&!!l.parameterCollector,c=!!(1&e.bladeDefinition?.attributes)||!!(64&t.flags)||(0,i.isFeatureEnabled)("disablebladerebind")||a;let p=!e.isDisabled&&e.bladeDefinition&&!e.bladeDefinition.waitForInputsSet&&!c&&!d&&o.every((e=>e.canRebind));p||c||d||M.warning(`Unable to rebind Blade '${e.id}', it was either disabled, cleared, or one of its commands was executing. Will close and reopen blade instead.`);if(p&&S.equals(t.locator)){const o=(0,i.getFeatureValue)(P)||n.shellAssignments.getStringValue(P);let s;try{s=o&&JSON.parse(o),o&&!Array.isArray(s)&&M.error(`The feature setting/experiment value '${P}' is incorrectly formatted.  Expected a JSON formatted array but received '${o}'`)}catch(e){M.error(`Failed to parse the feature setting/experiment value '${P}'`,0,e)}if(Array.isArray(s)){const n=r.ArmId.parse(t.model?.id,!0);n&&0!==n.kind&&(p=!s.includes(n.resourceType.toLowerCase()),p||(t.defaultMenuItemId=t.defaultMenuItemId||e.menu?.getSelectedItem()?.id))}}return p}(y,l,e.get(a.Experimentation))){MsPortalFx.remove(I,y),I=I.concat(p.findBlades(y));const e=c.discardEditsOfBlade(y,{includeSelf:!1,includeDescendants:!0,force:B});b=e.successful,v=b&&e.confirmationRequired}const _=!(21===l?.flags);if(b&&!v&&_){let e=!0;const t=I.length>0,n=t;C&&C.id&&!t&&(e=c.confirmBladesCanClose([C])),t&&(B=!1),b=B?e:c.confirmBladesCanClose(I,null,n)}if(b)for(let e=I.length-1;e>=0;e--){const o=I[e];f(o)&&(t.removeOutputBindings(o),n.bladesClosedByPart.set(o,!0)),c.forceCloseBlade(o,1,{openBlade:!0})}return b}(e,n,o,f,v,t,s)),T=e=>n.onBladesOpening(e),U=e.get(u.JourneyManager);let F;if(!Array.isArray(s)||O.length){const a=!!(2&t?.flags),r=e.get(p.RightContextPane);if(w=!!(256&t.flags)||A(t,r),w){"getCompositionType"in(r.getContent()||{})||1&t.flags||d.menu||r.close();const c=g.findBlades(o.container,!!(32&t?.flags),!!(512&t?.flags));let p;const u=c[0];if(256&~t.flags&&1===c.length&&u.widget&&64&~t.flags&&!a==!(2&u.flags)){p=!0;const e=f.selectableSetV1?s[0]:s,t=C(n.referenceComposition?n.referenceComposition.locator.toString():n.masterModelId,e,f);l.isDesktopTraceEnabled&&M.verbose(`[BladeOpener] Rebinding blade.\n  ${u.id}.\n  New Model: ${ko.toJSON(t)}`),F=u;const i=u.rebindAsync(t);o.selectable2?i.finally(E):E()}if(!p){let a;if(T([t]),"##NOT_SPECIFIED##"!==t.locator.name){e.get(y.ViewModelManager).tryEarlyGetViewModel(t.locator.getExtensionName(),t.locator.name,t.model,{isPrefetch:!0,menuId:t.defaultMenuItemId,inContextPane:!!(1&t.flags),isMenuBladeContent:(()=>{if(16&t.flags)return!0;const o=e.get(h.Finder).findPartsContainer(n.referenceComposition),i=o&&o.getCompositionType()===m.CompositionType.Blade&&o.bladeDefinition;return!(!i||!i.menuBlade&&!i.tabMenuBlade)})(),menuContentOverride:t.contentBladeReference,inSideBar:!!(256&t.flags),inDockedContextPane:!!(512&t.flags)}).catch((e=>{M.warning(`tryEarlyGetViewModel failed for the blade ${t.locator.toFriendlyString()}`,0,e)})),a=!0}b.tryImmediateResolve(a?(0,i.delay)(0):Promise.resolve(),(()=>{e.isDisposed()?x.reject(new MsPortalFx.Errors.DisposedCanceledError):U.openBlade(d,t).then((e=>{e&&e.onDispose((()=>{!function(e,t,n,o,i,s){const a=e.referenceComposition&&e.referenceComposition.id;if(a&&a!==n.masterPartId)return;const r=t.get(n);e.removeOutputBindings(n),r||function(e,t,n,o){const i=_(e.masterModel,t.source.property).value,s=ko.toJS(i);if(Array.isArray(s))i.splice(0,s.length);else{!!(n&&64&o.flags)&&ko.unwrap(i)!==o||I.setModelValue(e.masterModel,t.source.property,void 0)}}(e,o,i,s)}(n,o.bladesClosedByPart,e,f,!!o.selectable2,s)})),x.resolve([e])}))})),o.previousInvocationPromise=x.promise.finally((()=>{o.previousInvocationPromise=void 0}))}}else E()}return x.promise.then((e=>{const t=o.selectable2,i=c.invocationOutputs,s=(e=e||[]).filter((e=>t||!(2&e?.flags))),a=1===s.length?s[0]:void 0;if(e.filter((e=>!!e)).forEach(o.bladeOpenedCallbacks.fire),!t&&s.length>0&&Array.isArray(i)&&i.length>0)if(a)a.await(7).then((()=>{n.addOutputBindings(a,i)}));else{const t=e.map((e=>e.getDiagnosticsData())),o=`Unable to create output binding with detail blade, multiple detail blades found.\nMaster Model Debug Id: ${n.masterModelId}.\nOutput Arguments: ${ko.toJSON(i,null,2)}\nDetail Blades: ${ko.toJSON(t,null,2)}`;M.error(o)}})),{succeeded:w,bladeOpenPromise:x.promise,reboundBlade:F}}(e,t,n,o,s,d,c);{const t=n.getCloseOwnedDetailBladesHandler(g)||(()=>function(e,t,n,o){const i=e.get(u.JourneyManager);if(!i.activeJourney())return!0;const s=e.get(h.Finder),a=s.findBlades(t.referenceComposition).filter((e=>!e.isDisposed()&&e.masterInvocationProperty===o.source.property&&t.isBladeOpenedByMaster(e))),r=D(e,a),l=r||i.confirmBladesCanClose(a);if(l){const e=E(t,o)||{};for(let o=a.length-1;o>=0;o--){const s=a[o],r=e._msPortalFxDelayedBladeSelection;n.set(s,!0),t.removeOutputBindings(s),i.forceCloseBlade(s,1,{openBlade:r})}}return l}(e,n,o.bladesClosedByPart,g));f=t()}return{succeeded:f,bladeOpenPromise:void 0,reboundBlade:void 0}}(this._diContainer,t.descriptor,n,o,c,d,o.registrationInfo);f.succeeded?(o.resettingMasterArrayValue=!1,o.prevValue=c):o.resettingMasterArrayValue?(M.error("Resetting value of master '{0}' also caused a prompt".format(n.masterModelId),0,o.prevValue),o.resettingMasterArrayValue=!1):(o.resettingMasterArrayValue=s.selectableSetV1,function(e,t,n){const o=e.referenceExtension,i=()=>o.processMessages();i().then((()=>{const o=`Set invocation property '${t.source.property}' of master '${e.masterModelId}' to value.`;M.verbose("START: "+o,n);const s=t.source.property,a=E(e,t),r=a&&a.isSelected;if(a&&r&&void 0!==n){const t=function(e,t){let n=e;if(!e)return;n.lock&&n.setInternalSelectedValue&&n.isLocked||(M.error(`selectable is not a framework implementation, view model = '${t}'`),n={lock:B,setInternalSelectedValue:function(t){e.selectedValue(t)},isLocked:B});return n}(a,e.masterModelId);t.setInternalSelectedValue(n),r()||r(!0)}else I.setModelValue(e.masterModel,s,n);if(s.includes("activatedItems")){const t=s.replace("activatedItems","selectedItems"),o=_(e.masterModel,t),a=o.exists&&o.value;ko.isObservable(a)&&Array.isArray(a())&&i().then((()=>{a.splice.apply(a,[0,a().length].concat(n))}))}M.verbose("END: "+o,n)}))}(n,s,o.prevValue)),t.reboundBlade=f.reboundBlade;const v=f.bladeOpenPromise;return v?v.then((e=>{t.openedBlades=e})):null}};function D(e,t){const n=e.get(u.JourneyManager).activeJourney();return t.every((e=>{if(!e.isInitialized)return!0;const t=!!e.bladeDefinition.actionBar;if(e.shouldAlertOnClose({legacyMode:t})){if(!t)return!1;{const t=e.getViewModel(2),n=t&&t.content(),o=n&&n.output&&n.output();if(3!==(o&&o.status))return!1}}return n.ambientSettings.getItemsInPath(e.journeyPath).every((e=>!(!e||!e.value||1!==e.value.type)&&(!e.value.editScope||e.value.editScope.disposeOnSelectionChange)))}))}function E(e,t){const n=t.source.property.lastIndexOf("."),o=n>0?t.source.property.substring(0,n):"";return _(e.masterModel,o).value}__decorate([__metadata("fx:diagnostics",[e,"OpenBladeHandler.prototype"]),d.Step(4),__metadata("design:type",Function),__metadata("design:paramtypes",[d.Task,Object]),__metadata("design:returntype",void 0)],x.prototype,"createDescriptor",null),__decorate([__metadata("fx:diagnostics",[e,"OpenBladeHandler.prototype"]),d.Step(5),__metadata("design:type",Function),__metadata("design:paramtypes",[d.Task,Object]),__metadata("design:returntype",void 0)],x.prototype,"openBlade",null),t.OpenBladeHandler=x=__decorate([__metadata("fx:diagnostics",[e,"OpenBladeHandler"]),s.Class("pipeline"),__metadata("design:paramtypes",[s.Container,g.Configuration,g.Resources,f.BladeRedirector])],x)}));
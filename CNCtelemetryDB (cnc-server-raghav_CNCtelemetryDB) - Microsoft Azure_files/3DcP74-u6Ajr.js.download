define("MsPortalImpl/UI/UI.DeepLink",["require","exports","Fx/ResourceManagement","MsPortalImpl/Base/Base.ArmIdHelpers","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/UI/UI.AuthStateManager","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","FxInternal/Shared/lib/LinkUtils","Fx/Experimentation"],(function(e,t,n,a,i,r,o,s,l){"use strict";t.experimentDefaults=t.DeepLinkExperiments=void 0,t.getDeepLink=function(e,t,r,o,l={}){const p=g(t,r.name,o),d=l.assetId,f=l.assetType,h=typeof d,D=ko.unwrap(d),k=n.ArmId.parse(D,!0),x=l.selectedMenuItemId,v=l.setDeepLinkContext||$.noop;let y,M=!1;if(p)y=(0,i.getGalleryDeepLink)(p,{model:o});else if("string"!==h||!(0,a.isResourceAtAnyLevel)(k)&&4!==k.kind&&1!==k.kind)if(d&&"object"===h&&d.id&&1===MsPortalFx.keysLength(d)&&(0,a.isResourceAtAnyLevel)(n.ArmId.parse(d.id,!0)))y=m(e,d.id,{selectedMenuItemId:x});else if("string"!==h&&"number"!==h||!f)if((0,i.isServiceMenuBlade)(t,r.name)&&b(e,c.serviceMenuRoute)){y=(0,i.getServiceMenuDeepLink)({serviceMenuBladeInputs:{extension:o.extension,menuId:o.menuId},selectedItemId:x})}else{const e=u.v2DeepLink,n=r.pinnable||function(e,t){if(MsPortalFx.isNullOrUndefined(e)||MsPortalFx.isEmptyObject(e))return!0;return I(e,t)}(o,{maxDepth:u.maxDepth,v2DeepLink:e});r.outputs&&r.outputs.length>0?v("",!1,s.ReasonNotDeepLinkable.BladeHasOutputs):r.pinnable||!0===n?y=(0,i.getBladeDeepLink)(t,r.name,o,{selectedMenuItemId:x,setDeepLinkContext:v,v2DeepLink:e}):v("",!1,n.reason,n.details),M=!0}else y=(0,i.getAssetDeepLink)(e,{extensionName:t,assetType:f,assetId:D});else y=m(e,d,{selectedMenuItemId:x});return!M&&v(y,!0),y},t.getGalleryItemIdFromBladeComposition=g,t.getResourceDeepLink=m;var p=MsPortalFx.Base,d=p.Constants;const u=t.experimentDefaults={maxDepth:299,v2DeepLink:!0};var c;function m(e,t,n={}){let a=encodeURI(t);n.selectedMenuItemId&&(a+="/"+n.selectedMenuItemId);const i=e.get(r.AuthStateManager).getSignedInUserTenant(),o=new p.UriBuilder(n.baseUri);return o.fragment=`${i&&`@${i}/`}resource${a}`,o.toString()}function g(e,t,n){let a=null;const i="Microsoft_Azure_Marketplace"===e,r=t===d.BladeNames.Hubs.CreateHubBlade;if(n){if(i&&r)return"function"==typeof n.package?n.package():null;const e=(0,o.getModelValue)(n,"_provisioningContext.marketplaceItem.launchingContext.galleryItemId").value;if(e)return e;const t=n.internal_bladeCallerParams&&n.internal_bladeCallerParams();let s;if(t)s=(0,o.getModelValue)(t.providerConfig&&FxImpl.fromSerializableObject(t.providerConfig),"provisioningConfig.galleryCreateOptions.galleryItem").value;else{const e=n["collectorBindingInternals-inputs"];e&&(s=(((e._latestValue||{}).options||{}).galleryOptions||{}).galleryItem)}a=s&&s.id&&s.version&&s.id.replace("."+s.version,"")}return a}function f(e,t=new Set){if(t.has(e))return 1/0;switch(t.add(e),e?.constructor){case Object:case Array:return 1+Math.max(-1,...Object.values(e).map((e=>f(e,t))));default:return 0}}function I(e,t,n){if(MsPortalFx.isNullOrUndefined(n)&&(n=1),n>t.maxDepth){const n=f(e)+t.maxDepth;return n===1/0?{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_NestedTooDeepCyclic,details:"The input model contains a cyclic reference and cannot be serialized. A future upgrade will discard the input model entirely and the content won't be navigable reliably."}:{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_NestedTooDeep,details:`The input model is nested too deep. Current supported model depth is ${t.maxDepth}. Consider reducing the model used to navigate to the exact properties needed for restoring the same content with a deep link navigation. Total Object Depth is ${n}`}}let a;return MsPortalFx.forEachKey(e,((i,r)=>{r=1===n?ko.unwrap(e[i]):e[i];const o=MsPortalFx.getTypeOf(r);let l;l="object"===o||(n>1||t.v2DeepLink)&&"array"===o?I(r,t,n+1):function(e,t,n){switch(e){case"boolean":case"number":case"null":case"undefined":return!(!n&&!t.v2DeepLink)||{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_UnsupportedTypeCanBeSupported,details:e};case"string":return!0;case"array":return{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_UnsupportedArray};case"date":return{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_UnsupportedDate,details:"The input model contains a Date object which cannot be serialized in a roundtrippable way from Fx. A future upgrade will JSON stringify this input and the resulting deep link may not be navigable reliably. If using Date object to navigate to content, serialize the Date as part of the input model using the `toISOString()` method and parse this value on the initialization phase of the content."};default:return{reason:s.ReasonNotDeepLinkable.BladeNotPinnableCannotUpgrade_UnsupportedType,details:e}}}(o,t,n>1),!0!==l&&(a=l)})),a??!0}!function(e){e.serviceMenuRoute="serviceMenuRoute"}(c||(t.DeepLinkExperiments=c={}));const b=(e,t)=>e.get(l.Experimentation).shellAssignments.getBooleanValue(t)}));
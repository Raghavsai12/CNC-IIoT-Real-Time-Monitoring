define("MsPortalImpl/UI/UI.MfaNotificationHelper",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/Base.PortalFunctions","MsPortalImpl/UI/UI.BladeOpener","MsPortalImpl/UI/UI.DialogManager","MsPortalFx/Globalization","FxInternal/Experimentation","Fx/Composition/Selectable","luxon"],(function(e,t,a,n,i,o,l,r,s,c){"use strict";t.getEnforcementDateLongForm=g,t.handleMfaNotificationLogic=async function(e,t,a,l,c){const d=Date.now(),p=e.get(r.ExperimentationManager),T=await p.shellAssignments.whenAvailable(),A=MsPortalFx.isFeatureEnabled("ci"),N=new Date(l.mfaEnforcementDate||"2025-03-31T00:00:00Z").getTime(),{isTenantAdmin:v,isMfa:b,tenantId:P,emailAddress:h}=l,C=v||!b,I=d>N,B=MsPortalFx.isFeatureEnabled("testmfaenforcementmodal"),S=MsPortalFx.isFeatureEnabled("testmfaenforcementnotification"),L=!S&&!B;if(L&&(A||!C||I))return!1;const{mfaModalAcknowledged:_,mfaNotificationAcknowledged:E}=t,D=864e5*(T.getNumberValue("mfanotificationintervalindays")||15),$=x(d,E,N,D),R=864e5*(T.getNumberValue("mfamodalintervalindays")||8),U=x(d,_,N,R);if(L&&_()&&E())return!1;const V=T.getBooleanValue("mfamodal"),z=T.getBooleanValue("mfanotification"),O=u.environment.notifications?.mfaNotificationPortalName??"Azure portal",W=`${MsPortalFx.ensureSuffix(M,"/")}${P}?mfalogin=true&loginHint=${h}&manualmfalogin=true`,H=!v&&c;if(k("handleMfaNotificationLogicCalled",{ciEnabled:A,isMfa:b,isTenantAdmin:v,didResetModalAck:U,didResetNotificationAck:$,mfaModalTestEnabled:B,mfaModalEnabled:V,mfaNotificationEnabled:z,mfaNotificationPortalName:O,mfaNotificationTestEnabled:S,mfaModalAcknowledged:_(),mfaNotificationAcknowledged:E(),isAdminOrNonMfaUser:C,isNonAdminWithTryMfaBefore:H,hasTryMfaWorkedBefore:c}),z&&!E()||S)try{if(F(d,N,D)&&!H||S){k("Publishing_Notification",{isTenantAdmin:v});const t=g(N);return(await MsPortalFx.require("MsPortalImpl/Widgets/Widgets.MfaNotification")).showNotification(e,a,v,t,O,b,W,c,(()=>{S||E(!0)})),!0}}catch(e){k("MsPortalEarly_preload_Failed",MsPortalFx.getLogFriendlyMessage(e))}if(V&&!_()||B)try{if(F(d,N,R)&&!H||B){k("Publishing_Modal",{isTenantAdmin:v});const t=g(N);return await async function(e,t,a,l,r,c,d,u,M){const p=await e.getAsync(o.DialogManager),g=()=>{M||t(!0)},x=(e,t)=>{g(),k("TryMfaNowModalClicked",null),f.open(d,"_blank")},F=(e,t)=>{g(),k("MfaLearnMoreLinkModalClicked",null),f.open("https://aka.ms/mfaforazure","_blank")},T=(t,a)=>{g(),k("MfaCreateTicketLinkModalClicked",null),p.dismissOpenDialog(0),e.get(n.RoutePortalFunc).invoke({uri:"#view/Microsoft_Azure_Support/NewSupportRequestV4Blade/assetId//subscriptionId//productId/516fe906-3a1a-2878-02fd-8dd37ea207de/topicId//articleId/9004400-7931/callerWorkflowId/428d3819-fc5f-4769-906d-d5e7bafdbfdc/summary/Azure%2FMicrosoft%20Entra%20Sign-in%20and%20Multifactor%20Authentication%2FMulti-Factor%20Authentication%20(MFA)%2FPlan%20and%20manage%20your%20MFA%20deployment/callerName/Microsoft_Azure_Support%2FHelpCopilot.ReactView/redirectedCallerName//issueContext~/%7B%7D/issueType/technical/solutionSeen~/true",openedByContext:{openedBy:6}}).then((()=>{k("MfaOpenCreateTicketLinkModalSuccess",null)})).catch((()=>{k("MfaOpenCreateTicketLinkModalFailed",null)}))},A=await p.showModalDialog({title:m.title,description:`<div class="fxs-mfa">\n            <div class="fxs-portal-title">\n                ${w(a,c,r)}\n                ${l||u?"":y()}\n            </div>\n        </div>`,templateViewModel:{clickContactSupport:T,clickLearnMore:F,clickTryMfaNow:x},buttons:a?2:1,...a&&{defaultButtonText:m.postponeButtonText},cancelButtonText:m.closeButtonText});if(a&&4===A){g(),k("MfaSettingsModalButtonClicked",null);const t=new s.PdlBladeReference("MfaSettings.ReactView","Microsoft_Azure_Resources");e.get(i.BladeOpener).openBlade(t,{flags:8,telemetryName:"mfaModal"}).then((()=>{k("MfaSettingsModalButtonClickedSuccess",null)})).catch((()=>{k("MfaSettingsModalButtonClickedFailed",null)}))}(3===A||!a&&4===A)&&(g(),k("CloseButtonClicked",null));g()}(e,_,v,b,t,O,W,c,B),!0}}catch(e){k("MsPortalEarly_preload_Failed",MsPortalFx.getLogFriendlyMessage(e))}};var d=MsPortalFx.Base.Diagnostics.Telemetry;MsPortalFx.ViewModels;const f=window,u=f?.fx,m=a.MFA,M=f?.location?.origin,p=l.formatCulture.includes(".")?l.formatCulture.split(".")[1]:l.formatCulture;function g(e){const t=new Date;t.setTime(e);return c.DateTime.fromJSDate(t).setLocale(p).toLocaleString({day:"numeric",month:"long",year:"numeric"})}function k(e,t){d.trace({source:"UI.MfaNotificationHelper",action:e,data:t})}function x(e,t,a,n){const i=e<a-n;return!(!t()||!i)&&(t(!1),!0)}function F(e,t,a){let n=!1;return e<t&&e>=t-a&&(n=!0),n}function w(e,t,a){return`<div class="fxs-mfa-description-wrapper">\n        ${e?`<div class="fxs-mfa-description-text">${m.descriptionAdmin.format(t,a)}</div>`:`<div class="fxs-mfa-description-text">${m.descriptionNonAdmin.format(t,a)}</div>`}\n        <div class="fxs-mfa-description-link">\n            <a target=_blank class="fxs-mfa-learn-more-link msportalfx-ext-link" href="#" data-bind="click: clickLearnMore">\n                <span>${m.learnMoreLinkText}</span>\n            </a>\n        </div>\n    </div>`}function y(){return`<div class="fxs-mfa-description-wrapper">\n        <div class="fxs-mfa-description-text">${m.descriptionTryMfaText.format(`<div class="fxs-mfa-description-link">\n                    <a target=_blank class="fxs-try-mfa-link msportalfx-ext-link" href="#" data-bind="click: clickTryMfaNow">\n                        <span>${m.tryMfaLinkText}</span>\n                    </a>\n                </div>`,`<div class="fxs-mfa-description-link">\n                    <a target=_self class="fxs-mfa-create-ticket-link" href="#" data-bind="click: clickContactSupport">\n                        <span>${m.contactSupportLinkText}</span>\n                    </a>\n                </div>`)}\n        </div>\n    </div>`}}));